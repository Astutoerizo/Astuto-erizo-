<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <title>Astuto Erizo - Respira y Grita</title>
    <style>
        /* Estilos CSS (del archivo original) */
        html,body{margin:0;height:100%;background:#0e0e10;color:#fff;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased}
        #wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:transparent}
        canvas{background:#1b1b1f;touch-action:none;display:block}
        .hud{position:fixed;top:8px;left:50%;transform:translateX(-50%);width:min(92vw,720px);pointer-events:none;display:flex;align-items:center;gap:12px;justify-content:space-between;font-weight:600;z-index:1200}
        .bar{flex:1;height:14px;background:#3a3a44;border-radius:999px;overflow:hidden;border:2px solid #6ee7b7;box-shadow:0 0 6px rgba(110,231,183,0.6) inset}
        .fill{height:100%;width:0%;background:#86efac;transition:width .08s linear}
        .score{min-width:100px;text-align:right}
        .ui-panel{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;z-index:9000;color:#fff;text-align:center;flex-direction:column;align-items:center;justify-content:center}
        .ui-panel.show{display:flex}
        .panel-content{padding:20px;max-width:300px}
        .panel-content h1{margin-top:0}
        .panel-content button{padding:10px 20px;font-size:1.2em;cursor:pointer;background:#6ee7b7;color:#111;border:none;border-radius:8px;margin-top:15px}
        #loader{position:fixed;inset:0;background:#0e0e10;z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column}
        #loaderImg{width:50px;height:50px;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        #countdown{position:fixed;inset:0;z-index:9500;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center}
        #countNum{font-size:6em;color:#fff;text-shadow:0 0 15px #6ee7b7;animation:count 1s cubic-bezier(0.5, 0, 0.5, 1) infinite}
        @keyframes count{0%{opacity:0;transform:scale(0.5)}50%{opacity:1;transform:scale(1.2)}100%{opacity:0;transform:scale(1.5)}}
        #hint{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:8px 15px;border-radius:12px;font-size:0.9em;z-index:1500;display:none;pointer-events:none}
        #flash{position:fixed;inset:0;background:white;z-index:9999;opacity:0;pointer-events:none}
        .music-btn{position:fixed;top:10px;right:10px;width:30px;height:30px;background:rgba(110,231,183,0.3);border-radius:50%;border:2px solid #6ee7b7;cursor:pointer;z-index:9999;display:flex;align-items:center;justify-content:center;font-size:1.2em}
        /* NEW: Styles for screen shake */
        #wrap.shake {
            animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body>
    <div id="wrap">
        <canvas id="game" width="540" height="960"></canvas>
        <div class="hud">
            <div id="score">Puntos: 0</div>
            <div class="bar"><div id="zenFill" class="fill"></div></div>
            <div id="bestScore">Mejor: 0</div>
        </div>
        <div id="hint">Pulsa/Toca para inhalar</div>

        <div id="menuPanel" class="ui-panel show">
            <div class="panel-content">
                <h1>Astuto Erizo</h1>
                <p id="menuBest">Mejor puntuaci√≥n: 0</p>
                <button id="btnStart">Jugar</button>
            </div>
        </div>

        <div id="panel" class="ui-panel">
            <div class="panel-content">
                <p id="panelMsg">Mensaje de prueba</p>
                <button id="btnRestart">Reintentar</button>
            </div>
        </div>

        <div id="loader">
            <div id="loaderImg">üåÄ</div>
            <p>Cargando Zen‚Ä¶</p>
        </div>

        <div id="countdown" class="ui-panel" style="display:none;">
            <span id="countNum">3</span>
        </div>

        <div id="flash"></div>
        
        <div id="btnMusic" class="music-btn">üéµ</div>

    </div>

  <script>
    (async () => { 'use strict';
        // ================= TEST MODE ================= 
        const TEST_MODE = true; 
        // ============================================== 
        // ===== CONFIG ===== 
        const WORLD = { w: 540, h: 960 };
        const BASE_SPEED_SCROLL = 280; 
        const BASE_SPAWN_INTERVAL = 1.2; 
        const SPEED = { scroll: BASE_SPEED_SCROLL, inc: 20, max: 520, accel: 0 }; 
        const SPAWN = { interval: BASE_SPAWN_INTERVAL, min: 0.7, timer: 0, diffTimer: 0 }; 
        const CHARGE = { value: 0, rate: 60, max: 100, over: 85, cooldown: 0, cooldownBase: 1.0 };
        const PULSE = { base: 120, max: 380, life: 0.25 };
        const POINTS = { total: 0, best: parseInt(localStorage.getItem('bestScore')||'0', 10) || 0 };
        const PHYSICS = { gravity: 600, inhaleForce: -1400, maxVy: 900 }; 
        const GROUND_H = 180;
        const BOSS_DURATION = 10; 
        
        // Umbrales Progresivos Ajustados
        const BOSS_SCORE_1 = TEST_MODE ? 5 : 50; 
        const BONUS_SCORE_1 = TEST_MODE ? 10 : 75; 
        const BOSS_SCORE_2 = 150; 
        const BONUS_SCORE_2 = 200; 
        const BOSS_SCORE_3 = 300; 
        const BONUS_SCORE_3 = 400; 

        // ===== DOM ===== 
        const canvas = document.getElementById('game'); 
        const ctx = canvas.getContext('2d');
        const wrap = document.getElementById('wrap'); 
        const zenFill = document.getElementById('zenFill'); 
        const scoreEl = document.getElementById('score'); 
        const bestScoreEl = document.getElementById('bestScore'); 
        const menuBestEl = document.getElementById('menuBest'); 
        const panel = document.getElementById('panel');
        const panelMsg = document.getElementById('panelMsg'); 
        const btnRestart = document.getElementById('btnRestart'); 
        const hint = document.getElementById('hint'); 
        const menuPanel = document.getElementById('menuPanel'); 
        const btnStart = document.getElementById('btnStart');
        const countdownEl = document.getElementById('countdown'); 
        const countNum = document.getElementById('countNum'); 
        const loader = document.getElementById('loader'); 
        const flash = document.getElementById('flash'); 
        const btnMusic = document.getElementById('btnMusic');
        
        // ===== AUDIO MODIFICADO: A√±ade m√∫sica de men√∫ ===== 
        const MUSIC = { menu: 'assets/musica_pantalla_principal.mp3', base: 'assets/musica_base.mp3', boss: 'assets/musica_boss.mp3', bonus: 'assets/musica_bonus.mp3' }; 
        const SFX = { bowl: 'assets/sonido_bowl_limpio.mp3', banana: 'assets/sonido_recolectar_platano.mp3', inhale: 'assets/sonido_inhalar.mp3', chocar: 'assets/sonido_chocar.mp3', woosh: 'assets/woosh.mp3', gong: 'assets/gong.mp3', levelComplete: 'assets/level_complete.mp3' }; 
        
        let musicEnabled = true; 
        let currentMusic = null; 
        const sfxVolume = 0.6; 
        
        function playMusic(src, loop=true){ 
            if(!musicEnabled) return; 
            stopMusic(); 
            currentMusic = new Audio(src); 
            currentMusic.loop = loop; 
            currentMusic.volume = 0.4; 
            currentMusic.play().catch(()=>{}); 
        } 
        function stopMusic(){ 
            if(currentMusic){ currentMusic.pause(); currentMusic.currentTime = 0; currentMusic = null; } 
        } 
        function playSfx(name, vol=1){ 
            if(!musicEnabled) return; 
            const src = SFX[name]; 
            if(src){ 
                const audio = new Audio(src); 
                audio.volume = vol * sfxVolume; 
                audio.play().catch(()=>{}); 
            } 
        } 
        function stopAllSfx(){}
        
        btnMusic.addEventListener('click', ()=>{ 
            musicEnabled = !musicEnabled; 
            btnMusic.textContent = musicEnabled ? 'üéµ' : 'üîá'; 
            if(musicEnabled){ 
                if(currentMusic) currentMusic.play().catch(()=>{}); 
                else if(!gameOver && started && !currentMusic) playMusic(MUSIC.base);
            } else { 
                stopMusic(); 
            } 
        }); 

        // ===== ENTITIES ===== 
        const player = { x: 100, y: WORLD.h - GROUND_H - 50, r: 40, vx: 0, vy: 0, state: 'calmado', mareo: 0 }; 
        let isDown = false, justReleased = false; 
        const sueloScroll = { y: WORLD.h - GROUND_H, x: 0 };
        const obstacles = [];
        const bananas = [];
        const pulses = []; 
        const particles = [];
        const clouds = []; 

        // ===== IMAGES MODIFICADO: A√±adiendo Logo y Contadores ===== 
        const IMG = { 
            erizo: {}, fondos: {}, nubes: [], obstaculos: {}, 
            banana: null, cuenco: null, logo: null,
            boss: {}, boss2: {}, boss3: {}, bonus: {},
            contadores: { random: [], go: null } // Im√°genes para el countdown
        }; 
        
        function loadImage(src){ 
            return new Promise((resolve, reject)=>{ 
                const img = new Image(); 
                img.onload = ()=>resolve(img); 
                img.onerror = ()=> { 
                    console.warn("Error al cargar imagen: "+src); 
                    resolve(null);
                };
                img.src = src; 
            }); 
        } 
        
        async function loadAll(){ 
            // Cargar erizo 
            IMG.erizo.calmado = await loadImage('assets/erizo_calmado.png'); 
            IMG.erizo.inhalando = await loadImage('assets/erizo_inhalando.png'); 
            IMG.erizo.gritando = await loadImage('assets/erizo_gritando.png'); 
            IMG.erizo.parpadeo = await loadImage('assets/erizo_parpadeo.png'); 
            IMG.erizo.meditando = await loadImage('assets/erizo_meditando.png'); 
            
            // Fondos 
            IMG.fondos.calc = await loadImage('assets/fondo_calc.png'); 
            IMG.fondos.desierto = await loadImage('assets/fondo_desierto.png'); 
            IMG.fondos.helado = await loadImage('assets/fondo_helado.png'); 
            IMG.fondos.bonus = await loadImage('assets/bonus/fondo_bonus.png'); 
            
            // Obst√°culos y Coleccionables 
            IMG.obstaculos.paraguas = await loadImage('assets/paraguas.png'); 
            IMG.obstaculos.helado = await loadImage('assets/helado_meditando.png'); 
            IMG.banana = await loadImage('assets/platano_puntos.png'); 
            IMG.cuenco = await loadImage('assets/cuenco_tibetano.png'); 
            
            // Logo
            IMG.logo = await loadImage('assets/logo_videojuego.png'); 

            // Nubes 
            for(let i=1;i<=4;i++) IMG.nubes.push(await loadImage('assets/nubes/nube'+i+'.png')); 
            
            // Boss 1 
            IMG.boss.cartel = await loadImage('assets/boss/cuidado_espuma.png'); 
            IMG.boss.img = await loadImage('assets/boss/pasta_feroz.png'); 
            IMG.boss.proj = await loadImage('assets/boss/espuma_boss.png'); 
            IMG.boss.num = []; for(let i=1;i<=10;i++) IMG.boss.num.push(await loadImage(`assets/boss/${i}.png`)); 
            
            // Bonus
            IMG.bonus.cartel = await loadImage('assets/bonus/coge_todo.png');
            IMG.bonus.patito1 = await loadImage('assets/patito1.png');
            IMG.bonus.patito2 = await loadImage('assets/patito2.png');
            
            // Contadores de Inicio (3, 2, 1)
            const contadorNames = ['contador_antena.png', 'contador_arbol.png', 'contador_calcetin.png', 'contador_coche.png', 'contador_helado.png', 'contador_leche.png', 'contador_lapiz.png', 'contador_paraguas.png', 'contador_seta.png', 'contador_cuenco.png'];
            for(const name of contadorNames) {
                 IMG.contadores.random.push(await loadImage(`assets/${name}`));
            }
            IMG.contadores.go = await loadImage('assets/contador_go.png'); // Contador GO!
            
            // Carga opcional de Boss 2/3 
            IMG.boss2.cartel = await loadImage('assets/boss2/cartel_boss2.png');
            IMG.boss3.cartel = await loadImage('assets/boss3/cartel_boss3.png');
        } 
        
        // ===== GAME STATE (Resto del estado permanece igual) ===== 
        let bgStage = 0, currentBg = null;
        let gameOver = false, loopId = null, started = false;
        let inBossPhase = false, inBonusPhase = false, bossActive = false, bonusActive = false; 
        let bossCountdown = 0, bossStageIndex = 1;
        const bossesDone = new Set(), bonusDone = new Set(); 
        let gameComplete = false; 
        let lastFrame = performance.now();
        let shakeDuration = 0;

        function updateBestDisplays(){ 
            bestScoreEl.textContent = "Mejor: "+POINTS.best; 
            menuBestEl.textContent = "Mejor puntuaci√≥n: "+POINTS.best; 
        } 
        updateBestDisplays(); 

        function resetVolatileState(){
            POINTS.total = 0;
            CHARGE.value = 0; CHARGE.cooldown = 0;
            
            SPEED.scroll = BASE_SPEED_SCROLL; 
            SPAWN.interval = BASE_SPAWN_INTERVAL; 
            SPAWN.timer = 0; SPAWN.diffTimer = 0;

            obstacles.length = bananas.length = pulses.length = particles.length = 0;
            player.y = WORLD.h - GROUND_H - player.r + 20;
            player.vy = 0; player.state='calmado'; player.mareo = 0;
            panel.classList.remove('show'); hint.style.display = '';
            
            gameOver = false;
            inBossPhase = false; inBonusPhase = false; bossActive=false; bonusActive=false;
            bossCountdown = 0; bossTimer = 0; bonusTimer = 0;
            stopAllSfx();
            stopMusic();
            if(musicEnabled) playMusic(MUSIC.base); // M√∫sica de juego base
            btnRestart.textContent = 'Reintentar';
            if (gameComplete) panelMsg.innerHTML = "Has muerto... ¬°Pero ya hab√≠as alcanzado el Zen! Vuelve a empezar."; 
            gameComplete = false;
        }

        function resetAll(){ 
            resetVolatileState();
            bossesDone.clear();
            bonusDone.clear();
            bgStage = 0; 
            currentBg = IMG.fondos.calc || null;
            initClouds();
            bossStageIndex = 1;
        }

        btnRestart.addEventListener('click', ()=>{
            if(POINTS.total > POINTS.best){ 
                POINTS.best = POINTS.total;
                localStorage.setItem('bestScore', POINTS.best);
                updateBestDisplays();
            }

            const lastBossStage = bossStageIndex; 
            const wasInBoss = inBossPhase;
            const wasGameComplete = gameComplete;

            resetVolatileState(); 
            
            if(wasGameComplete){ 
                 resetAll(); 
                 menuPanel.classList.add('show');
                 panel.classList.remove('show');
                 if(musicEnabled) playMusic(MUSIC.menu); // Iniciar m√∫sica de men√∫
                 return;
            }

            if(wasInBoss) { 
                startBossPhase(lastBossStage, true);
            } else {
                lastFrame = performance.now();
                requestAnimationFrame(frame);
            }
        });

        // ===== UTILIDADES Y SPAWNERS (Implementados anteriormente) ===== 
        function dist2(x1, y1, x2, y2) { /* ... */ const dx = x1 - x2; const dy = y1 - y2; return dx * dx + dy * dy; }
        function initClouds(){ /* ... */ clouds.length = 0; for(let i=0; i<6; i++){ clouds.push({ x: Math.random() * WORLD.w, y: Math.random() * (WORLD.h - GROUND_H - 100), imgRef: IMG.nubes[Math.floor(Math.random() * IMG.nubes.length)], scale: 0.5 + Math.random() * 0.5, vx: -(20 + Math.random() * 40) }); } }
        function spawnObstacle(kind = 'paraguas', radius = 30) { /* ... */ if(kind === 'espuma') radius = 20 + Math.random() * 10; else if (kind === 'helado') radius = 35; const y_offset = (kind === 'espuma') ? Math.random() * (WORLD.h - GROUND_H - 2 * radius) : 0; obstacles.push({ x: WORLD.w + radius, y: WORLD.h - GROUND_H - radius + y_offset, r: radius, vy: 0, kind: kind, imgRef: IMG.obstaculos[kind] || IMG.boss.proj }); }
        function spawnCollectable(kind = 'banana', radius = 20) { /* ... */ const height = WORLD.h - GROUND_H - radius * 2 - Math.random() * 400; const speed_mult = (kind === 'cuenco') ? 1.5 : 1; bananas.push({ x: WORLD.w + radius, y: Math.max(height, 100), r: radius, kind: kind, speedMult: speed_mult }); }
        function spawnBonusObject() { /* ... */ spawnCollectable('patito', 25); }
        let bossTimer = 0; let bonusTimer = 0; let bossSpawnTimer = 0;
        function startBossPhase(stage=1, restart=false){ /* ... */ if(stage > 3) stage = 3; inBossPhase = true; inBonusPhase = false; bossActive = false; bossTimer = 0; bossCountdown = BOSS_DURATION; bossStageIndex = stage; SPEED.scroll = BASE_SPEED_SCROLL; SPAWN.interval = BASE_SPAWN_INTERVAL; obstacles.length = 0; bananas.length = 0; pulses.length = 0; if(!restart) fleetingFlash(); if(stage === 1) currentBg = IMG.fondos.desierto || currentBg; else if(stage === 2) currentBg = IMG.fondos.helado || currentBg; else currentBg = IMG.fondos.calc || currentBg; if(musicEnabled) playMusic(MUSIC.boss); setTimeout(()=>{ bossActive=true; bossSpawnTimer=0; }, 2000); } 
        function startBonusPhase(){ /* ... */ inBonusPhase = true; inBossPhase = false; bonusActive = false; bonusTimer = 0; SPEED.scroll = BASE_SPEED_SCROLL; SPAWN.interval = BASE_SPAWN_INTERVAL; obstacles.length = 0; bananas.length = 0; pulses.length = 0; fleetingFlash(); currentBg = IMG.fondos.bonus || currentBg; if(musicEnabled) playMusic(MUSIC.bonus); setTimeout(()=>{ bonusActive=true; }, 2000); } 
        function doShake(duration = 0.25){ /* ... */ if(shakeDuration > 0) return; shakeDuration = duration; wrap.classList.add('shake'); }
        function fleetingFlash(){ /* ... */ flash.style.opacity = 1; setTimeout(()=> { flash.style.transition = 'opacity 0.2s'; flash.style.opacity = 0; }, 50); setTimeout(()=> { flash.style.transition = ''; }, 250); }
        // (El resto de las funciones update/draw/frame est√°n totalmente implementadas abajo)

        // ===== UPDATE IMPLEMENTADA (L√≥gica del juego) ===== 
        function update(dt){ /* ... */ } // (Contenido omitido aqu√≠ por espacio, pero incluido en el bloque final)
        
        // ===== DRAW IMPLEMENTADA (Renderizado) ===== 
        function draw(){ /* ... */ } // (Contenido omitido aqu√≠ por espacio, pero incluido en el bloque final)
        
        // ===== FRAME LOOP Y COUNTDOWN MODIFICADO: Contador con im√°genes aleatorias =====
        function showMainCountdown(callback) {
            countdownEl.style.display = 'flex';
            
            // Elegir 3 im√°genes aleatorias para 3, 2, 1
            const randomImages = [...IMG.contadores.random].sort(() => 0.5 - Math.random()).slice(0, 3);
            randomImages.push(IMG.contadores.go); // A√±adir siempre GO! al final

            let count = 0;
            const interval = setInterval(() => {
                const imgRef = randomImages[count];
                
                if (imgRef) {
                    // Limpiar el contador visual anterior
                    ctx.clearRect(WORLD.w/2 - 100, WORLD.h/2 - 100, 200, 200); 
                    
                    // Dibujar la nueva imagen
                    const size = 150;
                    ctx.drawImage(imgRef, WORLD.w/2 - size/2, WORLD.h/2 - size/2, size, size);
                    countNum.textContent = ''; // Limpiar el texto si usamos im√°genes

                } else {
                    // Fin del contador
                    clearInterval(interval);
                    countdownEl.style.display = 'none';
                    started = true;
                    ctx.clearRect(WORLD.w/2 - 100, WORLD.h/2 - 100, 200, 200); // Limpiar la √∫ltima imagen
                    callback();
                }
                count++;
            }, 1000);
        }

        function frame(now) {
            if (gameOver || gameComplete) return;
            const dt = Math.min((now - lastFrame) / 1000, 1/30); 
            lastFrame = now;

            update(dt);
            draw();

            if (!gameOver) {
                loopId = requestAnimationFrame(frame);
            }
        }

        // ===== INIT / START MODIFICADO: Inicia m√∫sica de men√∫ ===== 
        loadAll().then(()=>{ 
            currentBg = IMG.fondos.calc || null; 
            initClouds(); 
            updateBestDisplays(); 
            
            setTimeout(()=>{ loader.style.display = 'none'; }, 400); 
            
            // NEW: Dibujar logo e instrucciones en el men√∫
            const menuContent = document.querySelector('#menuPanel .panel-content');
            // A√±adir logo y t√≠tulo si el DOM lo permite o actualizarlo
            if(IMG.logo && !menuContent.querySelector('.game-logo')) {
                 const logoImg = document.createElement('img');
                 logoImg.src = IMG.logo.src;
                 logoImg.style.maxWidth = '100%';
                 logoImg.style.marginBottom = '15px';
                 logoImg.className = 'game-logo';
                 menuContent.prepend(logoImg);
                 
                 const title = menuContent.querySelector('h1');
                 if (title) title.innerHTML = 'ASTUTO ERIZO ‚Äî Respira y Grita';
                 
                 const instruction = document.createElement('p');
                 instruction.innerHTML = 'Mant√©n pulsado para inhalar ¬∑ Suelta para gritar';
                 instruction.style.fontSize = '1.1em';
                 instruction.style.fontWeight = '500';
                 menuContent.insertBefore(instruction, menuContent.querySelector('#menuBest'));
            }

            // NEW: Iniciar m√∫sica de men√∫ al cargar
            if(musicEnabled) playMusic(MUSIC.menu);

            btnStart.addEventListener('click', ()=>{ 
                menuPanel.classList.remove('show'); 
                stopMusic(); // Detener m√∫sica de men√∫
                showMainCountdown(()=>{ 
                    resetAll(); 
                    lastFrame = performance.now(); 
                    if(musicEnabled) playMusic(MUSIC.base); 
                    requestAnimationFrame(frame); 
                }); 
            }); 
            
            // Test mode keys
            if (TEST_MODE) {
                document.addEventListener('keydown', (e)=>{
                    if(!started || gameOver) return;
                    if(e.key.toLowerCase() === 'j') startBossPhase(1);
                    if(e.key.toLowerCase() === 'k') startBossPhase(2);
                    if(e.key.toLowerCase() === 'l') startBossPhase(3);
                    if(e.key.toLowerCase() === 'b') startBonusPhase();
                });
            }
        }); 
        
        // Control de inhalaci√≥n/grito (touch/pointer events)
        canvas.addEventListener('pointerdown', ()=>{ isDown = true; }); 
        canvas.addEventListener('pointerup', ()=>{ isDown = false; justReleased = true; }); 

        // Resto del c√≥digo de update y draw se inserta aqu√≠ (no se muestra por concisi√≥n, pero est√° en el bloque final)
        
        // =========================================================================================================
        // === CONTENIDO DE UPDATE Y DRAW PARA REFERENCIA: EST√Å EN EL BLOQUE FINAL ===
        // =========================================================================================================

        function update(dt){ 
            if(!started || gameOver) return; 
            if(shakeDuration > 0) { shakeDuration -= dt; if(shakeDuration <= 0) { wrap.classList.remove('shake'); } }
            player.vy += PHYSICS.gravity * dt;
            if(isDown && CHARGE.cooldown <= 0){
                player.state = 'inhalando'; player.vy = PHYSICS.inhaleForce * dt;
                CHARGE.value = Math.min(CHARGE.max, CHARGE.value + CHARGE.rate * dt); hint.style.display = 'none';
            } else if (justReleased) {
                player.state = 'gritando'; playSfx('woosh'); CHARGE.cooldown = CHARGE.cooldownBase; justReleased = false;
                const pulse_r = PULSE.base + (PULSE.max - PULSE.base) * (CHARGE.value / CHARGE.max);
                pulses.push({ x: player.x, y: player.y, r: 0, maxR: pulse_r, life: PULSE.life }); CHARGE.value = 0;
            } else { player.state = 'calmado'; }
            CHARGE.cooldown = Math.max(0, CHARGE.cooldown - dt);
            player.y += player.vy * dt;
            player.y = Math.max(player.r, Math.min(WORLD.h - GROUND_H - player.r, player.y));
            player.vy = Math.min(PHYSICS.maxVy, player.vy);

            if(!inBossPhase && !inBonusPhase){
                SPAWN.diffTimer += dt;
                SPEED.scroll = Math.min(SPEED.max, BASE_SPEED_SCROLL + SPAWN.diffTimer * SPEED.inc);
                SPAWN.interval = Math.max(SPAWN.min, BASE_SPAWN_INTERVAL - SPAWN.diffTimer * 0.02);
            }
            const scroll_dx = SPEED.scroll * dt;
            for(let i=clouds.length-1; i>=0; i--){ clouds[i].x += clouds[i].vx * dt; if(clouds[i].x + 100 < 0) clouds.splice(i, 1); }
            for(let i=obstacles.length-1; i>=0; i--){ obstacles[i].x -= scroll_dx; if(obstacles[i].x + obstacles[i].r < 0) obstacles.splice(i, 1); }
            for(let i=bananas.length-1; i>=0; i--){ bananas[i].x -= scroll_dx * (bananas[i].speedMult || 1); if(bananas[i].x + bananas[i].r < 0) bananas.splice(i, 1); }
            for(let i=pulses.length-1; i>=0; i--){ pulses[i].r += (pulses[i].maxR / pulses[i].life) * dt; pulses[i].life -= dt; if(pulses[i].life <= 0) pulses.splice(i, 1); }

            if(!inBossPhase && !inBonusPhase){
                SPAWN.timer += dt;
                if(SPAWN.timer >= SPAWN.interval){
                    SPAWN.timer = 0;
                    if(Math.random() < 0.6) spawnObstacle(Math.random() < 0.5 ? 'paraguas' : 'helado');
                    if(Math.random() < 0.4) spawnCollectable(Math.random() < 0.1 ? 'cuenco' : 'banana');
                }
            }

            if(!inBossPhase && !inBonusPhase){ 
                if(POINTS.total >= BOSS_SCORE_1 && !bossesDone.has(1)){ bossesDone.add(1); startBossPhase(1); } 
                else if(POINTS.total >= BONUS_SCORE_1 && !bonusDone.has(1)){ bonusDone.add(1); startBonusPhase(); } 
                else if(POINTS.total >= BOSS_SCORE_2 && !bossesDone.has(2)){ bossesDone.add(2); startBossPhase(2); } 
                else if(POINTS.total >= BONUS_SCORE_2 && !bonusDone.has(2)){ bonusDone.add(2); startBonusPhase(); } 
                else if(POINTS.total >= BOSS_SCORE_3 && !bossesDone.has(3)){ bossesDone.add(3); startBossPhase(3); } 
                else if(POINTS.total >= BONUS_SCORE_3 && !bonusDone.has(3)){ bonusDone.add(3); startBonusPhase(); }
            } 
            
            for(let p=pulses.length-1; p>=0; p--){
                const pulse = pulses[p];
                for(let i=obstacles.length-1; i>=0; i--){
                    const o = obstacles[i];
                    if(dist2(o.x, o.y, pulse.x, pulse.y) <= (o.r + pulse.r)*(o.r + pulse.r)){ obstacles.splice(i, 1); POINTS.total += 1; playSfx('gong', 0.5); }
                }
            }

            for(let i=obstacles.length-1;i>=0;i--){ 
                const o = obstacles[i];
                if(dist2(o.x,o.y,player.x,player.y) <= (o.r + player.r)*(o.r + player.r)){ 
                    playSfx('chocar', 0.5); doShake(); 
                    if(POINTS.total > POINTS.best){ POINTS.best = POINTS.total; localStorage.setItem('bestScore', POINTS.best); updateBestDisplays(); }
                    panelMsg.textContent = ["El erizo se qued√≥ sin aire‚Ä¶","Has gritado al vac√≠o. El vac√≠o grit√≥ de vuelta.","La serenidad se tropez√≥ contigo."][Math.floor(Math.random()*3)];
                    panel.classList.add('show'); gameOver = true; stopAllSfx(); cancelAnimationFrame(loopId); return;
                } 
            } 
            
            for(let i=bananas.length-1;i>=0;i--){ 
                const b = bananas[i];
                if(dist2(b.x,b.y,player.x,player.y) <= (b.r + player.r)*(b.r + player.r)){ 
                    if(b.kind === 'cuenco') { POINTS.total += 5; playSfx('bowl', 0.5); } else { POINTS.total += 1; playSfx('banana', 0.5); }
                    bananas.splice(i, 1);
                } 
            } 

            if(inBossPhase && bossActive){
                bossTimer += dt; bossSpawnTimer += dt;
                if(bossSpawnTimer > 0.3){ spawnObstacle('espuma'); bossSpawnTimer = 0; }
                if(bossTimer >= BOSS_DURATION){
                    bossActive = false; inBossPhase = false; fleetingFlash(); playSfx('level_complete', 0.7);
                    setTimeout(()=>{ currentBg = IMG.fondos.calc || currentBg; if(musicEnabled) playMusic(MUSIC.base); }, 350);
                }
            }

            if(inBonusPhase && bonusActive){ 
                bonusTimer += dt; 
                if(Math.random() < 0.08) spawnBonusObject(); 
                if(bonusTimer >= BOSS_DURATION){ 
                    bonusActive = false; inBonusPhase = false; fleetingFlash(); playSfx('level_complete', 0.7);
                    if(bonusDone.has(3)){ 
                        gameComplete = true; stopMusic(); 
                        panelMsg.innerHTML = `¬°Has alcanzado el vac√≠o Zen!üßò‚Äç‚ôÄÔ∏è<br>Mejor puntuaci√≥n: **${POINTS.best}**`;
                        btnRestart.textContent = 'Volver al inicio'; panel.classList.add('show');
                        player.state = 'meditando'; cancelAnimationFrame(loopId); return;
                    }
                    setTimeout(()=>{ currentBg = IMG.fondos.calc || currentBg; if(musicEnabled) playMusic(MUSIC.base); }, 350);
                } 
            } 
            zenFill.style.width = CHARGE.value + '%';
            scoreEl.textContent = "Puntos: " + POINTS.total;
        } 

        function draw(){ 
            ctx.clearRect(0,0,WORLD.w,WORLD.h); 
            if(currentBg) ctx.drawImage(currentBg, 0, 0, WORLD.w, WORLD.h);
            else { ctx.fillStyle = '#1b1b1f'; ctx.fillRect(0,0,WORLD.w,WORLD.h); } 
            if(gameOver || gameComplete){ 
                ctx.fillStyle = 'rgba(0,0,0,0.15)'; ctx.fillRect(0,0,WORLD.w,WORLD.h);
                if (gameOver && !gameComplete) return; 
            } 
            for(const c of clouds){
                if(c.imgRef){ const w = c.imgRef.width * c.scale; const h = c.imgRef.height * c.scale; ctx.drawImage(c.imgRef, c.x - w/2, c.y - h/2, w, h); }
            }
            for(const b of bananas){ 
                ctx.strokeStyle = '#6ee7b7'; ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(b.x, b.y, b.r + 4, 0, Math.PI * 2); ctx.stroke();
                if(b.kind === 'cuenco' && IMG.cuenco) ctx.drawImage(IMG.cuenco, b.x - b.r, b.y - b.r, b.r*2, b.r*2);
                else if(b.kind === 'patito' && IMG.bonus.patito1) ctx.drawImage(IMG.bonus.patito1, b.x - b.r, b.y - b.r, b.r*2, b.r*2);
                else if(IMG.banana) ctx.drawImage(IMG.banana, b.x - b.r, b.y - b.r, b.r*2, b.r*2); 
            } 
            for(const o of obstacles){ 
                ctx.fillStyle = 'rgba(239, 68, 68, 0.4)'; ctx.beginPath(); ctx.arc(o.x, o.y, o.r + 6, 0, Math.PI * 2); ctx.fill();
                if(o.kind === 'espuma' && IMG.boss.proj) ctx.drawImage(IMG.boss.proj, o.x - o.r, o.y - o.r, o.r*2, o.r*2);
                else { const img = IMG.obstaculos[o.kind] || null; if(img) ctx.drawImage(img, o.x - o.r, o.y - o.r, o.r*2, o.r*2); } 
            } 
            for(const p of pulses){
                ctx.strokeStyle = `rgba(134, 239, 172, ${p.life / PULSE.life})`; ctx.lineWidth = 5; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2); ctx.stroke();
            }
            ctx.fillStyle = '#3a3a44'; ctx.fillRect(0, WORLD.h - GROUND_H, WORLD.w, GROUND_H);
            let erizoImg = IMG.erizo.calmado; 
            if(player.state === 'inhalando') erizoImg = IMG.erizo.inhalando;
            else if(player.state === 'gritando') erizoImg = IMG.erizo.gritando; 
            else if(player.state === 'meditando' && IMG.erizo.meditando) erizoImg = IMG.erizo.meditando; 
            else if(Math.random() < 0.002 && IMG.erizo.parpadeo) erizoImg = IMG.erizo.parpadeo;
            if(erizoImg) ctx.drawImage(erizoImg, player.x - player.r, player.y - player.r, player.r*2, player.r*2); 
            if(!bossActive && inBossPhase && bossStageIndex === 1 && IMG.boss.cartel){ ctx.drawImage(IMG.boss.cartel, WORLD.w/2 - 150, WORLD.h/2 - 50, 300, 100); }
            if(inBossPhase && bossActive){
                const num = Math.ceil(BOSS_DURATION - bossTimer);
                if(num >= 1 && num <= 10 && IMG.boss.num[num-1]){ ctx.drawImage(IMG.boss.num[num-1], WORLD.w/2 - 25, WORLD.h/2 - 100, 50, 50); }
            }
        } 
        
    })();
    </script>
</body>
</html>
