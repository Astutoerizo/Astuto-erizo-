<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Astuto Erizo - Respira y Grita</title>
<style>
html,body{margin:0;height:100%;background:#0e0e10;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
#wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
canvas{background:#1b1b1f;touch-action:none;display:block}
.hud{position:fixed;top:8px;left:50%;transform:translateX(-50%);width:min(92vw,540px);pointer-events:none;display:flex;align-items:center;gap:12px;justify-content:space-between;font-weight:600}
.bar{flex:1;height:14px;background:#3a3a44;border-radius:999px;overflow:hidden;border:2px solid #6ee7b7;box-shadow:0 0 6px rgba(110,231,183,0.6) inset}
.fill{height:100%;width:0%;background:#86efac;transition:width .08s linear}
.cooldown{opacity:.45}
.score{min-width:100px;text-align:right}
.hud-btn{pointer-events:auto;cursor:pointer;padding:4px 8px;background:#24242a;border-radius:6px;font-size:13px}
.toast{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:#24242a;border:1px solid #333;padding:8px 12px;border-radius:10px;font-size:14px;opacity:.9}
.panel{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);transition:opacity .2s ease}
.panel.show{display:flex;opacity:1;pointer-events:auto}
.card{background:#1e1e24;border:1px solid #333;border-radius:16px;padding:20px;width:min(92vw,420px);text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.btn{display:inline-block;margin-top:12px;padding:10px 16px;border-radius:12px;background:#6ee7b7;color:#0b0b0d;font-weight:700;cursor:pointer;user-select:none}
#countdown{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);z-index:999}
#countdown.show{display:flex}
#countdown #countNum img{max-width:60%;height:auto;display:block;margin:0 auto;animation:zoomIn .6s ease}
@keyframes zoomIn{from{transform:scale(.5);opacity:0}to{transform:scale(1);opacity:1}}
#loader{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#0e0e10;z-index:2000}
#loader img{max-width:200px;animation:float 1.8s ease-in-out infinite}
#loader p{margin-top:12px;font-size:18px;color:#6ee7b7;font-weight:bold;animation:blink 1.2s infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-18px)}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
</style>
</head>
<body>
<div id="loader">
  <img id="loaderImg" src="assets/loader.png" alt="Cargando...">
  <p>Loading...</p>
</div>

<div id="wrap"><canvas id="game" width="540" height="960"></canvas></div>

<div class="hud">
  <div class="bar"><div class="fill" id="zenFill"></div></div>
  <div class="score" id="score">Puntos: 0</div>
  <div class="score" id="bestScore">Mejor: 0</div>
  <div class="hud-btn" id="btnMusic">ðŸ”Š</div>
</div>

<div class="panel" id="panel">
  <div class="card">
    <h2>Astuto Erizo</h2>
    <p id="panelMsg">Has gritado al vacÃ­o zenâ€¦</p>
    <div class="btn" id="btnRestart">Reintentar</div>
    <p style="opacity:.7;font-size:12px;margin-top:8px">MantÃ©n pulsado para inhalar Â· Suelta para gritar</p>
  </div>
</div>

<div class="toast" id="hint">MantÃ©n pulsado para inhalar Â· Suelta para gritar</div>

<div class="panel show" id="menuPanel">
  <div class="card">
    <img src="assets/logo_videojuego.png" alt="Astuto Erizo" style="max-width:280px;margin-bottom:12px;">
    <h2>Respira y Grita</h2>
    <p id="menuBest">Mejor puntuaciÃ³n: 0</p>
    <p>Cuando estÃ©s listo, pulsa jugar y respira profundoâ€¦</p>
    <div class="btn" id="btnStart">Jugar</div>
    <p style="opacity:.7;font-size:12px;margin-top:10px">MantÃ©n pulsado para inhalar Â· Suelta para gritar</p>
  </div>
</div>

<div id="countdown"><div id="countNum"></div></div>

<script>
(() => {
  const WORLD={w:540,h:960},SPEED={scroll:280,inc:20,max:520},SPAWN={interval:1.2,min:0.7,timer:0,diffTimer:0},
        CHARGE={value:0,rate:60,max:100,over:85,cooldown:0,cooldownBase:1.0},
        PULSE={base:120,max:380,life:0.25},POINTS={total:0,best:parseInt(localStorage.getItem("bestScore")||"0")},
        PHYSICS={gravity:600,inhaleForce:-1650,maxVy:700},GROUND_H=180;
  let bgStage=0,currentBg=null,gameOver=false,loopId=null,isDown=false,justReleased=false,wasInhaling=false,inhaleSfxTimer=0;
  let bossActive=false,bossTimer=0,bossObj=null,espumas=[],screenShake=0,flashAlpha=0;

  const canvas=document.getElementById("game"),ctx=canvas.getContext("2d");
  const zenFill=document.getElementById("zenFill"),scoreEl=document.getElementById("score"),
        bestScoreEl=document.getElementById("bestScore"),menuBestEl=document.getElementById("menuBest"),
        btnMusic=document.getElementById("btnMusic"),panel=document.getElementById("panel"),
        panelMsg=document.getElementById("panelMsg"),btnRestart=document.getElementById("btnRestart"),
        hint=document.getElementById("hint"),menuPanel=document.getElementById("menuPanel"),
        btnStart=document.getElementById("btnStart"),countdownEl=document.getElementById("countdown"),
        countNum=document.getElementById("countNum");

  const SFX={grito:"assets/sonido_bowl_limpio.mp3",recolectar:"assets/sonido_recolectar_platano.mp3",
    inhalar:"assets/sonido_inhalar.mp3",chocar:"assets/sonido_chocar.mp3",woosh:"assets/woosh.mp3",gong:"assets/gong.mp3"};
  function playSfx(n,v=1){if(!SFX[n]||gameOver)return;const a=new Audio(SFX[n]);a.volume=v;a.play().catch(()=>{});}
  function playGrito(){if(gameOver)return;const a=new Audio(SFX.grito);a.volume=0.35;a.play().catch(()=>{});}
  const MUSIC={base:new Audio("assets/musica_base.mp3")};MUSIC.base.loop=true;MUSIC.base.volume=0.35;
  let currentMusic=MUSIC.base,musicEnabled=true;
  function playMusic(t){if(!musicEnabled)return;if(currentMusic&&currentMusic!==t)try{currentMusic.pause();}catch(e){}currentMusic=t;currentMusic.play().catch(()=>{});}
  function stopMusic(){try{if(currentMusic)currentMusic.pause();}catch(e){}}
  function toggleMusic(){musicEnabled=!musicEnabled;if(musicEnabled){playMusic(currentMusic||MUSIC.base);btnMusic.textContent="ðŸ”Š";}else{stopMusic();btnMusic.textContent="ðŸ”‡";}}
  btnMusic.addEventListener("click",toggleMusic);

  const ASSETS={fondos:{calc:"assets/fondo_calc.png",desierto:"assets/fondo_desierto.png",helado:"assets/fondo_helado.png"},
    erizo:{calmado:"assets/calmado.png",inhalando:"assets/respirando.png",gritando:"assets/gritando.png",parpadeo:"assets/erizo_parpadeo.png"},
    obstaculos:["assets/paraguas.png","assets/helado_meditando.png"],banana:"assets/platano_puntos.png",
    suelo:"assets/suelo.png",cuenco:"assets/cuenco_tibetano.png",nubes:["assets/nubes/nube1.png","assets/nubes/nube2.png","assets/nubes/nube3.png","assets/nubes/nube4.png"],
    boss:"assets/pasta_feroz.png",espuma:"assets/espuma_boss.png"};

  const player={x:140,y:WORLD.h-300,vy:0,r:50,state:"calmado",blinkTimer:Math.random()*4+2};
  const sueloScroll=[{x:0},{x:WORLD.w}],obstacles=[],bananas=[],pulses=[],particles=[],CLOUD={list:[]};
  const IMG={fondos:{},erizo:{},obstaculos:[],banana:null,suelo:null,cuenco:null,nubes:[],boss:null,espuma:null};

  const rand=(a,b)=>a+Math.random()*(b-a),dist2=(ax,ay,bx,by)=>{const dx=ax-bx,dy=ay-by;return dx*dx+dy*dy;};
  function loadImage(s){return new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.onerror=()=>r(null);i.src=s;});}
  async function loadAll(){for(const k in ASSETS.fondos)IMG.fondos[k]=await loadImage(ASSETS.fondos[k]);currentBg=IMG.fondos.calc;
    for(const k in ASSETS.erizo)IMG.erizo[k]=await loadImage(ASSETS.erizo[k]);for(const s of ASSETS.obstaculos)IMG.obstaculos.push(await loadImage(s));
    IMG.banana=await loadImage(ASSETS.banana);IMG.suelo=await loadImage(ASSETS.suelo);IMG.cuenco=await loadImage(ASSETS.cuenco);
    for(const s of ASSETS.nubes)IMG.nubes.push(await loadImage(s));
    IMG.boss=await loadImage(ASSETS.boss);IMG.espuma=await loadImage(ASSETS.espuma);}
  
  function initClouds(){CLOUD.list=[];for(let i=0;i<10;i++){CLOUD.list.push({x:rand(0,WORLD.w),y:rand(50,WORLD.h/2),w:rand(80,180),h:rand(50,100),speed:20+Math.floor(rand(0,3))*40,img:IMG.nubes[Math.floor(rand(0,IMG.nubes.length))]});}}

  function resetAll(){POINTS.total=0;CHARGE.value=0;CHARGE.cooldown=0;SPEED.scroll=280;SPAWN.interval=1.2;SPAWN.timer=SPAWN.diffTimer=0;
    obstacles.length=bananas.length=pulses.length=particles.length=espumas.length=0;player.y=WORLD.h-GROUND_H-player.r+20;player.vy=0;player.state="calmado";
    panel.classList.remove("show");hint.style.display="";bgStage=0;currentBg=IMG.fondos.calc;initClouds();bossActive=false;bossObj=null;gameOver=false;playMusic(MUSIC.base);
    bestScoreEl.textContent="Mejor: "+POINTS.best;menuBestEl.textContent="Mejor puntuaciÃ³n: "+POINTS.best;}

  function spawnObstacle(){if(bossActive)return;const y=rand(240,WORLD.h-180),r=rand(44,70),sp=Math.min(SPEED.scroll+rand(0,60),SPEED.max);
    obstacles.push({x:WORLD.w+60,y,r,speed:sp,kind:Math.floor(rand(0,IMG.obstaculos.length))});
    if(Math.random()<0.3)bananas.push({x:WORLD.w+100,y:rand(220,WORLD.h-200),r:44,speed:sp+40,kind:"banana"});
    if(Math.random()<0.1)bananas.push({x:WORLD.w+150,y:rand(220,WORLD.h-200),r:44,speed:sp+20,kind:"cuenco"});}

  function startBoss(){bossActive=true;bossTimer=10;bossObj={x:WORLD.w-160,y:WORLD.h/2,img:IMG.boss,w:180,h:180};}
  function bossLogic(dt){if(!bossActive)return;bossTimer-=dt;if(bossTimer<=0){bossActive=false;bossObj=null;espumas.length=0;return;}
    if(Math.random()<dt*1){espumas.push({x:bossObj.x-40,y:bossObj.y+rand(-80,80),vx:-250,vy:rand(-40,40),r:40});}}

  function update(dt){
    if(POINTS.total>=50&&bgStage<1){playSfx("woosh",0.7);currentBg=IMG.fondos.desierto;bgStage=1;setTimeout(startBoss,1000);}
    else if(POINTS.total>=85&&bgStage<2){playSfx("woosh",0.7);currentBg=IMG.fondos.helado;bgStage=2;}
    bossLogic(dt);
    for(let s of sueloScroll){s.x-=SPEED.scroll*dt;if(s.x<=-WORLD.w)s.x+=WORLD.w*2;}
    for(const c of CLOUD.list){c.x-=c.speed*dt;if(c.x+c.w<0){c.x=WORLD.w+rand(10,100);c.y=rand(50,WORLD.h/2);}}
    SPAWN.timer+=dt;SPAWN.diffTimer+=dt;if(SPAWN.timer>=SPAWN.interval){SPAWN.timer=0;spawnObstacle();}
    if(SPAWN.diffTimer>=10){SPAWN.diffTimer=0;SPEED.scroll=Math.min(SPEED.scroll+SPEED.inc,SPEED.max);SPAWN.interval=Math.max(SPAWN.min,SPAWN.interval-0.05);}
    if(isDown&&CHARGE.cooldown<=0){player.state="inhalando";player.vy+=PHYSICS.inhaleForce*dt;CHARGE.value=Math.min(CHARGE.max,CHARGE.value+CHARGE.rate*dt);playSfx("inhalar",0.15);}
    player.vy+=PHYSICS.gravity*dt;if(player.vy>PHYSICS.maxVy)player.vy=PHYSICS.maxVy;player.y+=player.vy*dt;
    const sueloTop=WORLD.h-GROUND_H-player.r;if(player.y>sueloTop){player.y=sueloTop;player.vy=0;}
    if(player.y<80)player.y=80; // lÃ­mite superior
    for(let i=obstacles.length-1;i>=0;i--){const o=obstacles[i];o.x-=o.speed*dt;if(o.x+o.r<0){obstacles.splice(i,1);continue;}
      if(dist2(player.x,player.y,o.x,o.y)<(player.r+o.r)*(player.r+o.r)){playSfx("chocar",0.35);toGameOver("Demasiada energÃ­a zen!");return;}}
    for(let i=bananas.length-1;i>=0;i--){const b=bananas[i];b.x-=b.speed*dt;if(b.x+b.r<0){bananas.splice(i,1);continue;}
      if(dist2(player.x,player.y,b.x,b.y)<(player.r+b.r)*(player.r+b.r)){bananas.splice(i,1);POINTS.total+=b.kind==="banana"?1:3;playSfx("recolectar",0.45);}}
    for(let i=espumas.length-1;i>=0;i--){const e=espumas[i];e.x+=e.vx*dt;e.y+=e.vy*dt;if(e.x<-80)espumas.splice(i,1);
      if(dist2(player.x,player.y,e.x,e.y)<(player.r+e.r)*(player.r+e.r)){playSfx("chocar",0.35);toGameOver("Pasta Feroz te ha lavado la cara!");return;}}
    scoreEl.textContent="Puntos: "+POINTS.total;if(POINTS.total>POINTS.best){POINTS.best=POINTS.total;localStorage.setItem("bestScore",POINTS.best);}
    bestScoreEl.textContent="Mejor: "+POINTS.best;
  }

  function draw(){
    if(screenShake>0){screenShake*=0.8;if(screenShake<0.02)screenShake=0;}
    const sx=(Math.random()-0.5)*screenShake*20,sy=(Math.random()-0.5)*screenShake*20;
    ctx.save();ctx.translate(sx,sy);
    ctx.drawImage(currentBg,0,0,WORLD.w,WORLD.h);
    for(const c of CLOUD.list)ctx.drawImage(c.img,c.x,c.y,c.w,c.h);
    for(const s of sueloScroll)ctx.drawImage(IMG.suelo,s.x,WORLD.h-GROUND_H,WORLD.w,GROUND_H);
    if(bossObj)ctx.drawImage(bossObj.img,bossObj.x,bossObj.y,bossObj.w,bossObj.h);
    for(const e of espumas)ctx.drawImage(IMG.espuma,e.x-40,e.y-40,80,80);
    for(const b of bananas){const img=b.kind==="banana"?IMG.banana:IMG.cuenco;ctx.drawImage(img,b.x-b.r,b.y-b.r,b.r*2,b.r*2);}
    for(const o of obstacles){ctx.drawImage(IMG.obstaculos[o.kind],o.x-o.r,o.y-o.r,o.r*2,o.r*2);}
    const img=player.state==="inhalando"?IMG.erizo.inhalando:player.state==="gritando"?IMG.erizo.gritando:player.state==="calmado"?IMG.erizo.calmado:IMG.erizo.parpadeo;
    ctx.drawImage(img,player.x-60,player.y-60,120,120);
    ctx.restore();
    if(flashAlpha>0){ctx.fillStyle=`rgba(255,255,255,${flashAlpha})`;ctx.fillRect(0,0,WORLD.w,WORLD.h);}
  }

  let last=0;
  function frame(t){if(!last)last=t;const dt=(t-last)/1000;last=t;if(!gameOver){update(dt);draw();requestAnimationFrame(frame);}}
  function startGame(){menuPanel.classList.remove("show");countdown(()=>{resetAll();requestAnimationFrame(frame);});}
  btnStart.onclick=startGame;btnRestart.onclick=startGame;
  function countdown(cb){let n=3;countNum.innerHTML=`<img src="assets/contador_${n}.png">`;countdownEl.classList.add("show");
    const int=setInterval(()=>{n--;if(n>0){countNum.innerHTML=`<img src="assets/contador_${n}.png">`;}else{clearInterval(int);countdownEl.classList.remove("show");cb();}},1000);}

  canvas.addEventListener("pointerdown",()=>{isDown=true;justReleased=false;});
  canvas.addEventListener("pointerup",()=>{isDown=false;justReleased=true;if(CHARGE.value>CHARGE.over){player.state="gritando";playGrito();triggerFlash(0.7);}CHARGE.value=0;});
  loadAll().then(()=>{document.getElementById("loader").style.display="none";});
})();
</script>
</body>
</html>
