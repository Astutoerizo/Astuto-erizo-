<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Astuto Erizo - Respira y Grita</title>
  <style>
    html, body { margin:0; height:100%; background:#0e0e10; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #wrap { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; }
    canvas { background:#1b1b1f; touch-action:none; }
    .hud {
      position: fixed; top: 8px; left: 50%; transform: translateX(-50%);
      width: min(92vw, 540px); pointer-events:none;
      display:flex; align-items:center; gap:12px; justify-content:space-between;
      font-weight:600;
    }
    .bar { flex:1; height:14px; background:#3a3a44; border-radius:999px; overflow:hidden; border:2px solid #6ee7b7; box-shadow:0 0 6px rgba(110,231,183,0.6) inset; }
    .fill { height:100%; width:0%; background:#86efac; transition: width .08s linear; }
    .cooldown { opacity:.45; }
    .score { min-width:120px; text-align:right; }
    .hud-btn {
      pointer-events:auto; cursor:pointer; padding:4px 8px; background:#24242a; border-radius:6px; font-size:13px;
    }
    .toast {
      position:fixed; bottom:14px; left:50%; transform:translateX(-50%);
      background:#24242a; border:1px solid #333; padding:8px 12px; border-radius:10px; font-size:14px; opacity:.9;
    }
    .panel {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.45); transition:opacity .2s ease;
    }
    .panel.show {
      display:flex;
      opacity:1;
      pointer-events:auto;
    }
    .card {
      background:#1e1e24; border:1px solid #333; border-radius:16px; padding:20px; width:min(92vw, 420px); text-align:center;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .btn {
      display:inline-block; margin-top:12px; padding:10px 16px; border-radius:12px; background:#6ee7b7; color:#0b0b0d;
      font-weight:700; cursor:pointer; user-select:none;
    }
    /* Overlay de cuenta atrÃ¡s */
    #countdown {
      position: fixed; inset: 0;
      display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,.45); backdrop-filter: blur(2px);
      z-index: 999;
    }
    #countdown.show { display: flex; }
    #countdown #countNum img {
      max-width: 60%; height: auto;
      display: block; margin: 0 auto;
      animation: zoomIn 0.6s ease;
    }
    @keyframes zoomIn {
      from { transform: scale(0.5); opacity: 0; }
      to   { transform: scale(1);   opacity: 1; }
    }
    /* Loader */
    #loader {
      position:fixed; inset:0;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      background:#0e0e10;
      z-index:2000;
    }
    #loader img {
      max-width: 200px;
      animation: float 1.8s ease-in-out infinite;
    }
    #loader p {
      margin-top: 12px;
      font-size: 18px;
      color: #6ee7b7;
      font-weight: bold;
      animation: blink 1.2s infinite;
    }
    @keyframes float {
      0%,100% { transform: translateY(0); }
      50%     { transform: translateY(-18px); }
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
  </style>
</head>
<body>
  <div id="loader">
    <img id="loaderImg" src="assets/loader.png" alt="Cargando...">
    <p>Loading...</p>
  </div>

  <div id="wrap">
    <canvas id="game" width="540" height="960"></canvas>
  </div>

  <div class="hud">
    <div class="bar"><div class="fill" id="zenFill"></div></div>
    <div class="score" id="score">Puntos: 0</div>
    <div class="score" id="bestScore">Mejor: 0</div>
    <div class="hud-btn" id="btnMusic">ðŸ”Š</div>
  </div>

  <!-- Panel de game over -->
  <div class="panel" id="panel">
    <div class="card">
      <h2>Astuto Erizo</h2>
      <p id="panelMsg">Has gritado al vacÃ­o zenâ€¦</p>
      <div class="btn" id="btnRestart">Reintentar</div>
      <p style="opacity:.7; font-size:12px; margin-top:8px;">MantÃ©n pulsado para inhalar Â· Suelta para gritar</p>
    </div>
  </div>

  <div class="toast" id="hint">MantÃ©n pulsado para inhalar Â· Suelta para gritar</div>

  <!-- Panel de inicio -->
  <div class="panel show" id="menuPanel">
    <div class="card">
      <img src="assets/logo_videojuego.png" alt="Astuto Erizo" style="max-width: 280px; margin-bottom: 12px;">
      <h2>Respira y Grita</h2>
      <p id="menuBest">Mejor puntuaciÃ³n: 0</p>
      <p>Cuando estÃ©s listo, pulsa jugar y respira profundoâ€¦</p>
      <div class="btn" id="btnStart">Jugar</div>
      <p style="opacity:.7; font-size:12px; margin-top:10px;">
        MantÃ©n pulsado para inhalar Â· Suelta para gritar
      </p>
    </div>
  </div>

  <!-- Cuenta atrÃ¡s -->
  <div id="countdown"><div id="countNum"></div></div>

  <script>
  (() => {
    // ==========================
    // CONFIG Y ESTADO GENERAL
    // ==========================
    const WORLD = { w: 540, h: 960 };
    const SPEED = { scroll: 280, inc: 20, max: 520 };
    const SPAWN = { interval: 1.2, min: 0.7, timer: 0, diffTimer: 0 };
    const CHARGE = { value:0, rate:60, max:100, over:85, cooldown:0, cooldownBase:1.0 };
    const PULSE  = { base:120, max:380, life:0.25 };
    const POINTS = { total:0, best: parseInt(localStorage.getItem("bestScore") || "0") };
    const PHYSICS = { gravity: 600, inhaleForce: -1100, maxVy: 500 };
    const GROUND_H = 180;

    let bgStage = 0;
    let currentBg = null;
    let loopId = null;
    let gameOver = false;

    // ==========================
    // AUDIO
    // ==========================
    const SFX = {
      grito: "assets/sonido_bowl_limpio.mp3",
      recolectar: "assets/sonido_recolectar_platano.mp3",
      inhalar: "assets/sonido_inhalar.mp3",
      chocar: "assets/sonido_chocar.mp3",
      woosh: "assets/woosh.mp3",
      gong: "assets/gong.mp3"
    };
    function playSfx(name, volume = 1.0) {
      const src = SFX[name];
      if (!src) return;
      const a = new Audio(src);
      a.volume = volume;
      a.play().catch(()=>{});
    }

    // MÃºsica de fondo
    const MUSIC = {
      base: new Audio("assets/musica_base.mp3"),
      bonus: new Audio("assets/musica_bonus.mp3"),
      boss: new Audio("assets/musica_boss.mp3")
    };
    for (let k in MUSIC) {
      MUSIC[k].loop = true;
      MUSIC[k].volume = 0.4;
    }
    let currentMusic = MUSIC.base;
    let musicEnabled = true;

    function playMusic(track) {
      if (!musicEnabled) return;
      if (currentMusic) currentMusic.pause();
      currentMusic = track;
      if (currentMusic) currentMusic.play().catch(()=>{});
    }
    function toggleMusic() {
      musicEnabled = !musicEnabled;
      if (musicEnabled) {
        playMusic(currentMusic);
        btnMusic.textContent = "ðŸ”Š";
      } else {
        if (currentMusic) currentMusic.pause();
        btnMusic.textContent = "ðŸ”‡";
      }
    }

    // ==========================
    // ASSETS
    // ==========================
    const ASSETS = {
      fondos: {
        calc: "assets/fondo_calc.png",
        desierto: "assets/fondo_desierto.png",
        helado: "assets/fondo_helado.png"
      },
      erizo: {
        calmado:   "assets/calmado.png",
        inhalando:"assets/respirando.png",
        gritando: "assets/gritando.png"
      },
      obstaculos: ["assets/paraguas.png","assets/helado_meditando.png"],
      banana: "assets/platano_puntos.png",
      suelo: "assets/suelo.png",
      cuenco: "assets/cuenco_tibetano.png",
      nubes: [
        "assets/nubes/nube1.png",
        "assets/nubes/nube2.png",
        "assets/nubes/nube3.png",
        "assets/nubes/nube4.png"
      ]
    };

    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const scoreEl = document.getElementById("score");
    const bestScoreEl = document.getElementById("bestScore");
    const menuBestEl = document.getElementById("menuBest");
    const zenFill = document.getElementById("zenFill");
    const btnMusic = document.getElementById("btnMusic");

    btnMusic.addEventListener("click", toggleMusic);

    // (el resto del cÃ³digo del juego se mantiene igual que en tu anclaje: update, draw, reset, countdown, loader, etc.)
    // dentro de reset() al final: actualizar el rÃ©cord mostrado:
    function updateBestScoreDisplay() {
      bestScoreEl.textContent = "Mejor: " + POINTS.best;
      menuBestEl.textContent = "Mejor puntuaciÃ³n: " + POINTS.best;
    }
    updateBestScoreDisplay();

    // en gameOver: actualizar rÃ©cord
    function onGameOver() {
      gameOver = true;
      if (POINTS.total > POINTS.best) {
        POINTS.best = POINTS.total;
        localStorage.setItem("bestScore", POINTS.best);
        updateBestScoreDisplay();
      }
    }

    // cuando arranque el juego:
    function startGame() {
      reset();
      playMusic(MUSIC.base);
      requestAnimationFrame(frame);
    }

    // (aÃ±adir llamada a onGameOver() cuando colisiona con obstÃ¡culo)
  })();
  </script>
</body>
</html>
