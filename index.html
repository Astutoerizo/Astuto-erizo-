<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Astuto Erizo - Respira y Grita</title>
  <style>
    html,body{
      margin:0; height:100%; background:#0e0e10; color:#fff;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    #wrap { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; }
    canvas { background:#1b1b1f; touch-action:none; display:block; }

    /* HUD */
    .hud {
      position: fixed; top: 8px; left: 50%; transform: translateX(-50%);
      width: min(92vw, 540px); pointer-events:none;
      display:flex; align-items:center; gap:12px; justify-content:space-between;
      font-weight:600;
    }
    .bar { flex:1; height:14px; background:#3a3a44; border-radius:999px; overflow:hidden;
      border:2px solid #6ee7b7; box-shadow:0 0 6px rgba(110,231,183,0.6) inset; }
    .fill { height:100%; width:0%; background:#86efac; transition: width .08s linear; }
    .score { min-width:100px; text-align:right; pointer-events:auto; }
    .hud-btn { pointer-events:auto; cursor:pointer; padding:6px 8px; background:#24242a; border-radius:6px; font-size:13px; }

    /* Panel */
    .panel { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); transition:opacity .2s ease; }
    .panel.show { display:flex; opacity:1; pointer-events:auto; }
    .card { background:#1e1e24; border:1px solid #333; border-radius:16px; padding:20px; width:min(92vw,420px); text-align:center; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    .btn { display:inline-block; margin-top:12px; padding:10px 16px; border-radius:12px; background:#6ee7b7; color:#0b0b0d; font-weight:700; cursor:pointer; user-select:none; }

    /* Loader */
    #loader {
      position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#0e0e10; z-index:2000;
    }
    #loader img { max-width: 200px; animation: float 1.8s ease-in-out infinite; }
    #loader p { margin-top:12px; font-size:18px; color:#6ee7b7; font-weight:bold; animation: blink 1.2s infinite; }
    @keyframes float { 0%,100%{ transform: translateY(0);} 50%{ transform: translateY(-18px);} }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }

    /* Boss counter top-left */
    #bossCounter { position:fixed; top:12px; left:12px; z-index:900; display:none; background:rgba(0,0,0,0.25); padding:6px; border-radius:8px; }
    #bossCounter img { width:56px; height:auto; display:block; }

    /* Shake */
    .shake { animation: shake 0.4s; }
    @keyframes shake { 0%,100%{ transform:none } 25%{ transform:translate(-6px,6px) } 50%{ transform:translate(6px,-6px) } 75%{ transform:translate(-4px,-4px) } }

    /* Small highlight flash */
    #flash { position:fixed; inset:0; background:rgba(255,255,255,0.06); pointer-events:none; opacity:0; transition: opacity .18s ease; }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader">
    <img id="loaderImg" src="assets/loader.png" alt="Cargando">
    <p>Loading...</p>
  </div>

  <!-- Canvas -->
  <div id="wrap"><canvas id="game" width="540" height="960"></canvas></div>

  <!-- HUD -->
  <div class="hud">
    <div class="bar"><div class="fill" id="zenFill"></div></div>
    <div class="score" id="score">Puntos: 0</div>
    <div class="score" id="bestScore">Mejor: 0</div>
    <div class="hud-btn" id="btnMusic">ðŸ”Š</div>
  </div>

  <!-- Flash -->
  <div id="flash"></div>

  <!-- Panels -->
  <div class="panel" id="panel">
    <div class="card">
      <h2>Astuto Erizo</h2>
      <p id="panelMsg">Has gritado al vacÃ­o zenâ€¦</p>
      <div class="btn" id="btnRestart">Reintentar</div>
      <p style="opacity:.7; font-size:12px; margin-top:8px;">MantÃ©n pulsado para inhalar Â· Suelta para gritar</p>
    </div>
  </div>

  <div class="panel show" id="menuPanel">
    <div class="card">
      <img src="assets/logo_videojuego.png" alt="Astuto Erizo" style="max-width:260px;margin-bottom:12px;">
      <h2>Respira y Grita</h2>
      <p id="menuBest">Mejor puntuaciÃ³n: 0</p>
      <p>Cuando estÃ©s listo, pulsa jugar y respira profundoâ€¦</p>
      <div class="btn" id="btnStart">Jugar</div>
      <p style="opacity:.7; font-size:12px; margin-top:10px;">MantÃ©n pulsado para inhalar Â· Suelta para gritar</p>
    </div>
  </div>

  <!-- Boss counter (top-left) -->
  <div id="bossCounter"><img src="" alt="count"></div>

  <script>
  (async () => {
    // --------------- CONFIG / ESTADO ---------------
    const TEST_MODE = true; // true para pruebas rÃ¡pidas (boss a 5, bonus a 20). Pon false para valores reales.
    const WORLD = { w:540, h:960 };
    const SPEED = { scroll:280, inc:20, max:520 };
    const SPAWN    = { interval:1.2, min:0.7, timer:0, diffTimer:0 };
    const CHARGE   = { value:0, rate:60, max:100, over:85, cooldown:0, cooldownBase:1.0 };
    const PULSE    = { base:120, max:380, life:0.25 };
    const POINTS   = { total:0, best: parseInt(localStorage.getItem('bestScore')||'0',10) };
    const PHYSICS  = { gravity:600, inhaleForce:-1400, maxVy:500 }; // inhaleForce changed for snappier lift
    const GROUND_H = 180;

    // DOM + CANVAS
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const loader = document.getElementById('loader');
    const loaderImg = document.getElementById('loaderImg');
    const zenFill = document.getElementById('zenFill');
    const scoreEl = document.getElementById('score');
    const bestEl = document.getElementById('bestScore');
    const menuBest = document.getElementById('menuBest');
    const panel = document.getElementById('panel');
    const panelMsg = document.getElementById('panelMsg');
    const btnRestart = document.getElementById('btnRestart');
    const menuPanel = document.getElementById('menuPanel');
    const btnStart = document.getElementById('btnStart');
    const btnMusic = document.getElementById('btnMusic');
    const hint = document.getElementById('hint');
    const bossCounter = document.getElementById('bossCounter');
    const flash = document.getElementById('flash');

    // scale-to-fit
    function fit() {
      const vw = window.innerWidth, vh = window.innerHeight;
      const s = Math.min(vw / WORLD.w, vh / WORLD.h);
      canvas.style.width = WORLD.w * s + 'px';
      canvas.style.height = WORLD.h * s + 'px';
    }
    window.addEventListener('resize', fit);
    fit();

    // --------------- AUDIO ---------------
    // SFX map (must be present in assets)
    const SFX_SOURCES = {
      grito: "assets/sonido_bowl_limpio.mp3",
      recolectar: "assets/sonido_recolectar_platano.mp3",
      inhalar: "assets/sonido_inhalar.mp3",
      chocar: "assets/sonido_chocar.mp3",
      woosh: "assets/woosh.mp3",
      gong: "assets/gong.mp3"
    };
    let allowSfx = true; // set to false when gameOver to avoid more SFX
    function playSfx(name, volume=1) {
      if (!allowSfx) return;
      const src = SFX_SOURCES[name];
      if (!src) return;
      const a = new Audio(src);
      a.volume = volume;
      a.play().catch(()=>{});
    }

    // MUSIC (Audio elements so we can loop & pause)
    const MUSIC = {
      base: new Audio('assets/musica_base.mp3'),
      boss: new Audio('assets/musica_boss.mp3'),
      bonus: new Audio('assets/musica_bonus.mp3')
    };
    for (let k in MUSIC) { MUSIC[k].loop = true; MUSIC[k].volume = 0.45; }
    let currentMusic = MUSIC.base;
    let musicEnabled = true;
    function playMusic(track) {
      if (!musicEnabled) return;
      if (currentMusic && !currentMusic.paused) currentMusic.pause();
      currentMusic = track;
      currentMusic.currentTime = 0;
      currentMusic.play().catch(()=>{});
    }
    function stopMusic() { if (currentMusic) { currentMusic.pause(); currentMusic.currentTime = 0; } }

    btnMusic.addEventListener('click', () => {
      musicEnabled = !musicEnabled;
      if (musicEnabled) { btnMusic.textContent = 'ðŸ”Š'; playMusic(currentMusic || MUSIC.base); }
      else { btnMusic.textContent = 'ðŸ”‡'; stopMusic(); }
    });

    // --------------- ASSETS (paths) ---------------
    const ASSETS = {
      fondos: {
        calc: "assets/fondo_calc.png",
        desierto: "assets/fondo_desierto.png",
        helado: "assets/fondo_helado.png"
      },
      erizo: {
        calmado: "assets/calmado.png",
        inhalando: "assets/respirando.png",
        gritando: "assets/gritando.png",
        parpadeo: "assets/erizo_parpadeo.png" // optional extra sprite user uploaded
      },
      obstaculos: [
        "assets/paraguas.png",
        "assets/helado_meditando.png"
      ],
      banana: "assets/platano_puntos.png",
      cuenco: "assets/cuenco_tibetano.png",
      suelo: "assets/suelo.png",
      nubes: [
        "assets/nubes/nube1.png",
        "assets/nubes/nube2.png",
        "assets/nubes/nube3.png",
        "assets/nubes/nube4.png"
      ],
      // boss assets (in assets/boss/)
      boss: {
        pasta: "assets/boss/pasta_feroz.png",
        espumas: [
          "assets/boss/espuma_boss.png",
          "assets/boss/espuma_boss1.png",
          "assets/boss/espuma_boss2.png",
          "assets/boss/espuma_boss3.png"
        ],
        cartel: "assets/boss/cuidado_espuma.png",
        numerosDir: "assets/boss/" // numbered images 1.png..10.png
      },
      // bonus collectible sprites
      bonus: [
        "assets/boss/patito1.png",
        "assets/boss/patito2.png"
      ],
      // loaders options
      loaders: [
        "assets/loader.png",
        "assets/loader1.png",
        "assets/loader2.png",
        "assets/loader3.png"
      ]
    };

    // --------------- IMAGES PRELOAD ---------------
    const IMG = {
      fondos: {},
      erizo: {},
      obstaculos: [],
      banana: null,
      cuenco: null,
      suelo: null,
      nubes: [],
      boss: { pasta: null, espumas: [], cartel: null },
      numeros: [], // 1..10
      bonus: []
    };

    function loadImage(src) {
      return new Promise(res => {
        if (!src) { res(null); return; }
        const im = new Image();
        im.onload = () => res(im);
        im.onerror = () => { console.warn("Img load fail:", src); res(null); };
        im.src = src;
      });
    }

    async function loadAll() {
      // backgrounds
      IMG.fondos.calc = await loadImage(ASSETS.fondos.calc);
      IMG.fondos.desierto = await loadImage(ASSETS.fondos.desierto);
      IMG.fondos.helado = await loadImage(ASSETS.fondos.helado);
      // erizo
      IMG.erizo.calmado = await loadImage(ASSETS.erizo.calmado);
      IMG.erizo.inhalando = await loadImage(ASSETS.erizo.inhalando);
      IMG.erizo.gritando = await loadImage(ASSETS.erizo.gritando);
      IMG.erizo.parpadeo = await loadImage(ASSETS.erizo.parpadeo);
      // obstacles
      for (let s of ASSETS.obstaculos) IMG.obstaculos.push(await loadImage(s));
      IMG.banana = await loadImage(ASSETS.banana);
      IMG.cuenco = await loadImage(ASSETS.cuenco);
      IMG.suelo = await loadImage(ASSETS.suelo);
      for (let s of ASSETS.nubes) IMG.nubes.push(await loadImage(s));
      // boss
      IMG.boss.pasta = await loadImage(ASSETS.boss.pasta);
      IMG.boss.cartel = await loadImage(ASSETS.boss.cartel);
      for (let e of ASSETS.boss.espumas) IMG.boss.espumas.push(await loadImage(e));
      // numeros 1..10
      for (let i=1;i<=10;i++){
        const nimg = await loadImage(`${ASSETS.boss.numerosDir}${i}.png`);
        IMG.numeros.push(nimg);
      }
      // bonus
      for (let b of ASSETS.bonus) IMG.bonus.push(await loadImage(b));

      // set initial bg
      currentBg = IMG.fondos.calc;
    }

    // --------------- ENTITIES / STATE ---------------
    const player = { x:140, y:WORLD.h-300, r:48, vy:0, state:'calmado', mareo:0 };
    const sueloScroll = [{x:0},{x:WORLD.w}];
    const obstacles = [], bananas = [], pulses = [], particles = [];
    const CLOUD = { list: [] };

    let scale = 1, offsetX = 0, offsetY = 0;
    function initClouds() {
      CLOUD.list = [];
      for (let i=0;i<10;i++){
        const band = Math.floor(Math.random()*3);
        CLOUD.list.push({
          x: Math.random()*WORLD.w,
          y: 50 + Math.random()*(WORLD.h/2 - 50),
          w: 80 + Math.random()*100,
          h: 40 + Math.random()*60,
          speed: 20 + band*40,
          band,
          img: IMG.nubes.length ? IMG.nubes[Math.floor(Math.random()*IMG.nubes.length)] : null
        });
      }
    }

    // --------------- UTILS ---------------
    const rand = (a,b) => a + Math.random()*(b-a);
    const chance = p => Math.random() < p;
    function dist2(ax,ay,bx,by){ const dx=ax-bx, dy=ay-by; return dx*dx + dy*dy; }

    // --------------- GAME FLOW ---------------
    let lastFrame = performance.now();
    let loopId = null;
    let started = false;
    let gameOver = false;
    let allowInput = true;
    let bossActive = false, bossTimer = 0, bossSpawned = false;
    let bonusActive = false, bonusTimer = 0;
    let bossObject = null;

    // boss/bonus thresholds (use test mode values for dev)
    const BOSS_THRESHOLD = TEST_MODE ? 5 : 50;
    const BONUS_THRESHOLD = TEST_MODE ? 20 : 75;

    function resetGameState() {
      POINTS.total = 0;
      CHARGE.value = 0; CHARGE.cooldown = 0;
      SPAWN.interval = 1.2; SPAWN.timer = 0; SPAWN.diffTimer = 0;
      SPEED.scroll = 280;
      obstacles.length = bananas.length = pulses.length = particles.length = 0;
      player.y = WORLD.h - GROUND_H - player.r + 20;
      player.vy = 0;
      player.state = 'calmado';
      player.mareo = 0;
      panel.classList.remove('show');
      allowInput = true;
      gameOver = false;
      bossActive = false; bossTimer = 0; bossSpawned = false; bossObject = null;
      bonusActive = false; bonusTimer = 0;
      currentBg = IMG.fondos.calc;
      initClouds();
      allowSfx = true;
    }

    // --------------- SPAWNERS ---------------
    function spawnObstacle() {
      const y = rand(240, WORLD.h - 180);
      const r = rand(38,70);
      const speed = Math.min(SPEED.scroll + rand(0,60), SPEED.max);
      obstacles.push({ x: WORLD.w + 60, y, r, speed, kind: Math.floor(rand(0, IMG.obstaculos.length)), img: IMG.obstaculos[Math.floor(rand(0,IMG.obstaculos.length))] });
      if (chance(0.3)) bananas.push({ x: WORLD.w + 100, y: rand(220, WORLD.h - 200), r: 36, speed: speed + 40, kind: 'banana', value:1, img: IMG.banana });
      if (chance(0.1)) bananas.push({ x: WORLD.w + 150, y: rand(220, WORLD.h - 200), r: 36, speed: speed + 20, kind: 'cuenco', value:5, img: IMG.cuenco });
    }

    // bonus spawns are handled in startBonus loop

    // --------------- BOSS ---------------
    function beginBossPhase(){
      bossActive = true;
      bossSpawned = false;
      // change background to desert for boss
      currentBg = IMG.fondos.desierto;
      playSfx('woosh', 0.7);
      // brief pause + show cartel on main canvas -> we'll show cartel in draw-phase until boss spawns
      bossTimer = 3.0; // 3s to show cartel then spawn boss and start countdown
      bossSpawned = false;
      // switch music
      playMusic(MUSIC.boss);
    }

    function spawnBoss(){
      bossObject = {
        x: WORLD.w - 240,
        y: Math.max(60, (WORLD.h/2) - 120),
        w: 220,
        h: 220,
        img: IMG.boss.pasta
      };
      bossTimer = 10.0; // boss active time
      bossSpawned = true;
      // start boss counter UI
      startBossCounter(bossTimer);
    }

    function bossFire() {
      // boss launches foam projectiles from its left side (random vertical positions)
      const img = IMG.boss.espumas[Math.floor(Math.random()*IMG.boss.espumas.length)];
      const y = bossObject.y + 30 + Math.random()*(bossObject.h - 60);
      obstacles.push({ x: bossObject.x - 20, y, r:36, speed: 320 + Math.random()*60, img, kind:'foam' });
    }

    // --------------- BOSS COUNTER UI ---------------
    let bossCounterInterval = null;
    function startBossCounter(duration) {
      bossCounter.style.display = 'block';
      const total = Math.ceil(duration);
      let idx = 0;
      function step(){
        if (!bossActive || !bossSpawned) { bossCounter.style.display = 'none'; return; }
        if (idx < IMG.numeros.length && IMG.numeros[idx]) {
          bossCounter.firstElementChild.src = IMG.numeros[idx].src;
        } else {
          // fallback to number text (shouldn't happen if images loaded)
          bossCounter.firstElementChild.removeAttribute('src');
        }
        idx++;
        if (idx >= total) {
          setTimeout(()=>{ bossCounter.style.display='none'; }, 900);
        } else {
          setTimeout(step, 1000);
        }
      }
      step();
    }

    // --------------- BONUS ---------------
    function beginBonusPhase(){
      bonusActive = true;
      bonusTimer = 10.0; // how long the bonus stage lasts
      currentBg = IMG.fondos.helado;
      playMusic(MUSIC.bonus);
      // spawn some immediate bonus items
      for (let i=0;i<4;i++){
        setTimeout(()=> {
          const which = Math.floor(Math.random()*IMG.bonus.length);
          bananas.push({ x: WORLD.w + 60 + Math.random()*60, y: 200 + Math.random()*400, r:36, speed: 260, kind:'bonus', value: which==0?1:2, img: IMG.bonus[which] });
        }, i*250);
      }
      // the ongoing spawn is handled in update loop under bonusActive
    }

    function endBossPhase(){
      bossActive = false;
      bossSpawned = false;
      bossObject = null;
      playSfx('woosh', 0.7);
      playMusic(MUSIC.base);
      currentBg = IMG.fondos.calc;
    }

    function endBonusPhase(){
      bonusActive = false;
      playSfx('woosh', 0.7);
      playMusic(MUSIC.base);
      currentBg = IMG.fondos.calc;
    }

    // --------------- INPUT ---------------
    let isPointerDown = false, wasInhaling = false, inhaleSfxTimer = 0;
    canvas.addEventListener('pointerdown', async (e) => {
      // resume audio context if needed (handled by Audio elements; not using WebAudio)
      isPointerDown = true;
      // quick reaction: start inhaling earlier by setting isDown
      if (allowInput && !gameOver) {
        wasInhaling = true;
      }
      hint && (hint.style.display = 'none');
    });
    window.addEventListener('pointerup', () => {
      if (!isPointerDown) return;
      isPointerDown = false;
      // release event -> set justReleased and handle in update
      wasInhaling = false;
      justReleased = true;
    });

    // --------------- UPDATE ---------------
    function update(dt) {
      // If we are showing boss cartel before spawn:
      if (bossActive && !bossSpawned) {
        bossTimer -= dt;
        if (bossTimer <= 0) spawnBoss();
        return; // freeze other spawns while cartel shows
      }

      // background change triggers (also play a woosh slightly earlier)
      if (!bossActive && !bonusActive) {
        if (POINTS.total >= BOSS_THRESHOLD && !bossActive) {
          beginBossPhase();
          return;
        }
        if (POINTS.total >= BONUS_THRESHOLD && !bonusActive && !bossActive) {
          beginBonusPhase();
          return;
        }
      }

      // movement of suelo and clouds
      for (let s of sueloScroll) { s.x -= SPEED.scroll * dt; if (s.x <= -WORLD.w) s.x += WORLD.w * 2; }
      for (const c of CLOUD.list) { c.x -= c.speed * dt; if (c.x + c.w < 0) { c.x = WORLD.w + rand(10,100); c.y = rand(50, WORLD.h/2); } }

      // difficulty ramp
      SPAWN.timer += dt; SPAWN.diffTimer += dt;
      if (SPAWN.timer >= SPAWN.interval) { SPAWN.timer = 0; if (!bossActive && !bonusActive) spawnObstacle(); }
      if (SPAWN.diffTimer >= 10) { SPAWN.diffTimer = 0; SPEED.scroll = Math.min(SPEED.scroll + SPEED.inc, SPEED.max); SPAWN.interval = Math.max(SPAWN.min, SPAWN.interval - 0.05); }

      // player inhale / physics
      if (isPointerDown && CHARGE.cooldown <= 0 && allowInput && !gameOver) {
        player.state = 'inhalando';
        // quicker reaction: apply a stronger impulse when starting inhaling from stationary
        const boost = (player.vy > 0) ? 1.2 : 1.0;
        player.vy += PHYSICS.inhaleForce * boost * dt;
        CHARGE.value = Math.min(CHARGE.max, CHARGE.value + CHARGE.rate * dt);
        inhaleSfxTimer += dt;
        if (inhaleSfxTimer >= 0.36) { playSfx('inhalar', 0.18); inhaleSfxTimer = 0; }
      }

      // gravity
      player.vy += PHYSICS.gravity * dt;
      if (player.vy > PHYSICS.maxVy) player.vy = PHYSICS.maxVy;
      player.y += player.vy * dt;

      // limit top so player never disappears
      if (player.y < 110) { player.y = 110; player.vy = Math.min(player.vy, 20); }

      // ground collision
      const sueloTop = WORLD.h - GROUND_H - player.r;
      if (player.y > sueloTop) { player.y = sueloTop; player.vy = 0; }

      // release -> pulse / grito
      if (justReleased) {
        justReleased = false;
        if (CHARGE.cooldown <= 0 && allowInput && !gameOver) {
          // pulse
          const t = CHARGE.value / CHARGE.max;
          const rad = PULSE.base + t * (PULSE.max - PULSE.base);
          pulses.push({ x: player.x + 40, y: player.y, rad, life: PULSE.life });
          // sound (lowered)
          playSfx('grito', 0.35);
          CHARGE.value = 0;
          CHARGE.cooldown = CHARGE.cooldownBase;
        }
      }
      if (CHARGE.cooldown > 0) CHARGE.cooldown = Math.max(0, CHARGE.cooldown - dt);

      // pulses affect obstacles
      for (let i = pulses.length - 1; i >= 0; i--) {
        const p = pulses[i];
        p.life -= dt;
        if (p.life <= 0) { pulses.splice(i,1); continue; }
        for (let j = obstacles.length - 1; j >= 0; j--) {
          const o = obstacles[j];
          const rsum = p.rad + (o.r||40);
          if (dist2(p.x, p.y, o.x, o.y) <= rsum*rsum) {
            // remove obstacle
            obstacles.splice(j,1);
            POINTS.total += (o.kind==='bonus' ? (o.value||1) : 2);
            playSfx('recolectar', 0.45);
          }
        }
      }

      // move obstacles & check collisions
      for (let i = obstacles.length - 1; i >= 0; i--) {
        const o = obstacles[i];
        // if boss foam: they move faster to left
        const sp = o.speed || SPEED.scroll;
        o.x -= sp * dt;
        if (o.x < -120) { obstacles.splice(i,1); continue; }
        // collision with player
        const rsum = (o.r||40) + player.r;
        if (dist2(o.x, o.y, player.x, player.y) <= rsum*rsum) {
          // hit -> game over (but if bossActive we may want restart in boss)
          canvas.classList.add('shake');
          setTimeout(()=>canvas.classList.remove('shake'), 400);
          playSfx('chocar', 0.7);
          allowSfx = false; // avoid further SFX
          panelMsg.textContent = "El erizo ha sido atrapado por la espuma!";
          panel.classList.add('show');
          gameOver = true;
          // stop music (boss music should stop too)
          stopMusic();
          // If bossActive we want to restart *in boss phase* after short pause; else reset to menu or normal restart
          // We'll pause a bit and then leave restart to the button handler
          return;
        }
      }

      // move bananas (collectables including bonus patitos)
      for (let i = bananas.length - 1; i >= 0; i--) {
        const b = bananas[i];
        if (!b.img) { bananas.splice(i,1); continue; }
        b.x -= (b.speed || SPEED.scroll) * dt;
        if (b.x < -120) { bananas.splice(i,1); continue; }
        const rsum = (b.r||32) + player.r;
        if (dist2(b.x, b.y, player.x, player.y) <= rsum*rsum) {
          // collect
          bananas.splice(i,1);
          POINTS.total += (b.value || 1);
          playSfx('recolectar', 0.45);
        }
      }

      // boss-specific behavior
      if (bossActive && bossSpawned) {
        bossTimer -= dt;
        // boss shakes slightly while alive: spawn foam at interval
        if (Math.random() < 0.03) bossFire();
        if (bossTimer <= 0) {
          // end boss
          endBossPhase();
        }
      }

      // bonus behavior: spawn more bonus items while active
      if (bonusActive) {
        bonusTimer -= dt;
        if (bonusTimer <= 0) {
          endBonusPhase();
        } else {
          if (Math.random() < 0.18) {
            const which = Math.floor(Math.random()*IMG.bonus.length);
            bananas.push({ x: WORLD.w + 60, y: 180 + Math.random()*420, r:36, speed: 240, kind:'bonus', value: (which===0?1:2), img: IMG.bonus[which] });
          }
        }
      }

      // score & HUD
      scoreEl.textContent = "Puntos: " + POINTS.total;
      bestEl.textContent = "Mejor: " + POINTS.best;
      menuBest.textContent = "Mejor puntuaciÃ³n: " + POINTS.best;
      zenFill.style.width = (CHARGE.value/CHARGE.max)*100 + "%";
    }

    // --------------- DRAW ---------------
    function draw() {
      // clear
      ctx.clearRect(0,0,WORLD.w,WORLD.h);
      // background
      if (currentBg) ctx.drawImage(currentBg, 0, 0, WORLD.w, WORLD.h);
      // if bossActive and not spawned yet, draw cartel centered
      if (bossActive && !bossSpawned && IMG.boss.cartel) {
        ctx.drawImage(IMG.boss.cartel, WORLD.w/2 - 200, WORLD.h/2 - 80, 400, 160);
        return; // don't draw everything else while cartel shows
      }
      // clouds
      for (let pass=0; pass<3; pass++){
        for (const c of CLOUD.list) {
          if (c.band !== pass) continue;
          if (c.img) ctx.drawImage(c.img, c.x, c.y, c.w, c.h);
        }
      }
      // pulses
      for (const p of pulses) {
        const alpha = Math.max(0, p.life / PULSE.life);
        ctx.strokeStyle = `rgba(99,102,241,${alpha})`;
        ctx.lineWidth = 6;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.rad, 0, Math.PI*2); ctx.stroke();
      }
      // obstacles
      for (const o of obstacles) {
        if (o.img) ctx.drawImage(o.img, o.x - (o.r||40), o.y - (o.r||40), (o.r||40)*2, (o.r||40)*2);
        else { ctx.fillStyle = '#ff4444'; ctx.beginPath(); ctx.arc(o.x,o.y,o.r,0,Math.PI*2); ctx.fill(); }
      }
      // bananas / bonus items
      for (const b of bananas) {
        if (b.img) ctx.drawImage(b.img, b.x - (b.r||32), b.y - (b.r||32), (b.r||32)*2, (b.r||32)*2);
        else { ctx.fillStyle = '#facc15'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); }
      }
      // draw boss if present (with small vibration)
      if (bossActive && bossSpawned && bossObject && bossObject.img) {
        const vib = Math.sin(performance.now()/100)*4;
        ctx.drawImage(bossObject.img, bossObject.x + vib, bossObject.y, bossObject.w, bossObject.h);
      }
      // ground
      for (let s of sueloScroll) {
        if (IMG.suelo) ctx.drawImage(IMG.suelo, s.x, WORLD.h - GROUND_H, WORLD.w, GROUND_H);
        else { ctx.fillStyle='#4ade80'; ctx.fillRect(s.x, WORLD.h-GROUND_H, WORLD.w, GROUND_H); }
      }
      // particles
      for (const p of particles) {
        ctx.fillStyle = p.color + Math.max(0,p.life) + ")";
        ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill();
      }
      // aura / pulse effect under player
      const pulse = 0.6 + 0.2 * Math.sin(performance.now()/300);
      ctx.fillStyle = `rgba(255,255,255,${0.25*pulse})`;
      ctx.beginPath(); ctx.arc(player.x, player.y, 60, 0, Math.PI*2); ctx.fill();
      // erizo sprite (use state if available)
      let erizoImg = IMG.erizo.calmado;
      if (player.state === 'inhalando' && IMG.erizo.inhalando) erizoImg = IMG.erizo.inhalando;
      if (player.state === 'gritando' && IMG.erizo.gritando) erizoImg = IMG.erizo.gritando;
      if (player.state === 'calmado' && Math.random()<0.001 && IMG.erizo.parpadeo) erizoImg = IMG.erizo.parpadeo; // occasional blink
      if (erizoImg) ctx.drawImage(erizoImg, player.x - player.r, player.y - player.r, player.r*2, player.r*2);
    }

    // --------------- GAME LOOP ---------------
    function frame(now) {
      const dt = Math.min(0.033, (now - lastFrame)/1000);
      lastFrame = now;
      if (!gameOver) update(dt);
      draw();
      loopId = requestAnimationFrame(frame);
    }

    // --------------- HELPERS: boss fire ---------------
    function bossFire() {
      if (!bossObject) return;
      // spawn foam projectile that moves leftwards
      const img = IMG.boss.espumas[Math.floor(Math.random()*IMG.boss.espumas.length)];
      const y = bossObject.y + 30 + Math.random()*(bossObject.h - 60);
      obstacles.push({ x: bossObject.x - 20, y, r:36, speed: 320 + Math.random()*60, img, kind:'foam' });
    }

    // --------------- BUTTON HANDLERS ---------------
    btnStart.addEventListener('click', () => {
      menuPanel.classList.remove('show');
      resetGameState();
      playMusic(MUSIC.base);
      lastFrame = performance.now();
      requestAnimationFrame(frame);
    });

    btnRestart.addEventListener('click', () => {
      // small pause to let player digest
      panel.classList.remove('show');
      setTimeout(()=>{
        // if died in boss and we want to restart inside boss, respawn boss state - for now restart full run but preserve TEST_MODE conditions
        resetGameState();
        playMusic(MUSIC.base);
        lastFrame = performance.now();
        requestAnimationFrame(frame);
      }, 900);
    });

    // --------------- PRELOAD & START ---------------
    // rotate loader image
    (function pickLoader(){
      const list = ASSETS.loaders;
      const pick = list[Math.floor(Math.random()*list.length)];
      loaderImg.src = pick;
    })();

    await loadAll();
    // init clouds and canvas fit
    initClouds();
    fit();

    // hide loader after short time (giving assets time)
    setTimeout(()=> { loader.style.display = 'none'; }, 800);

    // set best display
    bestEl.textContent = "Mejor: " + POINTS.best;
    menuBest.textContent = "Mejor puntuaciÃ³n: " + POINTS.best;

    // start paused on menu; user presses "Jugar"

    // --------------- Clean up / On Exit ---------------
    // Save best on unload
    window.addEventListener('beforeunload', () => {
      localStorage.setItem('bestScore', String(POINTS.best));
    });

    // Ensure music stops if tab hidden (to avoid weird autoplay)
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) { for (let k in MUSIC) MUSIC[k].pause(); }
    });

    // --------------- NOTES ---------------
    // - TEST_MODE true sets boss threshold low for easier testing
    // - Boss uses assets in assets/boss/ (pasta_feroz.png, espuma_boss*.png, cuidado_espuma.png, 1.png..10.png)
    // - Bonus uses patito1.png and patito2.png in assets/boss/
    // - Replace sounds if you want different ones; volumes are lowered for grito and recolectar
    // - If you want 'restart stays in boss' behavior, we can modify restart handler to re-init boss instead of full reset
  })();
  </script>
</body>
</html>
