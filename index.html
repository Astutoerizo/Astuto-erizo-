<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Astuto Erizo - Respira y Grita</title>
<style>
html,body{margin:0;height:100%;background:#0e0e10;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden}
canvas{background:#1b1b1f;display:block;touch-action:none}
#wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
.hud{position:fixed;top:8px;left:50%;transform:translateX(-50%);width:min(92vw,540px);pointer-events:none;display:flex;align-items:center;gap:12px;justify-content:space-between;font-weight:600}
.bar{flex:1;height:14px;background:#3a3a44;border-radius:999px;overflow:hidden;border:2px solid #6ee7b7;box-shadow:0 0 6px rgba(110,231,183,0.6) inset}
.fill{height:100%;width:0%;background:#86efac;transition:width .08s linear}
.cooldown{opacity:.45}
.score{min-width:100px;text-align:right}
.hud-btn{pointer-events:auto;cursor:pointer;padding:4px 8px;background:#24242a;border-radius:6px;font-size:13px}
.panel{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);transition:opacity .2s ease}
.panel.show{display:flex;opacity:1;pointer-events:auto}
.card{background:#1e1e24;border:1px solid #333;border-radius:16px;padding:20px;width:min(92vw,420px);text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.btn{display:inline-block;margin-top:12px;padding:10px 16px;border-radius:12px;background:#6ee7b7;color:#0b0b0d;font-weight:700;cursor:pointer}
#countdown{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);z-index:999}
#countdown.show{display:flex}
#countdown img{max-width:60%;animation:zoomIn .6s ease}
@keyframes zoomIn{from{transform:scale(.5);opacity:0}to{transform:scale(1);opacity:1}}
#loader{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#0e0e10;z-index:2000}
#loader img{max-width:200px;animation:float 1.8s ease-in-out infinite}
#loader p{margin-top:12px;font-size:18px;color:#6ee7b7;font-weight:bold;animation:blink 1.2s infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-18px)}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.canvas-shake{transition:transform .08s;will-change:transform}
#flash{position:fixed;inset:0;background:#fff;opacity:0;pointer-events:none;transition:opacity .12s linear;z-index:1500}
#bossCount{position:fixed;top:10px;left:10px;z-index:1100;display:none}
#bossCount img{width:64px;height:64px}
.poster{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:1200}
.poster img{max-width:60%;height:auto}
.poster.bonus img{max-width:45%}
</style>
</head>
<body>
<div id="loader">
  <img id="loaderImg" src="assets/loader.png" alt="Cargando...">
  <p>Loading...</p>
</div>

<div id="wrap"><canvas id="game" width="540" height="960"></canvas></div>
<div class="hud">
  <div class="bar"><div class="fill" id="zenFill"></div></div>
  <div class="score" id="score">Puntos: 0</div>
  <div class="score" id="bestScore">Mejor: 0</div>
  <div class="hud-btn" id="btnMusic">ðŸ”Š</div>
</div>

<div class="panel" id="panel">
  <div class="card">
    <h2>Astuto Erizo</h2>
    <p id="panelMsg">Has gritado al vacÃ­o zenâ€¦</p>
    <div class="btn" id="btnRestart">Reintentar</div>
  </div>
</div>

<div class="panel show" id="menuPanel">
  <div class="card">
    <img src="assets/logo_videojuego.png" style="max-width:260px;margin-bottom:12px">
    <h2>Respira y Grita</h2>
    <p id="menuBest">Mejor puntuaciÃ³n: 0</p>
    <div class="btn" id="btnStart">Jugar</div>
  </div>
</div>

<div id="countdown"><div id="countNum"></div></div>
<div id="bossCount"><img id="bossCountImg" src=""></div>
<div id="flash"></div>

<script>
(function(){
const TEST_MODE=true;
const TEST_BOSS_AT=5,TEST_BONUS_AT=20;
const BOSS_DURATION=10,BONUS_DURATION=8;
const WORLD={w:540,h:960},GROUND_H=180,MAX_PLAYER_TOP=80;
const PHYS={gravity:600,inhaleForce:-1400,maxVy:500};
const SPEED={scroll:280,inc:20,max:520};
const CHARGE={value:0,rate:60,max:100,over:85,cooldown:0,cooldownBase:1};
const PULSE={base:120,max:380,life:0.25};
const POINTS={total:0,best:parseInt(localStorage.getItem('bestScore')||'0')};
let stage='normal',stageTimer=0,bossObj=null,bossSpawned=false,bonusSpawned=false,gameOver=false;

const SFX={grito:'assets/sonido_bowl_limpio.mp3',recolectar:'assets/sonido_recolectar_platano.mp3',inhalar:'assets/sonido_inhalar.mp3',chocar:'assets/sonido_chocar.mp3',woosh:'assets/woosh.mp3',gong:'assets/gong.mp3'};
const MUSIC_FILES={base:'assets/musica_base.mp3',bonus:'assets/musica_bonus.mp3',boss:'assets/musica_boss.mp3'};
const MUSIC={base:new Audio(MUSIC_FILES.base),bonus:new Audio(MUSIC_FILES.bonus),boss:new Audio(MUSIC_FILES.boss)};
for(let k in MUSIC){MUSIC[k].loop=true;MUSIC[k].volume=0.45;}
let currentMusic=MUSIC.base,musicEnabled=true,allowSfx=true;
function playMusic(m){if(!musicEnabled)return;if(currentMusic!==m){currentMusic.pause();currentMusic.currentTime=0;}currentMusic=m;currentMusic.play().catch(()=>{});}
function stopMusic(){currentMusic.pause();currentMusic.currentTime=0;}
function playSfx(n,v=1){if(!allowSfx)return;const a=new Audio(SFX[n]);a.volume=v;a.play().catch(()=>{});}

const c=document.getElementById('game'),ctx=c.getContext('2d');
const zenFill=document.getElementById('zenFill'),scoreEl=document.getElementById('score'),bestEl=document.getElementById('bestScore');
const menuBest=document.getElementById('menuBest'),panel=document.getElementById('panel'),panelMsg=document.getElementById('panelMsg');
const btnStart=document.getElementById('btnStart'),btnRestart=document.getElementById('btnRestart');
const countdown=document.getElementById('countdown'),countNum=document.getElementById('countNum');
const bossCount=document.getElementById('bossCount'),bossCountImg=document.getElementById('bossCountImg');
const flash=document.getElementById('flash'),loader=document.getElementById('loader'),loaderImg=document.getElementById('loaderImg');
const menuPanel=document.getElementById('menuPanel');

let scale=1,ox=0,oy=0;function fit(){const vw=innerWidth,vh=innerHeight;scale=Math.min(vw/WORLD.w,vh/WORLD.h);ox=(vw-WORLD.w*scale)/2;oy=(vh-WORLD.h*scale)/2;c.style.width=WORLD.w*scale+'px';c.style.height=WORLD.h*scale+'px';}
addEventListener('resize',fit);fit();

const player={x:140,y:WORLD.h-260,r:44,vy:0,state:'calmado'};
const obstacles=[],collect=[],CLOUD=[],suelo=[{x:0},{x:WORLD.w}];
const rand=(a,b)=>a+Math.random()*(b-a);
function dist2(ax,ay,bx,by){let dx=ax-bx,dy=ay-by;return dx*dx+dy*dy;}

const IMG={erizo:{},fondos:{},boss:{espuma:[]},bonus:{patitos:[]}};
function loadImage(s){return new Promise(r=>{let i=new Image();i.onload=()=>r(i);i.onerror=()=>r(null);i.src=s;});}
async function loadAll(){
IMG.erizo.calmado=await loadImage('assets/calmado.png');
IMG.erizo.inhalando=await loadImage('assets/respirando.png');
IMG.erizo.gritando=await loadImage('assets/gritando.png');
IMG.erizo.parpadeo=await loadImage('assets/erizo_parpadeo.png');
IMG.fondos.calc=await loadImage('assets/fondo_calc.png');
IMG.fondos.desierto=await loadImage('assets/fondo_desierto.png');
IMG.fondos.helado=await loadImage('assets/fondo_helado.png');
IMG.fondos.bonus=await loadImage('assets/bonus/fondo_bonus.png');
IMG.obstaculo1=await loadImage('assets/paraguas.png');
IMG.obstaculo2=await loadImage('assets/helado_meditando.png');
IMG.platano=await loadImage('assets/platano_puntos.png');
IMG.cuenco=await loadImage('assets/cuenco_tibetano.png');
IMG.boss.sprite=await loadImage('assets/boss/pasta_feroz.png');
IMG.boss.poster=await loadImage('assets/boss/cuidado_espuma.png');
IMG.bonus.poster=await loadImage('assets/bonus/coge_todo.png');
IMG.bonus.patitos[0]=await loadImage('assets/bonus/patito1.png');
IMG.bonus.patitos[1]=await loadImage('assets/bonus/patito2.png');
for(let i=0;i<4;i++)IMG.boss.espuma[i]=await loadImage(`assets/boss/espuma_boss${i==0?'':i}.png`);
}

function showPoster(img,ms,bonus=false){return new Promise(r=>{const d=document.createElement('div');d.className='poster'+(bonus?' bonus':'');const im=document.createElement('img');im.src=img.src;d.appendChild(im);document.body.appendChild(d);setTimeout(()=>{document.body.removeChild(d);r();},ms);});}

function showBossTimer(s,onDone){bossCount.style.display='flex';let t=s;function tick(){if(t<=0){bossCount.style.display='none';if(onDone)onDone();return;}bossCountImg.src='assets/boss/'+t+'.png';t--;setTimeout(tick,1000);}tick();}

function startBoss(){stage='bossIntro';showPoster(IMG.boss.poster,2000).then(()=>{stage='boss';bossSpawned=true;currentBg=IMG.fondos.desierto;playMusic(MUSIC.boss);createBoss();showBossTimer(10,()=>{endBoss();});});}
function endBoss(){stage='normal';bossSpawned=false;bossObj=null;currentBg=IMG.fondos.calc;playMusic(MUSIC.base);}
function startBonus(){stage='bonusIntro';showPoster(IMG.bonus.poster,2000,true).then(()=>{stage='bonus';bonusSpawned=true;currentBg=IMG.fondos.bonus;playMusic(MUSIC.base);});}
function endBonus(){stage='normal';bonusSpawned=false;currentBg=IMG.fondos.calc;}

function createBoss(){bossObj={x:WORLD.w+100,y:250,w:200,h:200,vx:-60,phase:'enter',osc:0,dir:-1};}
function updateBoss(dt){if(!bossObj)return;if(bossObj.phase==='enter'){bossObj.x+=bossObj.vx*dt;if(bossObj.x<WORLD.w-260){bossObj.phase='vibrate';}}else if(bossObj.phase==='vibrate'){bossObj.osc+=dt;if(bossObj.osc>1){bossObj.phase='move';bossObj.osc=0;}}else{bossObj.x+=bossObj.dir*60*dt;if(bossObj.x<WORLD.w-300)bossObj.dir=1;if(bossObj.x>WORLD.w-100)bossObj.dir=-1;if(Math.random()<0.02)shootFoam();}}
function shootFoam(){let img=IMG.boss.espuma[Math.floor(Math.random()*IMG.boss.espuma.length)];obstacles.push({x:bossObj.x+50,y:bossObj.y+100,r:25,vx:-rand(80,160),vy:rand(-100,50),isFoam:true,img});}

let currentBg=null;
function reset(){POINTS.total=0;stage='normal';currentBg=IMG.fondos.calc;bossObj=null;bossSpawned=false;bonusSpawned=false;obstacles.length=collect.length=0;player.y=WORLD.h-200;player.vy=0;player.state='calmado';gameOver=false;allowSfx=true;playMusic(MUSIC.base);}
btnRestart.onclick=()=>{panel.classList.remove('show');setTimeout(()=>{reset();},700);};

function doShake(){c.style.transform='translate(5px,0)';setTimeout(()=>c.style.transform='',120);}
function doFlash(){flash.style.opacity='0.9';setTimeout(()=>flash.style.opacity='0',100);}

let last=performance.now();
function loop(t){requestAnimationFrame(loop);let dt=(t-last)/1000;last=t;if(dt>0.033)dt=0.033;update(dt);draw();}
function update(dt){
if(gameOver)return;
if(stage==='normal'){if(POINTS.total>=TEST_BOSS_AT&&!bossSpawned)startBoss();else if(POINTS.total>=TEST_BONUS_AT&&!bonusSpawned)startBonus();}
if(stage==='boss'&&bossObj)updateBoss(dt);
if(stage==='bonus'&&Math.random()<0.03)spawnBonusItems();
for(let i=obstacles.length-1;i>=0;i--){let o=obstacles[i];if(o.vx){o.x+=o.vx*dt;o.y+=o.vy*dt;o.vy+=PHYS.gravity*dt*0.3;if(o.y>WORLD.h+100||o.x<-100)obstacles.splice(i,1);}else{o.x-=SPEED.scroll*dt;if(o.x<-120)obstacles.splice(i,1);}}
for(let i=collect.length-1;i>=0;i--){let b=collect[i];b.x-=100*dt;if(b.x<-100)collect.splice(i,1);}
player.vy+=PHYS.gravity*dt;if(player.vy>PHYS.maxVy)player.vy=PHYS.maxVy;player.y+=player.vy*dt;if(player.y>WORLD.h-GROUND_H-50){player.y=WORLD.h-GROUND_H-50;player.vy=0;}
for(let o of obstacles){if(dist2(player.x,player.y,o.x,o.y)<(o.r+player.r)**2){panel.classList.add('show');gameOver=true;stopMusic();doFlash();doShake();}}
for(let i=collect.length-1;i>=0;i--){let b=collect[i];if(dist2(player.x,player.y,b.x,b.y)<(b.r+player.r)**2){if(b.kind==='cuenco'){POINTS.total+=5;}else if(b.kind==='patito2'){POINTS.total+=2;}else{POINTS.total+=1;}playSfx('recolectar',0.45);collect.splice(i,1);}}
scoreEl.textContent='Puntos: '+POINTS.total;if(POINTS.total>POINTS.best){POINTS.best=POINTS.total;localStorage.setItem('bestScore',POINTS.best);bestEl.textContent='Mejor: '+POINTS.best;}
}
function draw(){
ctx.clearRect(0,0,WORLD.w,WORLD.h);
if(currentBg)ctx.drawImage(currentBg,0,0,WORLD.w,WORLD.h);
for(let o of obstacles){if(o.isFoam)ctx.drawImage(o.img,o.x-o.r,o.y-o.r,o.r*2,o.r*2);}
if(stage==='boss'&&bossObj&&IMG.boss.sprite){let bx=bossObj.x+Math.sin(performance.now()/50)*5,by=bossObj.y;ctx.drawImage(IMG.boss.sprite,bx,by,bossObj.w,bossObj.h);}
for(let b of collect){let img=b.img||IMG.platano;ctx.drawImage(img,b.x-b.r,b.y-b.r,b.r*2,b.r*2);}
let er=IMG.erizo.calmado;if(Math.random()<0.01)er=IMG.erizo.parpadeo;ctx.drawImage(er,player.x-player.r,player.y-player.r,player.r*2,player.r*2);
}
function spawnBonusItems(){
let opt=['platano','cuenco','patito1','patito2'];let k=opt[Math.floor(Math.random()*opt.length)];
let img=k.startsWith('patito')?IMG.bonus.patitos[k==='patito1'?0:1]:k==='cuenco'?IMG.cuenco:IMG.platano;
collect.push({x:rand(60,WORLD.w-60),y:rand(180,WORLD.h-260),r:30,img,kind:k});
}
loadAll().then(()=>{setTimeout(()=>loader.style.display='none',800);btnStart.onclick=()=>{menuPanel.classList.remove('show');reset();requestAnimationFrame(loop);};playMusic(MUSIC.base);});
})();
</script>
</body>
</html>
