<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Astuto Erizo - Respira y Grita</title>
  <style>
    html, body { margin:0; height:100%; background:#0e0e10; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #wrap { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; }
    canvas { background:#1b1b1f; touch-action:none; }
    .hud {
      position: fixed; top: 8px; left: 50%; transform: translateX(-50%);
      width: min(92vw, 540px); pointer-events:none;
      display:flex; align-items:center; gap:12px; justify-content:space-between;
      font-weight:600;
    }
    .bar { flex:1; height:14px; background:#3a3a44; border-radius:999px; overflow:hidden; border:2px solid #6ee7b7; box-shadow:0 0 6px rgba(110,231,183,0.6) inset; }
    .fill { height:100%; width:0%; background:#86efac; transition: width .08s linear; }
    .cooldown { opacity:.45; }
    .score { min-width:120px; text-align:right; }
    .toast {
      position:fixed; bottom:14px; left:50%; transform:translateX(-50%);
      background:#24242a; border:1px solid #333; padding:8px 12px; border-radius:10px; font-size:14px; opacity:.9;
    }
    .panel {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.45); transition:opacity .2s ease;
    }
    .panel.show {
      display:flex;
      opacity:1;
      pointer-events:auto;
    }
    .card {
      background:#1e1e24; border:1px solid #333; border-radius:16px; padding:20px; width:min(92vw, 420px); text-align:center;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .btn {
      display:inline-block; margin-top:12px; padding:10px 16px; border-radius:12px; background:#6ee7b7; color:#0b0b0d;
      font-weight:700; cursor:pointer; user-select:none;
    }
    /* Overlay de cuenta atrás */
    #countdown {
      position: fixed; inset: 0;
      display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,.45); backdrop-filter: blur(2px);
      z-index: 999;
    }
    #countdown.show { display: flex; }
    #countdown #countNum img {
      max-width: 60%; height: auto;
      display: block; margin: 0 auto;
      animation: zoomIn 0.6s ease;
    }
    @keyframes zoomIn {
      from { transform: scale(0.5); opacity: 0; }
      to   { transform: scale(1);   opacity: 1; }
    }
    /* Loader */
    #loader {
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:#0e0e10;
      z-index:2000;
    }
    #loader img {
      max-width: 200px;
      animation: float 1.8s ease-in-out infinite;
    }
    @keyframes float {
      0%,100% { transform: translateY(0); }
      50%     { transform: translateY(-18px); }
    }
  </style>
</head>
<body>
  <div id="loader">
    <img id="loaderImg" src="assets/loader.png" alt="Cargando...">
  </div>

  <div id="wrap">
    <canvas id="game" width="540" height="960"></canvas>
  </div>

  <div class="hud">
    <div class="bar"><div class="fill" id="zenFill"></div></div>
    <div class="score" id="score">Puntos: 0</div>
  </div>

  <!-- Panel de game over -->
  <div class="panel" id="panel">
    <div class="card">
      <h2>Astuto Erizo</h2>
      <p id="panelMsg">Has gritado al vacío zen…</p>
      <div class="btn" id="btnRestart">Reintentar</div>
      <p style="opacity:.7; font-size:12px; margin-top:8px;">Mantén pulsado para inhalar · Suelta para gritar</p>
    </div>
  </div>

  <div class="toast" id="hint">Mantén pulsado para inhalar · Suelta para gritar</div>

  <!-- Panel de inicio -->
  <div class="panel show" id="menuPanel">
    <div class="card">
      <img src="assets/logo_videojuego.png" alt="Astuto Erizo" style="max-width: 280px; margin-bottom: 12px;">
      <h2>Respira y Grita</h2>
      <p>Cuando estés listo, pulsa jugar y respira profundo…</p>
      <div class="btn" id="btnStart">Jugar</div>
      <p style="opacity:.7; font-size:12px; margin-top:10px;">
        Mantén pulsado para inhalar · Suelta para gritar
      </p>
    </div>
  </div>

  <!-- Cuenta atrás -->
  <div id="countdown"><div id="countNum"></div></div>

  <script>
  (() => {
    // ======== CONFIG GENERAL =========
    const WORLD = { w: 540, h: 960 };
    const SPEED = { scroll: 280, inc: 20, max: 520 };
    const SPAWN = { interval: 1.2, min: 0.7, timer: 0, diffTimer: 0 };
    const CHARGE = { value:0, rate:60, max:100, over:85, cooldown:0, cooldownBase:1.0 };
    const PULSE  = { base:120, max:380, life:0.25 };
    const POINTS = { total:0 };
    const PHYSICS = { gravity: 600, inhaleForce: -900, maxVy: 500 };
    const GROUND_H = 180;

    let bgStage = 0;
    let currentBg = null;

    const CRASH_MESSAGES = [
      "El erizo se quedó sin aire… como tus plantas en agosto.",
      "Has gritado al vacío. El vacío gritó de vuelta.",
      "Chocaste contra la iluminación… pero era un helado.",
      "Tu zen se fue por el paraguas roto.",
      "El universo respondió con un plátano invisible.",
      "Erizo y obstáculo se fundieron en un abrazo incómodo.",
      "La serenidad se tropezó contigo.",
      "Has visto la luz... y duele.",
      "Un pato de goma presenció tu derrota."
    ];

    // ======== AUDIO =========
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const SFX = {
      grito: "assets/sonido_bowl_limpio.mp3",
      recolectar: "assets/sonido_recolectar_platano.mp3",
      inhalar: "assets/sonido_inhalar.mp3",
      chocar: "assets/sonido_chocar.mp3",
      woosh: "assets/woosh.mp3"
    };
    function playSfx(name, volume = 1.0) {
      const src = SFX[name]; if (!src) return;
      const a = new Audio(src); a.volume = volume;
      a.play().catch(()=>{});
    }

    // ======== ASSETS =========
    const ASSETS = {
      fondos: {
        calc: "assets/fondo_calc.png",
        desierto: "assets/fondo_desierto.png",
        helado: "assets/fondo_helado.png"
      },
      erizo: {
        calmado:   "assets/calmado.png",
        inhalando:"assets/respirando.png",
        gritando: "assets/gritando.png"
      },
      obstaculos: [
        "assets/paraguas.png",
        "assets/helado_meditando.png"
      ],
      banana: "assets/platano_puntos.png",
      suelo: "assets/suelo.png",
      cuenco: "assets/cuenco_tibetano.png",
      nubes: [
        "assets/nubes/nube1.png",
        "assets/nubes/nube2.png",
        "assets/nubes/nube3.png",
        "assets/nubes/nube4.png"
      ]
    };

    // ======== CANVAS & DOM =========
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const zenFill = document.getElementById('zenFill');
    const scoreEl = document.getElementById('score');
    const panel = document.getElementById('panel');
    const panelMsg = document.getElementById('panelMsg');
    const btnRestart = document.getElementById('btnRestart');
    const hint = document.getElementById('hint');

    // ======== ESTADO DE LOOP =========
    let lastFrame = performance.now();
    let loopId = null;
    let gameOver = false;

    // ======== LOOP =========
    function frame(now) {
      const dt = Math.min(0.033, (now - lastFrame) / 1000);
      lastFrame = now;

      if (!gameOver) {
        update(dt);
        draw();
        loopId = requestAnimationFrame(frame);
      } else {
        // En game over, solo se pinta el fondo limpio
        ctx.clearRect(0, 0, WORLD.w, WORLD.h);
        if (currentBg) ctx.drawImage(currentBg, 0, 0, WORLD.w, WORLD.h);
      }
    }

    // (el resto de tu código update, draw, reset se mantiene igual, solo eliminé el bloque que dibujaba nubes en gameOver)

    // ======== RESET / RESTART ========
    function reset() {
      POINTS.total = 0; CHARGE.value = 0; CHARGE.cooldown = 0;
      SPEED.scroll = 280; SPAWN.interval = 1.2; SPAWN.timer = 0; SPAWN.diffTimer = 0;
      obstacles.length = 0; bananas.length = 0; pulses.length = 0; particles.length = 0;
      player.y = WORLD.h - GROUND_H - player.r + 20;
      player.vy = 0; player.state = 'calmado'; player.mareo = 0;
      panel.classList.remove('show'); hint.style.display = '';
      bgStage = 0; currentBg = IMG.fondos.calc;
      initClouds();
      gameOver = false;
    }

    btnRestart.addEventListener('click', () => {
      reset();
      lastFrame = performance.now();
      requestAnimationFrame(frame);
    });

    // ======== GAME OVER en update =========
    // Dentro de update ya está la colisión → allí basta con: 
    // gameOver = true; cancelAnimationFrame(loopId);

    // ======== ARRANQUE =========
    loadAll().then(() => {
      const loader = document.getElementById('loader');
      const loaderImg = document.getElementById('loaderImg');
      const loaderImgs = ["assets/loader.png","assets/loader1.png","assets/loader2.png","assets/loader3.png"];
      loaderImg.src = loaderImgs[Math.floor(Math.random()*loaderImgs.length)];
      setTimeout(()=>{loader.style.display="none";},1800);

      const menuPanel = document.getElementById('menuPanel');
      const btnStart  = document.getElementById('btnStart');
      const countdownEl = document.getElementById('countdown');
      const countNum = document.getElementById('countNum');

      const COUNTDOWN_IMAGES = [
        "assets/contador_arbol.png","assets/contador_calcetin.png","assets/contador_leche.png",
        "assets/contador_cuenco.png","assets/contador_antena.png","assets/contador_seta.png",
        "assets/contador_coche.png","assets/contador_lapiz.png","assets/contador_paraguas.png","assets/contador_helado.png"
      ];
      const COUNTDOWN_GO = "assets/contador_go.png";
      const COUNT_SFX = "assets/gong.mp3";

      function showCountdown(onDone) {
        let pool=[...COUNTDOWN_IMAGES];let seq=[];
        for(let i=0;i<3;i++){const idx=Math.floor(Math.random()*pool.length);seq.push(pool.splice(idx,1)[0]);}
        seq.push(COUNTDOWN_GO);
        let i=0;countdownEl.classList.add('show');
        function showNext(){
          if(i<seq.length){
            countNum.innerHTML=`<img src="${seq[i]}" alt="count">`;
            if(COUNT_SFX){const a=new Audio(COUNT_SFX);a.volume=0.7;a.play().catch(()=>{});}
            i++;setTimeout(showNext,1000);
          }else{
            countdownEl.classList.remove('show');
            if(typeof onDone==="function") onDone();
          }
        }
        showNext();
      }

      let started=false;
      function startGame(){
        if(started) return;
        started=true;
        reset();
        requestAnimationFrame(frame);
      }

      if(btnStart){
        btnStart.addEventListener('click',()=>{ menuPanel.classList.remove('show'); showCountdown(()=>{startGame();}); });
      }
    });
  })();
  </script>
</body>
</html>
