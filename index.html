<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Astuto Erizo - Respira y Grita</title>
  <style>
    html, body { margin:0; height:100%; background:#0e0e10; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; overflow:hidden; }
    #wrap { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; }
    canvas { background:#1b1b1f; touch-action:none; }

    /* HUD */
    .hud {
      position: fixed; top: 8px; left: 50%; transform: translateX(-50%);
      width: min(92vw, 540px); pointer-events:none;
      display:flex; align-items:center; gap:12px; justify-content:space-between;
      font-weight:600;
    }
    .bar { flex:1; height:14px; background:#3a3a44; border-radius:999px; overflow:hidden; border:2px solid #6ee7b7; box-shadow:0 0 6px rgba(110,231,183,0.6) inset; }
    .fill { height:100%; width:0%; background:#86efac; transition: width .08s linear; }
    .cooldown { opacity:.45; }
    .score { min-width:100px; text-align:right; }
    .hud-btn { pointer-events:auto; cursor:pointer; padding:4px 8px; background:#24242a; border-radius:6px; font-size:13px; }

    /* Toast */
    .toast {
      position:fixed; bottom:14px; left:50%; transform:translateX(-50%);
      background:#24242a; border:1px solid #333; padding:8px 12px; border-radius:10px; font-size:14px; opacity:.9;
    }

    /* Panels */
    .panel {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.45); transition:opacity .2s ease;
    }
    .panel.show { display:flex; opacity:1; pointer-events:auto; }
    .card {
      background:#1e1e24; border:1px solid #333; border-radius:16px; padding:20px; width:min(92vw, 420px); text-align:center;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .btn {
      display:inline-block; margin-top:12px; padding:10px 16px; border-radius:12px; background:#6ee7b7; color:#0b0b0d;
      font-weight:700; cursor:pointer; user-select:none;
    }

    /* Loader */
    #loader {
      position:fixed; inset:0;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      background:#0e0e10; z-index:2000;
    }
    #loader img { max-width: 200px; animation: float 1.8s ease-in-out infinite; }
    #loader p { margin-top: 12px; font-size: 18px; color: #6ee7b7; font-weight: bold; animation: blink 1.2s infinite; }
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-18px); } }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

    /* Countdown */
    #countdown { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); backdrop-filter:blur(2px); z-index:999; }
    #countdown.show { display:flex; }
    #countdown #countNum img { max-width:60%; height:auto; display:block; margin:0 auto; animation: zoomIn 0.6s ease; }
    @keyframes zoomIn { from { transform:scale(0.5); opacity:0; } to { transform:scale(1); opacity:1; } }

    /* Boss counter */
    #bossCounter {
      position:fixed; top:10px; left:10px;
      z-index:1200; display:none; width:60px; height:60px;
    }
    #bossCounter img { width:100%; height:100%; }

    /* Shake effect */
    .shake { animation: shake 0.4s ease; }
    @keyframes shake {
      0%,100% { transform: translate(0,0); }
      25% { transform: translate(5px,-3px); }
      50% { transform: translate(-5px,3px); }
      75% { transform: translate(3px,5px); }
    }

    /* Flash */
    #flash {
      position:fixed; inset:0; background:white; opacity:0; pointer-events:none; z-index:1500;
      transition:opacity 0.2s ease;
    }
  </style>
</head>
<body>
  <div id="loader">
    <img id="loaderImg" src="assets/loader.png" alt="Cargando...">
    <p>Loading...</p>
  </div>

  <div id="wrap"><canvas id="game" width="540" height="960"></canvas></div>
  <div id="flash"></div>

  <div class="hud">
    <div class="bar"><div class="fill" id="zenFill"></div></div>
    <div class="score" id="score">Puntos: 0</div>
    <div class="score" id="bestScore">Mejor: 0</div>
    <div class="hud-btn" id="btnMusic">🔊</div>
  </div>

  <div id="bossCounter"><img id="bossCountImg" src=""></div>

  <div class="panel" id="panel">
    <div class="card">
      <h2>Astuto Erizo</h2>
      <p id="panelMsg">Has gritado al vacío zen…</p>
      <div class="btn" id="btnRestart">Reintentar</div>
      <p style="opacity:.7; font-size:12px; margin-top:8px;">Mantén pulsado para inhalar · Suelta para gritar</p>
    </div>
  </div>

  <div class="toast" id="hint">Mantén pulsado para inhalar · Suelta para gritar</div>

  <div class="panel show" id="menuPanel">
    <div class="card">
      <img src="assets/logo_videojuego.png" alt="Astuto Erizo" style="max-width: 280px; margin-bottom: 12px;">
      <h2>Respira y Grita</h2>
      <p id="menuBest">Mejor puntuación: 0</p>
      <p>Cuando estés listo, pulsa jugar y respira profundo…</p>
      <div class="btn" id="btnStart">Jugar</div>
      <p style="opacity:.7; font-size:12px; margin-top:10px;">Mantén pulsado para inhalar · Suelta para gritar</p>
    </div>
  </div>

  <div id="countdown"><div id="countNum"></div></div>

<script>
(() => {
  // ===== CONFIG GENERAL =====
  const TEST_MODE = true; // <<< dejar en true para probar rápido
  const WORLD = { w:540, h:960 };
  const SPEED = { scroll:280, inc:20, max:520 };
  const SPAWN = { interval:1.2, min:0.7, timer:0, diffTimer:0 };
  const CHARGE = { value:0, rate:60, max:100, over:85, cooldown:0, cooldownBase:1.0 };
  const PULSE  = { base:120, max:380, life:0.25 };
  const POINTS = { total:0, best: parseInt(localStorage.getItem("bestScore")||"0") };
  const PHYSICS = { gravity:600, inhaleForce:-1150, maxVy:500 };
  const GROUND_H = 180;

  let bgStage=0, currentBg=null, gameOver=false, loopId=null;
  let isDown=false, justReleased=false, wasInhaling=false, inhaleSfxTimer=0;
  let lastFrame=0, inBoss=false, inBonus=false, bossTimer=0, bossObj=null, bossCounter=0;
  let bossFoamImgs=[], patitos=[];

  // ===== AUDIO =====
  const SFX={ grito:"assets/sonido_bowl_limpio.mp3", recolectar:"assets/sonido_recolectar_platano.mp3", inhalar:"assets/sonido_inhalar.mp3", chocar:"assets/sonido_chocar.mp3", woosh:"assets/woosh.mp3", gong:"assets/gong.mp3" };
  function playSfx(name,v=1){ const a=new Audio(SFX[name]); a.volume=v; a.play().catch(()=>{}); }

  const MUSIC={ base:new Audio("assets/musica_base.mp3"), bonus:new Audio("assets/musica_bonus.mp3"), boss:new Audio("assets/musica_boss.mp3") };
  for(let k in MUSIC){ MUSIC[k].loop=true; MUSIC[k].volume=0.4; }
  let currentMusic=MUSIC.base, musicEnabled=true;
  function playMusic(track){ if(!musicEnabled)return; if(currentMusic)currentMusic.pause(); currentMusic=track; currentMusic.currentTime=0; currentMusic.play().catch(()=>{});}
  function toggleMusic(){ musicEnabled=!musicEnabled; if(musicEnabled){ playMusic(currentMusic); btnMusic.textContent="🔊";} else { if(currentMusic)currentMusic.pause(); btnMusic.textContent="🔇";}}

  // ===== ASSETS =====
  const ASSETS={ fondos:{calc:"assets/fondo_calc.png", desierto:"assets/fondo_desierto.png", helado:"assets/fondo_helado.png"}, erizo:{calmado:"assets/calmado.png", inhalando:"assets/respirando.png", gritando:"assets/gritando.png", parpadeo:"assets/erizo_parpadeo.png"}, obstaculos:["assets/paraguas.png","assets/helado_meditando.png"], banana:"assets/platano_puntos.png", suelo:"assets/suelo.png", cuenco:"assets/cuenco_tibetano.png", nubes:["assets/nubes/nube1.png","assets/nubes/nube2.png","assets/nubes/nube3.png","assets/nubes/nube4.png"], boss:{pasta:"assets/boss/pasta_feroz.png", foam:["assets/boss/espuma_boss.png","assets/boss/espuma_boss1.png","assets/boss/espuma_boss2.png","assets/boss/espuma_boss3.png"], warning:"assets/boss/cuidado_espuma.png"}, bonus:{patitos:["assets/boss/patito1.png","assets/boss/patito2.png"]} };

  const canvas=document.getElementById("game"), ctx=canvas.getContext("2d");
  const scoreEl=document.getElementById("score"), bestScoreEl=document.getElementById("bestScore"), menuBestEl=document.getElementById("menuBest");
  const zenFill=document.getElementById("zenFill"), btnMusic=document.getElementById("btnMusic");
  const flash=document.getElementById("flash");
  const panel=document.getElementById("panel"), panelMsg=document.getElementById("panelMsg"), btnRestart=document.getElementById("btnRestart"), hint=document.getElementById("hint"), menuPanel=document.getElementById("menuPanel"), btnStart=document.getElementById("btnStart"), countdownEl=document.getElementById("countdown"), countNum=document.getElementById("countNum");
  const bossCounterEl=document.getElementById("bossCounter"), bossCountImg=document.getElementById("bossCountImg");

  function flashScreen(){ flash.style.opacity=0.6; setTimeout(()=>flash.style.opacity=0,180);}
  function shakeScreen(){ canvas.classList.add("shake"); setTimeout(()=>canvas.classList.remove("shake"),400); }

  // === IMÁGENES ===
  const IMG={fondos:{},erizo:{},obstaculos:[],banana:null,suelo:null,cuenco:null,nubes:[],boss:{pasta:null,foam:[],warning:null},bonus:{patitos:[]}};

  function loadImage(s){return new Promise(res=>{const i=new Image();i.onload=()=>res(i);i.onerror=()=>res(null);i.src=s;});}

  async function loadAll(){
    IMG.fondos.calc=await loadImage(ASSETS.fondos.calc);
    IMG.fondos.desierto=await loadImage(ASSETS.fondos.desierto);
    IMG.fondos.helado=await loadImage(ASSETS.fondos.helado);
    currentBg=IMG.fondos.calc;
    IMG.erizo.calmado=await loadImage(ASSETS.erizo.calmado);
    IMG.erizo.inhalando=await loadImage(ASSETS.erizo.inhalando);
    IMG.erizo.gritando=await loadImage(ASSETS.erizo.gritando);
    IMG.erizo.parpadeo=await loadImage(ASSETS.erizo.parpadeo);
    for(let s of ASSETS.obstaculos) IMG.obstaculos.push(await loadImage(s));
    IMG.banana=await loadImage(ASSETS.banana);
    IMG.suelo=await loadImage(ASSETS.suelo);
    IMG.cuenco=await loadImage(ASSETS.cuenco);
    for(let s of ASSETS.nubes) IMG.nubes.push(await loadImage(s));
    IMG.boss.pasta=await loadImage(ASSETS.boss.pasta);
    for(let s of ASSETS.boss.foam) IMG.boss.foam.push(await loadImage(s));
    IMG.boss.warning=await loadImage(ASSETS.boss.warning);
    for(let s of ASSETS.bonus.patitos) IMG.bonus.patitos.push(await loadImage(s));
  }

  function rand(a,b){return a+Math.random()*(b-a);}
  function dist2(ax,ay,bx,by){const dx=ax-bx,dy=ay-by;return dx*dx+dy*dy;}

  // === ESTADO ===
  const player={x:140,y:WORLD.h-300,vy:0,r:50,state:"calmado",mareo:0};
  const sueloScroll=[{x:0},{x:WORLD.w}], obstacles=[], bananas=[], pulses=[], CLOUD={list:[]}, foams=[], bonusObjs=[];

  function initClouds(){ CLOUD.list=[]; for(let i=0;i<10;i++){ CLOUD.list.push({x:rand(0,WORLD.w),y:rand(50,WORLD.h/2),w:rand(80,180),h:rand(50,100),speed:20+Math.floor(rand(0,3))*40,img:IMG.nubes[Math.floor(rand(0,IMG.nubes.length))]});}}

  // === RESET ===
  function reset(){ POINTS.total=0; CHARGE.value=0; CHARGE.cooldown=0; SPEED.scroll=280; SPAWN.interval=1.2; SPAWN.timer=0; SPAWN.diffTimer=0; obstacles.length=bananas.length=pulses.length=foams.length=bonusObjs.length=0; player.y=WORLD.h-GROUND_H-player.r+20; player.vy=0; player.state="calmado"; bgStage=0; currentBg=IMG.fondos.calc; inBoss=false; inBonus=false; bossTimer=0; bossObj=null; bossCounter=0; bossCounterEl.style.display="none"; initClouds(); panel.classList.remove("show"); hint.style.display=""; gameOver=false; playMusic(MUSIC.base); }

  // === GAME OVER ===
  function onGameOver(){ gameOver=true; playSfx("chocar",0.35); shakeScreen(); if(POINTS.total>POINTS.best){ POINTS.best=POINTS.total; localStorage.setItem("bestScore",POINTS.best);} panel.classList.add("show"); }

  // === LOGICA ===
  function spawnObstacle(){ const y=rand(240,WORLD.h-180), r=rand(44,70); obstacles.push({x:WORLD.w+60,y,r,kind:Math.floor(rand(0,IMG.obstaculos.length))}); if(Math.random()<0.3) bananas.push({x:WORLD.w+100,y:rand(220,WORLD.h-200),r:44,kind:"banana"}); if(Math.random()<0.1) bananas.push({x:WORLD.w+150,y:rand(220,WORLD.h-200),r:44,kind:"cuenco"}); }

  // === LOOP ===
  function update(dt){
    // --- Cambio de fase ---
    const bossStart = TEST_MODE ? 5 : 50;
    const bonusStart = TEST_MODE ? 20 : 75;

    if(!inBoss && !inBonus && POINTS.total>=bossStart){ startBossPhase(); return; }
    if(!inBonus && !inBoss && POINTS.total>=bonusStart){ startBonusPhase(); return; }

    // Fondo
    for(let s of sueloScroll){ s.x-=SPEED.scroll*dt; if(s.x<=-WORLD.w) s.x+=WORLD.w*2;}
    for(const c of CLOUD.list){ c.x-=c.speed*dt; if(c.x+c.w<0){ c.x=WORLD.w+rand(10,100); c.y=rand(50,WORLD.h/2); c.img=IMG.nubes[Math.floor(rand(0,IMG.nubes.length))];}}

    SPAWN.timer+=dt; if(SPAWN.timer>=SPAWN.interval){ SPAWN.timer=0; spawnObstacle(); }
    if(isDown && CHARGE.cooldown<=0){ player.state="inhalando"; player.vy+=PHYSICS.inhaleForce*dt; CHARGE.value=Math.min(CHARGE.max,CHARGE.value+CHARGE.rate*dt); if(!wasInhaling) playSfx("inhalar",0.25);}
    wasInhaling=isDown;

    player.vy+=PHYSICS.gravity*dt; if(player.vy>PHYSICS.maxVy) player.vy=PHYSICS.maxVy; player.y+=player.vy*dt;
    const sueloTop=WORLD.h-GROUND_H-player.r; if(player.y>sueloTop) player.y=sueloTop; if(player.y<100) player.y=100;

    if(justReleased){ justReleased=false; if(CHARGE.value>CHARGE.over){ CHARGE.cooldown=0.7; CHARGE.value=0; player.state="gritando"; playSfx("grito",0.35); pulses.push({x:player.x+40,y:player.y,rad:PULSE.max,life:PULSE.life}); flashScreen(); } else { const rad=PULSE.base+(CHARGE.value/CHARGE.max)*(PULSE.max-PULSE.base); pulses.push({x:player.x+40,y:player.y,rad,life:PULSE.life}); playSfx("grito",0.35);} }

    for(let i=pulses.length-1;i>=0;i--){ const p=pulses[i]; p.life-=dt; if(p.life<=0){pulses.splice(i,1);continue;} for(let j=obstacles.length-1;j>=0;j--){ const o=obstacles[j]; if(dist2(p.x,p.y,o.x,o.y)<=(p.rad+o.r)**2){ obstacles.splice(j,1); POINTS.total+=2; playSfx("recolectar",0.3);}}}
    for(let i=obstacles.length-1;i>=0;i--){ const o=obstacles[i]; o.x-=SPEED.scroll*dt; if(o.x<-120) obstacles.splice(i,1); if(dist2(o.x,o.y,player.x,player.y)<=(o.r+player.r)**2){ onGameOver(); cancelAnimationFrame(loopId); return; }}
    for(let i=bananas.length-1;i>=0;i--){ const b=bananas[i]; b.x-=SPEED.scroll*dt; if(b.x<-120) bananas.splice(i,1); if(dist2(b.x,b.y,player.x,player.y)<=(b.r+player.r)**2){ bananas.splice(i,1); POINTS.total+=b.kind==="cuenco"?5:1; playSfx("recolectar",0.3);} }

    scoreEl.textContent="Puntos: "+POINTS.total;
    zenFill.style.width=(CHARGE.value/CHARGE.max)*100+"%";
  }

  function draw(){
    ctx.clearRect(0,0,WORLD.w,WORLD.h);
    if(currentBg) ctx.drawImage(currentBg,0,0,WORLD.w,WORLD.h);
    for(const c of CLOUD.list) ctx.drawImage(c.img,c.x,c.y,c.w,c.h);
    for(const b of bananas) ctx.drawImage(b.kind==="cuenco"?IMG.cuenco:IMG.banana,b.x-b.r,b.y-b.r,b.r*2,b.r*2);
    for(const o of obstacles) ctx.drawImage(IMG.obstaculos[o.kind],o.x-o.r,o.y-o.r,o.r*2,o.r*2);
    for(const p of pulses){ const a=p.life/PULSE.life; ctx.strokeStyle=`rgba(99,102,241,${a})`; ctx.lineWidth=6; ctx.beginPath(); ctx.arc(p.x,p.y,p.rad,0,Math.PI*2); ctx.stroke();}
    for(const s of sueloScroll) ctx.drawImage(IMG.suelo,s.x,WORLD.h-GROUND_H,WORLD.w,GROUND_H);
    const im=player.state==="calmado"&&Math.random()<0.005?IMG.erizo.parpadeo:IMG.erizo[player.state]||IMG.erizo.calmado;
    ctx.drawImage(im,player.x-player.r,player.y-player.r,player.r*2,player.r*2);
  }

  function frame(ts){ const dt=(ts-lastFrame)/1000; lastFrame=ts; if(!gameOver) update(dt); draw(); loopId=requestAnimationFrame(frame); }

  // === BOSS PHASE ===
  function startBossPhase(){
    inBoss=true; currentBg=IMG.fondos.desierto; playMusic(MUSIC.boss);
    ctx.drawImage(IMG.boss.warning, WORLD.w/2-120, WORLD.h/2-100,240,200);
    setTimeout(()=>{
      bossObj={x:WORLD.w-250,y:WORLD.h-400,w:200,h:200,t:0};
      bossFoamImgs=IMG.boss.foam;
      bossTimer=10; bossCounter=10; updateBossCounter();
      bossCounterEl.style.display="block";
      const interval=setInterval(()=>{
        bossTimer--; bossCounter--; updateBossCounter();
        if(bossTimer<=0){ clearInterval(interval); endBossPhase(); }
      },1000);
    },2000);
  }

  function updateBossCounter(){ bossCountImg.src=`assets/boss/${bossCounter}.png`; }

  function endBossPhase(){ inBoss=false; currentBg=IMG.fondos.calc; playMusic(MUSIC.base); bossCounterEl.style.display="none"; }

  // === START ===
  function showCountdown(cb){ const imgs=["assets/contador_arbol.png","assets/contador_calcetin.png","assets/contador_leche.png","assets/contador_cuenco.png","assets/contador_antena.png","assets/contador_seta.png","assets/contador_coche.png","assets/contador_lapiz.png","assets/contador_paraguas.png","assets/contador_helado.png"]; const go="assets/contador_go.png"; let pool=[...imgs],seq=[]; for(let i=0;i<3;i++){const idx=Math.floor(Math.random()*pool.length); seq.push(pool.splice(idx,1)[0]);} seq.push(go); let i=0; countdownEl.classList.add("show"); function step(){ if(i<seq.length){ countNum.innerHTML=`<img src="${seq[i]}">`; playSfx("gong",0.7); i++; setTimeout(step,1000);} else { countdownEl.classList.remove("show"); cb();}} step(); }

  loadAll().then(()=>{ document.getElementById("loader").style.display="none"; btnStart.addEventListener("click",()=>{ menuPanel.classList.remove("show"); showCountdown(()=>{ reset(); lastFrame=performance.now(); requestAnimationFrame(frame); });}); });
  canvas.addEventListener("pointerdown",()=>isDown=true); canvas.addEventListener("pointerup",()=>{isDown=false; justReleased=true;});
  btnRestart.addEventListener("click",()=>{reset(); lastFrame=performance.now(); requestAnimationFrame(frame);});
})();
</script>
</body>
</html>
