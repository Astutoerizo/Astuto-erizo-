<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Astuto Erizo - Respira y Grita</title>
  <style>
    html, body { margin:0; height:100%; background:#0e0e10; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; overflow:hidden; }
    #wrap { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; }
    canvas { background:#1b1b1f; touch-action:none; }
    .hud {
      position: fixed; top: 8px; left: 50%; transform: translateX(-50%);
      width: min(92vw, 540px); pointer-events:none;
      display:flex; align-items:center; gap:12px; justify-content:space-between;
      font-weight:600;
    }
    .bar { flex:1; height:14px; background:#3a3a44; border-radius:999px; overflow:hidden; border:2px solid #6ee7b7; box-shadow:0 0 6px rgba(110,231,183,0.6) inset; }
    .fill { height:100%; width:0%; background:#86efac; transition: width .08s linear; }
    .cooldown { opacity:.45; }
    .score { min-width:100px; text-align:right; }
    .hud-btn { pointer-events:auto; cursor:pointer; padding:4px 8px; background:#24242a; border-radius:6px; font-size:13px; }
    .toast {
      position:fixed; bottom:14px; left:50%; transform:translateX(-50%);
      background:#24242a; border:1px solid #333; padding:8px 12px; border-radius:10px; font-size:14px; opacity:.9;
    }
    .panel { position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.45); transition:opacity .2s ease; }
    .panel.show { display:flex; opacity:1; pointer-events:auto; }
    .card {
      background:#1e1e24; border:1px solid #333; border-radius:16px; padding:20px; width:min(92vw, 420px); text-align:center;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .btn { display:inline-block; margin-top:12px; padding:10px 16px; border-radius:12px; background:#6ee7b7; color:#0b0b0d;
      font-weight:700; cursor:pointer; user-select:none; }
    #countdown { position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,.45); backdrop-filter: blur(2px); z-index: 999; }
    #countdown.show { display: flex; }
    #countdown #countNum img { max-width: 60%; height: auto; display: block; margin: 0 auto; animation: zoomIn 0.6s ease; }
    @keyframes zoomIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    #loader {
      position:fixed; inset:0; display:flex; flex-direction:column;
      align-items:center; justify-content:center; background:#0e0e10; z-index:2000;
    }
    #loader img { max-width: 200px; animation: float 1.8s ease-in-out infinite; }
    #loader p { margin-top: 12px; font-size: 18px; color: #6ee7b7; font-weight: bold; animation: blink 1.2s infinite; }
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-18px); } }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    @keyframes flash { from { opacity: 1; } to { opacity: 0; } }
  </style>
</head>
<body>
  <div id="loader">
    <img id="loaderImg" src="assets/loader.png" alt="Cargando...">
    <p>Loading...</p>
  </div>

  <div id="wrap"><canvas id="game" width="540" height="960"></canvas></div>

  <div class="hud">
    <div class="bar"><div class="fill" id="zenFill"></div></div>
    <div class="score" id="score">Puntos: 0</div>
    <div class="score" id="bestScore">Mejor: 0</div>
    <div class="hud-btn" id="btnMusic">ðŸ”Š</div>
  </div>

  <div class="panel" id="panel">
    <div class="card">
      <h2>Astuto Erizo</h2>
      <p id="panelMsg">Has gritado al vacÃ­o zenâ€¦</p>
      <div class="btn" id="btnRestart">Reintentar</div>
      <p style="opacity:.7; font-size:12px; margin-top:8px;">MantÃ©n pulsado para inhalar Â· Suelta para gritar</p>
    </div>
  </div>

  <div class="toast" id="hint">MantÃ©n pulsado para inhalar Â· Suelta para gritar</div>

  <div class="panel show" id="menuPanel">
    <div class="card">
      <img src="assets/logo_videojuego.png" alt="Astuto Erizo" style="max-width: 280px; margin-bottom: 12px;">
      <h2>Respira y Grita</h2>
      <p id="menuBest">Mejor puntuaciÃ³n: 0</p>
      <p>Cuando estÃ©s listo, pulsa jugar y respira profundoâ€¦</p>
      <div class="btn" id="btnStart">Jugar</div>
      <p style="opacity:.7; font-size:12px; margin-top:10px;">MantÃ©n pulsado para inhalar Â· Suelta para gritar</p>
    </div>
  </div>

  <div id="countdown"><div id="countNum"></div></div>

  <script>
  (() => {
    const WORLD = { w: 540, h: 960 };
    const SPEED = { scroll: 280, inc: 20, max: 520 };
    const SPAWN = { interval: 1.2, min: 0.7, timer: 0, diffTimer: 0 };
    const CHARGE = { value:0, rate:60, max:100, over:85, cooldown:0, cooldownBase:1.0 };
    const PULSE  = { base:120, max:380, life:0.25 };
    const POINTS = { total:0, best: parseInt(localStorage.getItem("bestScore")||"0") };
    const PHYSICS = { gravity:600, inhaleForce:-1200, maxVy:500 };
    const GROUND_H = 180;

    let bgStage=0, currentBg=null, gameOver=false, loopId=null;
    let isDown=false, justReleased=false, wasInhaling=false, inhaleSfxTimer=0, lastFrame=0;
    let inBoss=false, inBonus=false, bossTimer=0, bonusTimer=0;
    let boss=null, espumas=[];

    // === Audio ===
    const SFX={grito:"assets/sonido_bowl_limpio.mp3", recolectar:"assets/sonido_recolectar_platano.mp3", inhalar:"assets/sonido_inhalar.mp3", chocar:"assets/sonido_chocar.mp3", woosh:"assets/woosh.mp3", gong:"assets/gong.mp3"};
    function playSfx(n,v=1){const a=new Audio(SFX[n]);a.volume=v;a.play().catch(()=>{});}
    const MUSIC={base:new Audio("assets/musica_base.mp3"), bonus:new Audio("assets/musica_bonus.mp3"), boss:new Audio("assets/musica_boss.mp3")};
    for(let k in MUSIC){MUSIC[k].loop=true;MUSIC[k].volume=0.45;}
    let currentMusic=MUSIC.base, musicEnabled=true;
    function playMusic(m){if(!musicEnabled)return;if(currentMusic)currentMusic.pause();currentMusic=m;m.play().catch(()=>{});}
    function toggleMusic(){musicEnabled=!musicEnabled;if(musicEnabled){playMusic(currentMusic);btnMusic.textContent="ðŸ”Š";}else{if(currentMusic)currentMusic.pause();btnMusic.textContent="ðŸ”‡";}}

    // === DOM ===
    const canvas=document.getElementById("game"),ctx=canvas.getContext("2d");
    const scoreEl=document.getElementById("score"),bestScoreEl=document.getElementById("bestScore"),menuBestEl=document.getElementById("menuBest");
    const zenFill=document.getElementById("zenFill"),btnMusic=document.getElementById("btnMusic");
    const panel=document.getElementById("panel"),panelMsg=document.getElementById("panelMsg"),btnRestart=document.getElementById("btnRestart");
    const hint=document.getElementById("hint"),menuPanel=document.getElementById("menuPanel"),btnStart=document.getElementById("btnStart");
    const countdownEl=document.getElementById("countdown"),countNum=document.getElementById("countNum");
    btnMusic.addEventListener("click",toggleMusic);

    function updateBest(){bestScoreEl.textContent="Mejor: "+POINTS.best;menuBestEl.textContent="Mejor puntuaciÃ³n: "+POINTS.best;}updateBest();

    // === Entities ===
    const player={x:140,y:WORLD.h-300,vy:0,r:50,state:"calmado",mareo:0};
    const sueloScroll=[{x:0},{x:WORLD.w}],obstacles=[],bananas=[],pulses=[],particles=[];
    const CLOUD={list:[]};

    const IMG={fondos:{},erizo:{},obstaculos:[],banana:null,suelo:null,cuenco:null,nubes:[],boss:{},bossUI:[]};
    function rand(a,b){return a+Math.random()*(b-a);}function chance(p){return Math.random()<p;}
    function dist2(ax,ay,bx,by){const dx=ax-bx,dy=ay-by;return dx*dx+dy*dy;}
    function loadImage(s){return new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.onerror=()=>r(null);i.src=s;});}
    async function loadAll(){
      IMG.fondos.calc=await loadImage("assets/fondo_calc.png");
      IMG.fondos.desierto=await loadImage("assets/fondo_desierto.png");
      IMG.fondos.helado=await loadImage("assets/fondo_helado.png");
      currentBg=IMG.fondos.calc;
      IMG.erizo.calmado=await loadImage("assets/calmado.png");
      IMG.erizo.inhalando=await loadImage("assets/respirando.png");
      IMG.erizo.gritando=await loadImage("assets/gritando.png");
      IMG.erizo.parpadeo=await loadImage("assets/erizo_parpadeo.png");
      IMG.banana=await loadImage("assets/platano_puntos.png");
      IMG.suelo=await loadImage("assets/suelo.png");
      IMG.cuenco=await loadImage("assets/cuenco_tibetano.png");
      for(let s of ["assets/nubes/nube1.png","assets/nubes/nube2.png","assets/nubes/nube3.png","assets/nubes/nube4.png"])IMG.nubes.push(await loadImage(s));
      for(let s of ["assets/paraguas.png","assets/helado_meditando.png"])IMG.obstaculos.push(await loadImage(s));
      IMG.boss.main=await loadImage("assets/boss/Pasta_feroz.png");
      for(let i=0;i<4;i++)IMG.boss["espuma"+i]=await loadImage(`assets/boss/espuma_boss${i===0?"":i}.png`);
      IMG.boss.alert=await loadImage("assets/boss/cuidado_espuma.png");
      for(let i=1;i<=10;i++)IMG.bossUI.push(await loadImage(`assets/boss/${i}.png`));
    }

    function initClouds(){CLOUD.list=[];for(let i=0;i<10;i++){CLOUD.list.push({x:rand(0,WORLD.w),y:rand(50,WORLD.h/2),w:rand(80,180),h:rand(50,100),speed:20+Math.floor(rand(0,3))*40,img:IMG.nubes[Math.floor(rand(0,IMG.nubes.length))]});}}

    function reset(){POINTS.total=0;CHARGE.value=0;CHARGE.cooldown=0;SPEED.scroll=280;SPAWN.interval=1.2;SPAWN.timer=SPAWN.diffTimer=0;obstacles.length=bananas.length=pulses.length=particles.length=0;player.y=WORLD.h-GROUND_H-player.r+20;player.vy=0;player.state="calmado";panel.classList.remove("show");hint.style.display="";bgStage=0;currentBg=IMG.fondos.calc;initClouds();gameOver=false;inBoss=false;inBonus=false;espumas=[];boss=null;}

    // === Update & Game logic ===
    function spawnObstacle(){const y=rand(240,WORLD.h-180),r=rand(44,70),sp=Math.min(SPEED.scroll+rand(0,60),SPEED.max);obstacles.push({x:WORLD.w+60,y,r,speed:sp,kind:Math.floor(rand(0,IMG.obstaculos.length))});
      if(chance(0.3))bananas.push({x:WORLD.w+100,y:rand(220,WORLD.h-200),r:44,speed:sp+40,kind:"banana"});
      if(chance(0.1))bananas.push({x:WORLD.w+150,y:rand(220,WORLD.h-200),r:44,speed:sp+20,kind:"cuenco"});}
    
    // --- Boss trigger (for testing at 5 pts)
    function triggerBoss(){
      inBoss=true;bossTimer=0;espumas=[];playMusic(MUSIC.boss);
    }

    // --- Bonus trigger (for testing at 20 pts)
    function triggerBonus(){
      inBonus=true;bonusTimer=0;playMusic(MUSIC.bonus);
      currentBg=IMG.fondos.helado;
    }

    function update(dt){
      if(gameOver)return;
      if(!inBoss && POINTS.total>=5){triggerBoss();}
      if(!inBonus && POINTS.total>=20){triggerBonus();}
      // Movement & physics same as before (truncated for brevity)
      player.vy+=PHYSICS.gravity*dt;
      if(isDown && CHARGE.cooldown<=0){player.vy+=PHYSICS.inhaleForce*1.2*dt;player.state="inhalando";playSfx("inhalar",0.25);}
      player.y+=player.vy*dt;if(player.y<100)player.y=100;if(player.y>WORLD.h-GROUND_H-player.r){player.y=WORLD.h-GROUND_H-player.r;player.vy=0;}
      if(justReleased){justReleased=false;pulses.push({x:player.x+40,y:player.y,rad:PULSE.base,life:PULSE.life});CHARGE.value=0;CHARGE.cooldown=0.7;player.state="gritando";playSfx("grito",0.35);}
      // Boss behavior
      if(inBoss){
        bossTimer+=dt;
        if(bossTimer<2){return;}
        if(!boss){boss={x:WORLD.w-200,y:300,timer:0};}
        boss.timer+=dt;
        if(boss.timer>0.8){boss.timer=0;espumas.push({x:boss.x-60,y:boss.y+rand(-40,60),r:40,speed:300,img:IMG.boss["espuma"+Math.floor(rand(0,4))]});}
        for(let e of espumas)e.x-=e.speed*dt;
        espumas=espumas.filter(e=>e.x>-60);
        if(bossTimer>=12){inBoss=false;playMusic(MUSIC.base);}
      }
      if(inBonus){
        bonusTimer+=dt;
        if(bonusTimer>=8){inBonus=false;currentBg=IMG.fondos.calc;playMusic(MUSIC.base);}
      }
    }

    function draw(){
      ctx.clearRect(0,0,WORLD.w,WORLD.h);
      if(currentBg)ctx.drawImage(currentBg,0,0,WORLD.w,WORLD.h);
      for(const c of CLOUD.list)ctx.drawImage(c.img,c.x,c.y,c.w,c.h);
      for(const o of obstacles)ctx.drawImage(IMG.obstaculos[o.kind],o.x-o.r,o.y-o.r,o.r*2,o.r*2);
      for(const b of bananas)ctx.drawImage(b.kind==="cuenco"?IMG.cuenco:IMG.banana,b.x-b.r,b.y-b.r,b.r*2,b.r*2);
      for(const p of pulses){ctx.strokeStyle="rgba(99,102,241,0.8)";ctx.lineWidth=6;ctx.beginPath();ctx.arc(p.x,p.y,p.rad,0,Math.PI*2);ctx.stroke();}
      for(const s of sueloScroll)ctx.drawImage(IMG.suelo,s.x,WORLD.h-GROUND_H,WORLD.w,GROUND_H);
      const im=player.state==="inhalando"?IMG.erizo.inhalando:player.state==="gritando"?IMG.erizo.gritando:IMG.erizo.calmado;
      ctx.drawImage(im,player.x-player.r,player.y-player.r,player.r*2,player.r*2);
      if(inBoss && boss){ctx.drawImage(IMG.boss.main,boss.x,250,180,180);for(let e of espumas)ctx.drawImage(e.img,e.x-e.r,e.y-e.r,e.r*2,e.r*2);}
    }

    function frame(ts){const dt=(ts-lastFrame)/1000;lastFrame=ts;update(dt);draw();loopId=requestAnimationFrame(frame);}
    btnRestart.addEventListener("click",()=>{reset();lastFrame=performance.now();requestAnimationFrame(frame);playMusic(MUSIC.base);});
    function showCountdown(cb){const imgs=["assets/contador_arbol.png","assets/contador_calcetin.png","assets/contador_leche.png"];const go="assets/contador_go.png";let seq=[...imgs,go],i=0;countdownEl.classList.add("show");function step(){if(i<seq.length){countNum.innerHTML=`<img src='${seq[i]}'>`;playSfx("gong",0.7);i++;setTimeout(step,1000);}else{countdownEl.classList.remove("show");cb();}}step();}
    loadAll().then(()=>{document.getElementById("loader").style.display="none";btnStart.addEventListener("click",()=>{menuPanel.classList.remove("show");showCountdown(()=>{reset();lastFrame=performance.now();playMusic(MUSIC.base);requestAnimationFrame(frame);});});});
    canvas.addEventListener("pointerdown",()=>isDown=true);canvas.addEventListener("pointerup",()=>{isDown=false;justReleased=true;});
  })();
  </script>
</body>
</html>
