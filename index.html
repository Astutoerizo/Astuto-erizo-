<!-- BLOCK 1/5 - DO NOT EDIT -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Astuto Erizo - Respira y Grita</title>
  <style>
    /* ===========================
       STYLES - UI + CANVAS
       =========================== */

    html, body {
      margin: 0;
      height: 100%;
      background: #0e0e10;
      color: #fff;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    #wrap {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
    }

    canvas {
      background: #1b1b1f;
      touch-action: none;
      display: block;
      image-rendering: optimizeQuality;
    }

    .hud {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: min(92vw, 720px);
      pointer-events: none;
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
      font-weight: 600;
      z-index: 1200;
    }

    .bar {
      flex: 1;
      height: 14px;
      background: #3a3a44;
      border-radius: 999px;
      overflow: hidden;
      border: 2px solid #6ee7b7;
      box-shadow: 0 0 6px rgba(110,231,183,0.6) inset;
    }

    .fill {
      height: 100%;
      width: 0%;
      background: #86efac;
      transition: width .08s linear;
    }

    .cooldown { opacity: .45; }

    .score { min-width: 100px; text-align: right; }

    .hud-btn {
      pointer-events: auto;
      cursor: pointer;
      padding: 6px 10px;
      background: #24242a;
      border-radius: 8px;
      font-size: 14px;
      user-select: none;
    }

    .toast {
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      background: #24242a;
      border: 1px solid #333;
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 14px;
      opacity: .95;
      z-index: 1200;
    }

    .panel {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,.45);
      transition: opacity .2s ease;
      z-index: 1300;
    }

    .panel.show {
      display: flex;
      opacity: 1;
      pointer-events: auto;
    }

    .card {
      background: #1e1e24;
      border: 1px solid #333;
      border-radius: 16px;
      padding: 20px;
      width: min(92vw, 420px);
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    .btn {
      display: inline-block;
      margin-top: 12px;
      padding: 10px 16px;
      border-radius: 12px;
      background: #6ee7b7;
      color: #0b0b0d;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      pointer-events: auto;
    }

    /* countdown / cartel */
    #countdown {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(2px);
      z-index: 2000;
    }
    #countdown.show { display: flex; }
    #countdown #countNum { font-weight: 900; letter-spacing: -0.03em; color: #fff; text-shadow: 0 6px 24px rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; }
    #countdown img { max-width: 60%; height: auto; display: block; margin: 0 auto; animation: zoomIn .6s ease; }
    @keyframes zoomIn { from { transform: scale(.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    /* loader */
    #loader {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #0e0e10;
      z-index: 3000;
    }
    #loader img { max-width: 220px; animation: float 1.8s ease-in-out infinite; display:block; }
    #loader p { margin-top: 12px; font-size: 18px; color: #6ee7b7; font-weight: 700; animation: blink 1.2s infinite; }
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-18px); } }
    @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

    /* shake + flash (for effects) */
    .shake { animation: shakeAnim .45s ease; }
    @keyframes shakeAnim { 0%{transform:none}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(4px)}100%{transform:none} }
    #flash { pointer-events:none; position: fixed; inset:0; background:#fff; opacity:0; transition: opacity .12s; z-index: 2500; }

    /* responsive tweaks for mobile */
    @media (max-width: 420px) {
      .card { width: 92vw; padding: 16px; }
      .hud { top: 6px; gap:8px; }
      .score { min-width: 80px; font-size: 13px; }
    }
  </style>
</head>
<body>
  <!-- Loader / spinner area -->
  <div id="loader">
    <img id="loaderImg" src="assets/loader.png" alt="Cargando...">
    <p>Loading...</p>
  </div>

  <!-- Game canvas -->
  <div id="wrap"><canvas id="game" width="540" height="960"></canvas></div>

  <!-- HUD -->
  <div class="hud">
    <div class="bar"><div class="fill" id="zenFill"></div></div>
    <div class="score" id="score">Puntos: 0</div>
    <div class="score" id="bestScore">Mejor: 0</div>
    <div class="hud-btn" id="btnMusic">🔊</div>
  </div>

  <!-- Game over panel -->
  <div class="panel" id="panel">
    <div class="card">
      <h2>Astuto Erizo</h2>
      <p id="panelMsg">Has gritado al vacío zen…</p>
      <div class="btn" id="btnRestart">Reintentar</div>
      <p style="opacity:.7;font-size:12px;margin-top:8px">Mantén pulsado para inhalar · Suelta para gritar</p>
    </div>
  </div>

  <!-- hint toast -->
  <div class="toast" id="hint">Mantén pulsado para inhalar · Suelta para gritar</div>

  <!-- Menu panel -->
  <div class="panel show" id="menuPanel">
    <div class="card">
      <img src="assets/logo_videojuego.png" alt="Astuto Erizo" style="max-width:320px;margin-bottom:12px;display:block;margin-left:auto;margin-right:auto;">
      <h2>Respira y Grita</h2>
      <p id="menuBest" style="margin:6px 0 12px 0">Mejor puntuación: 0</p>
      <p>Cuando estés listo, pulsa jugar y respira profundo…</p>
      <div class="btn" id="btnStart">Jugar</div>
      <p style="opacity:.7;font-size:12px;margin-top:10px">Mantén pulsado para inhalar · Suelta para gritar</p>
    </div>
  </div>

  <!-- Countdown / cartels -->
  <div id="countdown"><div id="countNum"></div></div>

  <!-- flash overlay -->
  <div id="flash"></div>

  <!-- ===========================
       SCRIPT START - PART 1/5
       (config, assets, loaders, utils)
       =========================== -->
  <script>
  (function () {
    'use strict';

    /* ===========================
       TEST MODE - helpful during development
       true = lower thresholds and debug keys enabled
       =========================== */
    const TEST_MODE = true;

    /* ======= WORLD & CONFIG ======= */
    const WORLD = { w: 540, h: 960 };
    const SPEED = { scroll: 280, inc: 20, max: 520 };
    const SPAWN = { interval: 1.2, min: 0.7, timer: 0, diffTimer: 0 };
    const CHARGE = { value: 0, rate: 60, max: 100, over: 85, cooldown: 0, cooldownBase: 1.0 };
    const PULSE = { base: 120, max: 380, life: 0.25 };
    const POINTS = { total: 0, best: parseInt(localStorage.getItem('bestScore') || '0', 10) || 0 };
    const PHYSICS = { gravity: 600, inhaleForce: -1400, maxVy: 900 }; // tuned for snappier ascent
    const GROUND_H = 180;

    // quick thresholds for testing; set to real values when ready
    const BOSS_SCORE_1 = TEST_MODE ? 5 : 50;
    const BONUS_SCORE_1 = TEST_MODE ? 10 : 75;
    const BOSS_DURATION = 10; // seconds for boss / bonus phases

    /* ======= DOM REFS ======= */
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const zenFill = document.getElementById('zenFill');
    const scoreEl = document.getElementById('score');
    const bestScoreEl = document.getElementById('bestScore');
    const menuBestEl = document.getElementById('menuBest');
    const panel = document.getElementById('panel');
    const panelMsg = document.getElementById('panelMsg');
    const btnRestart = document.getElementById('btnRestart');
    const hint = document.getElementById('hint');
    const menuPanel = document.getElementById('menuPanel');
    const btnStart = document.getElementById('btnStart');
    const countdownEl = document.getElementById('countdown');
    const countNum = document.getElementById('countNum');
    const loader = document.getElementById('loader');
    const loaderImg = document.getElementById('loaderImg');
    const btnMusic = document.getElementById('btnMusic');
    const flash = document.getElementById('flash');

    /* update best display helper */
    function updateBestDisplays() {
      bestScoreEl.textContent = 'Mejor: ' + POINTS.best;
      menuBestEl.textContent = 'Mejor puntuación: ' + POINTS.best;
    }
    updateBestDisplays();

    /* ======= AUDIO & MUSIC ======= */
    // Using simple Audio objects. We keep volumes moderate.
    const SFX = {
      grito: 'assets/sonido_bowl_limpio.mp3',
      recolectar: 'assets/sonido_recolectar_platano.mp3',
      inhalar: 'assets/sonido_inhalar.mp3',
      chocar: 'assets/sonido_chocar.mp3',
      woosh: 'assets/woosh.mp3',
      gong: 'assets/gong.mp3',
      level_complete: 'assets/level_complete.mp3'
    };

    function playSfx(name, volume = 1.0) {
      try {
        if (!name || !SFX[name]) return;
        const a = new Audio(SFX[name]);
        a.volume = volume;
        a.play().catch(() => {});
      } catch (e) { /* ignore */ }
    }

    const MUSIC = {
      base: new Audio('assets/musica_base.mp3'),
      bonus: new Audio('assets/musica_bonus.mp3'),
      boss: new Audio('assets/musica_boss.mp3')
    };
    Object.values(MUSIC).forEach(m => { if (m) { m.loop = true; try { m.volume = 0.45; } catch (e) {} } });

    let musicEnabled = true;
    let currentMusic = MUSIC.base;

    function playMusic(track) {
      if (!musicEnabled) return;
      try {
        if (currentMusic && !currentMusic.paused) currentMusic.pause();
      } catch (e) {}
      currentMusic = track || MUSIC.base;
      try {
        currentMusic.currentTime = 0;
        currentMusic.play().catch(() => {});
      } catch (e) {}
    }

    function stopMusic() {
      try {
        if (currentMusic) { currentMusic.pause(); currentMusic.currentTime = 0; }
      } catch (e) {}
    }

    btnMusic.addEventListener('click', () => {
      musicEnabled = !musicEnabled;
      if (musicEnabled) { playMusic(currentMusic || MUSIC.base); btnMusic.textContent = '🔊'; }
      else { stopMusic(); btnMusic.textContent = '🔇'; }
    });

    /* ======= ASSET PATHS ======= */
    const ASSETS = {
      fondos: {
        calc: 'assets/fondo_calc.png',
        desierto: 'assets/fondo_desierto.png',
        helado: 'assets/fondo_helado.png',
        bonus: 'assets/bonus/fondo_bonus.png'
      },
      erizo: {
        calmado: 'assets/calmado.png',
        inhalando: 'assets/respirando.png',
        gritando: 'assets/gritando.png',
        parpadeo: 'assets/erizo_parpadeo.png',
        meditando: 'assets/erizo_meditando.png'
      },
      obstaculos: ['assets/paraguas.png', 'assets/helado_meditando.png'],
      banana: 'assets/platano_puntos.png',
      suelo: 'assets/suelo.png',
      cuenco: 'assets/cuenco_tibetano.png',
      nubes: [
        'assets/nubes/nube1.png', 'assets/nubes/nube2.png',
        'assets/nubes/nube3.png', 'assets/nubes/nube4.png'
      ],
      contador: [
        'assets/contador_arbol.png','assets/contador_calcetin.png','assets/contador_leche.png',
        'assets/contador_cuenco.png','assets/contador_antena.png','assets/contador_seta.png',
        'assets/contador_coche.png','assets/contador_lapiz.png','assets/contador_paraguas.png','assets/contador_helado.png'
      ],
      contadorGo: 'assets/contador_go.png',
      // boss assets (folder contents you uploaded)
      bossFolder: 'assets/boss/',
      bossImg: 'assets/boss/pasta_feroz.png',
      bossCartel: 'assets/boss/cuidado_espuma.png',
      bossNumbersFolder: 'assets/boss/', // 1.png..10.png
      bossEspumas: [
        'assets/boss/espuma_boss.png','assets/boss/espuma_boss1.png','assets/boss/espuma_boss2.png','assets/boss/espuma_boss3.png'
      ],
      // bonus assets
      bonusCartel: 'assets/bonus/coge_todo.png',
      bonusPatitos: ['assets/patito1.png','assets/patito2.png']
    };

    /* ======= STATE & LAYOUT HELPERS ======= */
    let scale = 1, offsetX = 0, offsetY = 0;
    function fit() {
      const vw = window.innerWidth, vh = window.innerHeight;
      const s = Math.min(vw / WORLD.w, vh / WORLD.h);
      scale = s; offsetX = (vw - WORLD.w * s) / 2; offsetY = (vh - WORLD.h * s) / 2;
      canvas.style.width = (WORLD.w * s) + 'px';
      canvas.style.height = (WORLD.h * s) + 'px';
    }
    window.addEventListener('resize', fit);
    fit();

    let isDown = false, justReleased = false, wasInhaling = false;
    function withinCanvas(clientX, clientY) {
      const x = (clientX - offsetX) / scale, y = (clientY - offsetY) / scale;
      return (x >= 0 && x <= WORLD.w && y >= 0 && y <= WORLD.h);
    }

    canvas.addEventListener('pointerdown', async (e) => {
      if (!withinCanvas(e.clientX, e.clientY)) return;
      // small resume hack for autoplay policies (non-blocking)
      try { await Promise.resolve(); } catch (e) {}
      isDown = true;
      e.preventDefault();
      hint.style.display = 'none';
    });

    window.addEventListener('pointerup', (e) => {
      if (!isDown) return;
      isDown = false; justReleased = true; e.preventDefault();
    });

    /* ======= ENTITIES ======= */
    const player = { x: 140, y: WORLD.h - GROUND_H - 50, r: 50, state: 'calmado', vy: 0, mareo: 0, floatOffset: 0 };
    const sueloScroll = [{ x: 0 }, { x: WORLD.w }];
    const obstacles = [], bananas = [], pulses = [], particles = [];
    const CLOUD = { list: [] };

    /* ======= IMAGE LOADER ======= */
    const IMG = {
      fondos: {},
      erizo: {},
      obstaculos: [],
      banana: null,
      suelo: null,
      cuenco: null,
      nubes: [],
      contador: [],
      contadorGo: null,
      bossImg: null,
      bossCartel: null,
      bossEspumas: [],
      bonusPatitos: [],
      bonusBg: null
    };

    function loadImage(src) {
      return new Promise(res => {
        if (!src) return res(null);
        const im = new Image();
        im.onload = () => res(im);
        im.onerror = () => { console.warn('img load failed', src); res(null); };
        // avoid aggressive cache during dev: (remove ?v for production)
        im.src = src;
      });
    }

    async function loadAll() {
      // --- fondos ---
      IMG.fondos.calc = await loadImage(ASSETS.fondos.calc);
      IMG.fondos.desierto = await loadImage(ASSETS.fondos.desierto);
      IMG.fondos.helado = await loadImage(ASSETS.fondos.helado);
      IMG.fondos.bonus = await loadImage(ASSETS.fondos.bonus);

      // --- erizo ---
      IMG.erizo.calmado = await loadImage(ASSETS.erizo.calmado);
      IMG.erizo.inhalando = await loadImage(ASSETS.erizo.inhalando);
      IMG.erizo.gritando = await loadImage(ASSETS.erizo.gritando);
      IMG.erizo.parpadeo = await loadImage(ASSETS.erizo.parpadeo);
      IMG.erizo.meditando = await loadImage(ASSETS.erizo.meditando);

      // --- obstaculos + collectibles ---
      for (const s of ASSETS.obstaculos) IMG.obstaculos.push(await loadImage(s));
      IMG.banana = await loadImage(ASSETS.banana);
      IMG.suelo = await loadImage(ASSETS.suelo);
      IMG.cuenco = await loadImage(ASSETS.cuenco);

      // --- nubes ---
      for (const s of ASSETS.nubes) IMG.nubes.push(await loadImage(s));

      // --- contador images ---
      for (const s of ASSETS.contador) IMG.contador.push(await loadImage(s));
      IMG.contadorGo = await loadImage(ASSETS.contadorGo);

      // --- boss ---
      IMG.bossImg = await loadImage(ASSETS.bossImg);
      IMG.bossCartel = await loadImage(ASSETS.bossCartel);
      for (const s of ASSETS.bossEspumas) IMG.bossEspumas.push(await loadImage(s));

      // --- bonus ---
      for (const s of ASSETS.bonusPatitos) IMG.bonusPatitos.push(await loadImage(s));
      IMG.bonusBg = await loadImage(ASSETS.fondos.bonus);

      // hide loader gracefully (UX) - short delay
      setTimeout(() => { loader.style.display = 'none'; }, 500);
    }

    /* helper: init clouds */
    function initClouds() {
      CLOUD.list = [];
      for (let i = 0; i < 10; i++) {
        const band = Math.floor(Math.random()*3);
        const img = (IMG.nubes.length) ? IMG.nubes[Math.floor(Math.random()*IMG.nubes.length)] : null;
        CLOUD.list.push({
          x: Math.random() * WORLD.w,
          y: 50 + Math.random() * (WORLD.h/2 - 50),
          w: 80 + Math.random()*100,
          h: 40 + Math.random()*60,
          speed: 20 + band*30,
          band,
          img
        });
      }
    }

  /* =====================================================
     BLOQUE 2/5 — GAME STATE CONTROL, SPAWNERS & PHASES
     ===================================================== */

  /* Dependencias del bloque anterior: usa variables globales ya declaradas
     (WORLD, SPEED, SPAWN, CHARGE, etc.) */

  // ======== RESET / INITIAL STATE ========
  let bgStage = 0;
  let currentBg = null;
  let gameOver = false;
  let loopId = null;
  let started = false;
  let inBossPhase = false;
  let inBonusPhase = false;
  let bossTimer = 0;
  let bossCountdown = 0;
  let bossActive = false;
  let bonusTimer = 0;
  let bonusActive = false;

  function resetAll() {
    POINTS.total = 0;
    CHARGE.value = 0;
    CHARGE.cooldown = 0;
    SPEED.scroll = 280;
    SPAWN.interval = 1.2;
    SPAWN.timer = 0;
    SPAWN.diffTimer = 0;
    obstacles.length = 0;
    bananas.length = 0;
    pulses.length = 0;
    particles.length = 0;
    player.y = WORLD.h - GROUND_H - player.r + 20;
    player.vy = 0;
    player.state = 'calmado';
    player.mareo = 0;
    player.floatOffset = 0;
    panel.classList.remove('show');
    hint.style.display = '';
    bgStage = 0;
    currentBg = IMG.fondos.calc || null;
    initClouds();
    gameOver = false;
    inBossPhase = false;
    inBonusPhase = false;
    bossTimer = 0;
    bossCountdown = 0;
    bossActive = false;
    bonusTimer = 0;
    bonusActive = false;
    stopMusic();
    if (musicEnabled) playMusic(MUSIC.base);
  }

  btnRestart.addEventListener('click', () => {
    resetAll();
    lastFrame = performance.now();
    requestAnimationFrame(frame);
  });

  // ======== UTILITIES ========
  function rand(a,b){ return a + Math.random()*(b-a); }
  function chance(p){ return Math.random() < p; }
  function dist2(ax,ay,bx,by){ const dx=ax-bx, dy=ay-by; return dx*dx + dy*dy; }

  // ======== SPAWNER ========
  function spawnObstacle() {
    const y = rand(240, WORLD.h - 180);
    const r = rand(44, 70);
    const sp = Math.min(SPEED.scroll + rand(0,60), SPEED.max);
    obstacles.push({
      x: WORLD.w + 60, y, r, speed: sp,
      kind: Math.floor(rand(0, IMG.obstaculos.length))
    });
    if (chance(0.3))
      bananas.push({ x: WORLD.w + 100, y: rand(220, WORLD.h - 200), r: 44, speed: sp + 40, kind: 'banana' });
    if (chance(0.1))
      bananas.push({ x: WORLD.w + 150, y: rand(220, WORLD.h - 200), r: 44, speed: sp + 20, kind: 'cuenco' });
  }

  // ======== BOSS & BONUS PHASES ========
  const BOSS = { img: null, x: WORLD.w + 80, y: 240, w: 360, h: 580, state: 'idle', timer: 0 };

  function startBossPhase() {
    if (inBossPhase) return;
    inBossPhase = true;
    inBonusPhase = false;
    bossTimer = 0;
    bossCountdown = BOSS_DURATION;
    SPAWN.timer = 0;
    currentBg = IMG.fondos.desierto || IMG.fondos.calc;
    if (musicEnabled) playMusic(MUSIC.boss);
    bossActive = false;
    showPhaseCartel(IMG.bossCartel, 2000).then(() => {
      BOSS.img = IMG.bossImg;
      BOSS.x = WORLD.w + 40;
      BOSS.y = 160;
      BOSS.w = Math.min(WORLD.w * 0.9, 520);
      BOSS.h = Math.min(WORLD.h * 0.9, 740);
      BOSS.state = 'enter';
      bossActive = true;
      bossTimer = 0;
      setTimeout(() => { bossCountdown = BOSS_DURATION; }, 400);
    });
  }

  function startBonusPhase() {
    if (inBonusPhase) return;
    inBonusPhase = true;
    inBossPhase = false;
    bonusTimer = 0;
    bonusActive = false;
    currentBg = IMG.fondos.bonus || IMG.fondos.calc;
    if (musicEnabled) playMusic(MUSIC.bonus);
    showPhaseCartel(awaitableImage(ASSETS.bonusCartel), 2000).then(() => {
      bonusActive = true;
      bonusTimer = 0;
    });
  }

  function awaitableImage(src) {
    for (const img of IMG.contador)
      if (img && img.src && img.src.indexOf(src) !== -1) return img;
    const i = new Image(); i.src = src; return i;
  }

  function showPhaseCartel(img, ms) {
    return new Promise(res => {
      countdownEl.classList.add('show');
      if (img instanceof HTMLImageElement) countNum.innerHTML = '<img src="' + img.src + '">';
      else countNum.innerHTML = '<img src="' + img + '">';
      setTimeout(() => { countdownEl.classList.remove('show'); res(); }, ms);
    });
  }

  // ======== VISUAL HELPERS ========
  function fleetingFlash() {
    flash.style.opacity = '0.95';
    setTimeout(() => { flash.style.opacity = '0'; }, 120);
  }

  function doShake() {
    const wrap = document.getElementById('wrap');
    wrap.classList.add('shake');
    setTimeout(() => wrap.classList.remove('shake'), 450);
  }

  /* =====================================================
   BLOQUE 3/5 — OBSTÁCULOS, BONUS, BOSS & SPAWN
   ===================================================== */

// ======= SPAWN NORMAL =========
function spawnNormalObject(){
  const y = rand(240, WORLD.h - 200);
  const r = rand(42, 68);
  const sp = Math.min(SPEED.scroll + rand(0,70), SPEED.max);

  // obstáculo random
  obstacles.push({
    x: WORLD.w + 60,
    y,
    r,
    speed: sp,
    type: "obst",
    imgRef: IMG.obstaculos[Math.floor(rand(0, IMG.obstaculos.length))]
  });

  // banana
  if(Math.random() < 0.35){
    bananas.push({
      x: WORLD.w + 120,
      y: rand(220, WORLD.h - 220),
      r: 40,
      speed: sp + 40,
      type: "banana",
      imgRef: IMG.banana
    });
  }

  // cuenco tibetano
  if(Math.random() < 0.12){
    bananas.push({
      x: WORLD.w + 160,
      y: rand(200, WORLD.h - 240),
      r: 40,
      speed: sp + 30,
      type: "cuenco",
      imgRef: IMG.cuenco
    });
  }
}

// ====== BONUS SPAWN (patitos) ======
function spawnBonusObject(){
  const kind = Math.random() < 0.6 ? 0 : 1;
  const img = IMG.bonusPatitos[kind];
  const pts = kind === 0 ? 1 : 2;

  bananas.push({
    x: WORLD.w + 80,
    y: rand(180, WORLD.h - 240),
    r: 34,
    speed: 150 + rand(0,90),
    type: "patito",
    imgRef: img,
    pts
  });
}

// ====== BOSS SPAWN (espuma) ======
function spawnBossShot(){
  const y = rand(140, WORLD.h - 260);
  const img = IMG.bossEspumas[Math.floor(rand(0, IMG.bossEspumas.length))];

  obstacles.push({
    x: BOSS.x - 10,
    y,
    r: 28 + rand(0,20),
    speed: 200 + rand(0,150),
    type: "espuma",
    imgRef: img
  });
}

// ====== CHECK PHASE TRIGGERS ======
function checkPhaseTriggers(){
  if(!inBossPhase && !inBonusPhase){

    if(POINTS.total >= 50 && !bossesDone.has(1)){  
      bossesDone.add(1);
      startBossPhase(1);
      return;
    }

    if(POINTS.total >= 75 && !bonusDone.has(1)){
      bonusDone.add(1);
      startBonusPhase();
      return;
    }

    if(POINTS.total >= 100 && !bossesDone.has(2)){
      bossesDone.add(2);
      startBossPhase(2);
      return;
    }

    if(POINTS.total >= 125 && !bonusDone.has(2)){
      bonusDone.add(2);
      startBonusPhase();
      return;
    }

    if(POINTS.total >= 150 && !bossesDone.has(3)){
      bossesDone.add(3);
      startBossPhase(3);
      return;
    }
    
    if(POINTS.total >= 200 && !bonusDone.has(3)){
      bonusDone.add(3);
      startBonusPhase();
      return;
    }

    // Final del juego
    if(POINTS.total >= 250 && !gameComplete){
      gameComplete = true;
      endGameMeditation();
    }
  }
}

// ====== END GAME (Meditar) ======
function endGameMeditation(){
  gameOver = true;
  stopAllSfx();
  stopMusic();

  // Fondo dorado zen
  currentBg = IMG.fondos.helado; // puedes cambiar a un fondo dorado si lo tienes
  panel.classList.add("show");
  panelMsg.innerHTML = `
    🌟 Felicidades 🌟<br>
    Has completado tu camino Zen<br><br>
    Respira… el erizo ha despertado
  `;

  player.state = "meditando";
  player.y = WORLD.h/2;

  // música zen suave opcional aquí si quieres
}

// ====== SET BOSS ======
function setBossAssets(stage){
  if(stage === 1){
    BOSS.img = IMG.bossImg; // pasta feroz
    currentBg = IMG.fondos.desierto;
  } 
  else if(stage === 2){
    BOSS.img = IMG.boss2;
    currentBg = IMG.fondos.helado;
  }
  else if(stage === 3){
    BOSS.img = IMG.boss3;
    currentBg = IMG.fondos.desierto;
  }

  BOSS.x = WORLD.w + 100;
  BOSS.y = 180;
  BOSS.w = WORLD.w * 0.9;
  BOSS.h = WORLD.h * 0.75;
}

// ====== START BOSS ======
function startBossPhase(stage){
  inBossPhase = true;
  bossActive = false;
  bossTimer = 0;
  bossCountdown = BOSS_DURATION;
  SPEED.scroll *= 0.85; // ralentiza un pelín

  setBossAssets(stage);

  // cartel 2 segundos
  showPhaseCartel(IMG.bossCartel,2000).then(()=>{
    bossActive = true;
    playMusic(MUSIC.boss);
  });
}

// ====== START BONUS ======
function startBonusPhase(){
  inBonusPhase = true;
  bonusActive = false;
  bonusTimer = 0;
  SPEED.scroll *= 0.7;

  showPhaseCartel(IMG.bonusCartel,2000).then(()=>{
    bonusActive = true;
    playMusic(MUSIC.bonus);
  });
}
/* =====================================================
   BLOQUE 4/5 — DRAW, HUD, BOSS / BONUS UI
   ===================================================== */

function draw(){
  ctx.clearRect(0,0,WORLD.w,WORLD.h);

  // fondo
  if(currentBg)
    ctx.drawImage(currentBg, 0, 0, WORLD.w, WORLD.h);
  else {
    ctx.fillStyle="#1b1b1f";
    ctx.fillRect(0,0,WORLD.w,WORLD.h);
  }

  // si gameOver -> fondo congelado + overlay
  if(gameOver){
    ctx.fillStyle = "rgba(0,0,0,0.2)";
    ctx.fillRect(0,0,WORLD.w,WORLD.h);
    return;
  }

  // nubes
  for(let pass=0; pass<3; pass++){
    for(const c of CLOUD.list){
      if(c.band !== pass) continue;
      if(c.img) ctx.drawImage(c.img, c.x, c.y, c.w, c.h);
    }
  }

  // BONUS / PATITOS / OBJETOS DE BONUS
  for(const b of bananas){
    if(b.kind === "cuenco" && IMG.cuenco)
      ctx.drawImage(IMG.cuenco, b.x - b.r, b.y - b.r, b.r*2, b.r*2);
    else if(b.kind === "patito" && b.imgRef)
      ctx.drawImage(b.imgRef, b.x - b.r, b.y - b.r, b.r*2, b.r*2);
    else if(IMG.banana)
      ctx.drawImage(IMG.banana, b.x - b.r, b.y - b.r, b.r*2, b.r*2);
    else {
      ctx.fillStyle = "#facc15";
      ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
    }
  }

  // obstáculos (normales y espumas)
  for(const o of obstacles){
    if(o.kind === "espuma" && o.imgRef){
      ctx.drawImage(o.imgRef, o.x - o.r, o.y - o.r, o.r*2, o.r*2);
    } else {
      const img = IMG.obstaculos[o.kind] || null;
      if(img) ctx.drawImage(img, o.x - o.r, o.y - o.r, o.r*2, o.r*2);
      else {
        ctx.fillStyle = "#ef4444";
        ctx.beginPath(); ctx.arc(o.x,o.y,o.r,0,Math.PI*2); ctx.fill();
      }
    }
  }

  // pulsos (ondas)
  for(const p of pulses){
    const alpha = Math.max(0, p.life / 0.25);
    ctx.strokeStyle = `rgba(99,102,241,${alpha})`;
    ctx.lineWidth = 6;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.rad,0,Math.PI*2); ctx.stroke();
  }

  // suelo
  for(const s of sueloScroll){
    if(IMG.suelo)
      ctx.drawImage(IMG.suelo, s.x, WORLD.h - GROUND_H, WORLD.w, GROUND_H);
    else {
      ctx.fillStyle = "#4ade80";
      ctx.fillRect(s.x, WORLD.h - GROUND_H, WORLD.w, GROUND_H);
    }
  }

  // partículas
  for(const p of particles){
    const a = Math.max(0, p.life);
    ctx.fillStyle = p.color + a + ")";
    ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill();
  }

  // aura zen
  const pulse = 0.6 + 0.2 * Math.sin(performance.now()/300);
  ctx.fillStyle = `rgba(255,255,255,${0.25 * pulse})`;
  ctx.beginPath(); ctx.arc(player.x, player.y, 60, 0, Math.PI*2); ctx.fill();

  // ERIZO SPRITE
  let eImg = IMG.erizo.calmado;
  if(player.state === "inhalando") eImg = IMG.erizo.inhalando;
  else if(player.state === "gritando") eImg = IMG.erizo.gritando;
  else if(Math.random()<0.003 && IMG.erizo.parpadeo) eImg = IMG.erizo.parpadeo;

  if(eImg)
    ctx.drawImage(eImg, player.x - player.r, player.y - player.r, player.r*2, player.r*2);
  else {
    ctx.fillStyle="#fff";
    ctx.beginPath(); ctx.arc(player.x,player.y,player.r,0,Math.PI*2); ctx.fill();
  }

  // BOSS DIBUJO
  if(inBossPhase && bossActive && BOSS.img){
    ctx.save();
    const vib = (BOSS.state==="enter" || BOSS.state==="idle") ? Math.sin(performance.now()/50)*4 : 0;
    ctx.translate(vib, 0);
    ctx.drawImage(
      BOSS.img,
      BOSS.x, BOSS.y,
      BOSS.w, BOSS.h
    );
    ctx.restore();

    ctx.fillStyle="rgba(0,0,0,0.45)";
    ctx.fillRect(10,10,140,50);
    ctx.fillStyle="#fff";
    ctx.font="20px system-ui";
    ctx.textBaseline="middle";
    ctx.fillText("Boss: "+Math.max(0,Math.ceil(bossCountdown)), 18, 35);
  }

  // BONUS COUNTER
  if(inBonusPhase && bonusActive){
    ctx.fillStyle="rgba(0,0,0,0.45)";
    ctx.fillRect(10,10,140,50);
    ctx.fillStyle="#fff";
    ctx.font="20px system-ui";
    ctx.textBaseline="middle";
    ctx.fillText(
      "Bonus: "+Math.max(0,Math.ceil(BOSS_DURATION - bonusTimer)),
      18, 35
    );
  }
}


