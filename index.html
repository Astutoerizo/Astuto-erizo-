<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Astuto Erizo - Respira y Grita</title>
  <style>
    /* ---------- Basic UI + Canvas ---------- */
    html,body{margin:0;height:100%;background:#0e0e10;color:#fff;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;}
    #wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
    canvas{background:#1b1b1f;touch-action:none;display:block;}
    .hud{position:fixed;top:8px;left:50%;transform:translateX(-50%);width:min(92vw,720px);pointer-events:none;display:flex;gap:12px;align-items:center;justify-content:space-between;font-weight:600;z-index:1500}
    .bar{flex:1;height:14px;background:#3a3a44;border-radius:999px;overflow:hidden;border:2px solid #6ee7b7;box-shadow:inset 0 0 6px rgba(110,231,183,0.6)}
    .fill{height:100%;width:0%;background:#86efac;transition:width .08s linear}
    .cooldown{opacity:.45}
    .score{min-width:100px;text-align:right}
    .hud-btn{pointer-events:auto;cursor:pointer;padding:6px 10px;background:#24242a;border-radius:8px;font-size:14px}
    .panel{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);transition:opacity .2s ease;z-index:2000}
    .panel.show{display:flex;opacity:1;pointer-events:auto}
    .card{background:#1e1e24;border:1px solid #333;border-radius:16px;padding:20px;width:min(92vw,420px);text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .btn{display:inline-block;margin-top:12px;padding:10px 16px;border-radius:12px;background:#6ee7b7;color:#0b0b0d;font-weight:700;cursor:pointer;user-select:none;pointer-events:auto}
    .toast{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:#24242a;border:1px solid #333;padding:8px 12px;border-radius:10px;font-size:14px;opacity:.95;z-index:1500}
    #countdown{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter: blur(2px);z-index:2500}
    #countdown.show{display:flex}
    #countNum{font-weight:900;letter-spacing:-0.03em;color:#fff;text-shadow:0 6px 24px rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center}
    #countNum img{max-width:60%;height:auto;display:block;margin:0 auto;animation:zoomIn .6s ease}
    @keyframes zoomIn{from{transform:scale(.5);opacity:0}to{transform:scale(1);opacity:1}}
    #loader{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#0e0e10;z-index:3000}
    #loader img{max-width:200px;animation:float 1.8s ease-in-out infinite}
    #loader p{margin-top:12px;font-size:18px;color:#6ee7b7;font-weight:700;animation:blink 1.2s infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-18px)}}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
    /* shake + flash */
    .shake{animation:shakeAnim .45s ease}
    @keyframes shakeAnim{0%{transform:none}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(4px)}100%{transform:none}}
    #flash{pointer-events:none;position:fixed;inset:0;background:#fff;opacity:0;transition:opacity .12s;z-index:2800}
    /* responsiveness minor tweaks */
    @media (max-width:420px){.card{width:92vw;padding:16px}.hud{top:6px;gap:8px}.score{min-width:80px;font-size:13px}}
  </style>
</head>
<body>
  <div id="loader">
    <img id="loaderImg" src="assets/loader.png" alt="Cargando...">
    <p>Loading...</p>
  </div>

  <div id="wrap"><canvas id="game" width="540" height="960"></canvas></div>

  <div class="hud">
    <div class="bar"><div class="fill" id="zenFill"></div></div>
    <div class="score" id="score">Puntos: 0</div>
    <div class="score" id="bestScore">Mejor: 0</div>
    <div class="hud-btn" id="btnMusic">ðŸ”Š</div>
  </div>

  <div class="panel" id="panel">
    <div class="card">
      <h2>Astuto Erizo</h2>
      <p id="panelMsg">Has gritado al vacÃ­o zenâ€¦</p>
      <div class="btn" id="btnRestart">Reintentar</div>
      <p style="opacity:.7;font-size:12px;margin-top:8px">MantÃ©n pulsado para inhalar Â· Suelta para gritar</p>
    </div>
  </div>

  <div class="toast" id="hint">MantÃ©n pulsado para inhalar Â· Suelta para gritar</div>

  <div class="panel show" id="menuPanel">
    <div class="card">
      <img src="assets/logo_videojuego.png" alt="Astuto Erizo" style="max-width:320px;margin-bottom:12px;display:block;margin-left:auto;margin-right:auto;">
      <h2>Respira y Grita</h2>
      <p id="menuBest" style="margin:6px 0 12px 0">Mejor puntuaciÃ³n: 0</p>
      <p>Cuando estÃ©s listo, pulsa jugar y respira profundoâ€¦</p>
      <div class="btn" id="btnStart">Jugar</div>
      <p style="opacity:.7;font-size:12px;margin-top:10px">MantÃ©n pulsado para inhalar Â· Suelta para gritar</p>
    </div>
  </div>

  <div id="countdown"><div id="countNum"></div></div>
  <div id="flash"></div>

<script>
(() => {
  'use strict';

  // ======================================================
  // CONFIG / GLOBALS
  // ======================================================
  const TEST_MODE = true; // keep true while testing
  const WORLD = { w: 540, h: 960 };
  const SPEED = { scroll: 280, inc: 20, max: 520, accel: 0 }; // accel used if needed
  const SPAWN = { interval: 1.2, min: 0.7, timer: 0, diffTimer: 0 };
  const CHARGE = { value: 0, rate: 90, max: 100, over: 85, cooldown: 0, cooldownBase: 1.0, active:false };
  const PULSE = { base: 120, max: 420, life: 0.25 };
  const PHYSICS = { gravity: 600, inhaleForce: -1800, maxVy: 900 }; // snappier ascent
  const GROUND_H = 180;
  const BOSS_DURATION = 10;
  const BOSS_SCORE_1 = TEST_MODE ? 5  : 50;
  const BONUS_SCORE_1 = TEST_MODE ? 10 : 75;

  // DOM
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const zenFill = document.getElementById('zenFill');
  const scoreEl = document.getElementById('score');
  const bestScoreEl = document.getElementById('bestScore');
  const menuBestEl = document.getElementById('menuBest');
  const panel = document.getElementById('panel');
  const panelMsg = document.getElementById('panelMsg');
  const btnRestart = document.getElementById('btnRestart');
  const hint = document.getElementById('hint');
  const menuPanel = document.getElementById('menuPanel');
  const btnStart = document.getElementById('btnStart');
  const countdownEl = document.getElementById('countdown');
  const countNum = document.getElementById('countNum');
  const loader = document.getElementById('loader');
  const loaderImg = document.getElementById('loaderImg');
  const btnMusic = document.getElementById('btnMusic');
  const flash = document.getElementById('flash');

  // state
  const POINTS = { total: 0, best: parseInt(localStorage.getItem('bestScore')||'0',10) || 0 };
  let currentBg = null;
  let bgStage = 0;
  let gameOver = false;
  let started = false;
  let loopId = null;
  let lastFrame = performance.now();
  let isDown = false, justReleased = false, wasInhaling = false, inhaleSfxTimer = 0;

  // boss/bonus state
  let inBossPhase = false, bossActive = false, bossTimer = 0, bossCountdown = 0, currentBossStage = 1;
  let inBonusPhase = false, bonusActive = false, bonusTimer = 0;
  const bossesDone = new Set(), bonusDone = new Set();
  let gameComplete = false;

  // audio tracking to stop sfx on gameOver
  const activeSfx = new Set();

  // ======================================================
  // ASSETS
  // ======================================================
  const ASSETS = {
    fondos: {
      calc: 'assets/fondo_calc.png',
      desierto: 'assets/fondo_desierto.png',
      helado: 'assets/fondo_helado.png',
      bonus: 'assets/bonus/fondo_bonus.png'
    },
    erizo: {
      calmado: 'assets/calmado.png',
      inhalando: 'assets/respirando.png',
      gritando: 'assets/gritando.png',
      parpadeo: 'assets/erizo_parpadeo.png',
      meditando: 'assets/erizo_meditando.png'
    },
    obstaculos: ['assets/paraguas.png','assets/helado_meditando.png'],
    banana: 'assets/platano_puntos.png',
    suelo: 'assets/suelo.png',
    cuenco: 'assets/cuenco_tibetano.png',
    nubes: ['assets/nubes/nube1.png','assets/nubes/nube2.png','assets/nubes/nube3.png','assets/nubes/nube4.png'],
    contador: [
      'assets/contador_arbol.png','assets/contador_calcetin.png','assets/contador_leche.png','assets/contador_cuenco.png','assets/contador_antena.png','assets/contador_seta.png','assets/contador_coche.png','assets/contador_lapiz.png','assets/contador_paraguas.png','assets/contador_helado.png'
    ],
    contadorGo: 'assets/contador_go.png',
    // bosses folders: boss1 is assets/boss/, boss2 assets/boss2/, boss3 assets/boss3/
    bossFolders: [
      { folder: 'assets/boss/', img: 'assets/boss/pasta_feroz.png', cartel: 'assets/boss/cuidado_espuma.png', numbersFolder: 'assets/boss/' , espumas: ['assets/boss/espuma_boss.png','assets/boss/espuma_boss1.png','assets/boss/espuma_boss2.png','assets/boss/espuma_boss3.png'] },
      { folder: 'assets/boss2/', img: 'assets/boss2/boss2.png',  cartel: 'assets/boss2/cuidado_espuma2.png', numbersFolder: 'assets/boss2/', espumas: ['assets/boss2/lanza_boss2.png','assets/boss2/lanza_boss2a.png'] },
      { folder: 'assets/boss3/', img: 'assets/boss3/boss3.png',  cartel: 'assets/boss3/cuidado_espuma3.png', numbersFolder: 'assets/boss3/', espumas: ['assets/boss3/lanza_boss3.png','assets/boss3/lanza_boss3a.png'] }
    ],
    // bonus
    bonusCartel: 'assets/bonus/coge_todo.png',
    bonusPatitos: ['assets/patito1.png','assets/patito2.png'],
    // sound
    sfx: {
      grito: 'assets/sonido_bowl_limpio.mp3',
      recolectar: 'assets/sonido_recolectar_platano.mp3',
      inhalar: 'assets/sonido_inhalar.mp3',
      chocar: 'assets/sonido_chocar.mp3',
      woosh: 'assets/woosh.mp3',
      gong: 'assets/gong.mp3',
      level_complete: 'assets/level_complete.mp3'
    },
    music: {
      base: 'assets/musica_base.mp3',
      bonus: 'assets/musica_bonus.mp3',
      boss: 'assets/musica_boss.mp3'
    }
  };

  // ======================================================
  // IMAGE & AUDIO CACHE
  // ======================================================
  const IMG = {
    fondos: {},
    erizo: {},
    obstaculos: [],
    banana: null,
    suelo: null,
    cuenco: null,
    nubes: [],
    contador: [],
    contadorGo: null,
    bosses: [], // for each boss stage: { img, cartel, numbers:[], espumas:[] }
    bonusPatitos: [],
    bonusBg: null
  };

  const MUSIC = {
    base: new Audio(ASSETS.music.base),
    bonus: new Audio(ASSETS.music.bonus),
    boss: new Audio(ASSETS.music.boss)
  };
  Object.values(MUSIC).forEach(m=>{ if(m){ m.loop=true; try{ m.volume = 0.45 }catch(e){} }});
  let musicEnabled = true;
  let currentMusic = MUSIC.base;

  function playMusic(track){
    if(!musicEnabled) return;
    if(currentMusic && currentMusic !== track){
      try{ currentMusic.pause(); currentMusic.currentTime = 0; }catch(e){}
    }
    currentMusic = track;
    try{ currentMusic.currentTime = 0; currentMusic.play().catch(()=>{}); }catch(e){}
  }
  function stopMusic(){ try{ if(currentMusic){ currentMusic.pause(); currentMusic.currentTime = 0; } }catch(e){} }

  function playSfx(name, volume=1.0){
    const src = ASSETS.sfx[name];
    if(!src) return;
    try{
      const a = new Audio(src);
      a.volume = volume;
      a.play().catch(()=>{});
      activeSfx.add(a);
      // remove when ends
      a.addEventListener('ended', ()=> activeSfx.delete(a));
      a.addEventListener('pause', ()=> activeSfx.delete(a));
      // safety remove after 6s
      setTimeout(()=> activeSfx.delete(a), 6000);
      return a;
    }catch(e){}
    return null;
  }

  function stopAllSfx(){
    try{
      for(const a of Array.from(activeSfx)){ try{ a.pause(); }catch(e){} activeSfx.delete(a); }
    }catch(e){}
  }

  // ======================================================
  // LOADING
  // ======================================================
  function loadImage(src){ return new Promise(res=>{ if(!src) return res(null); const i=new Image(); i.onload=()=>res(i); i.onerror=()=>{ console.warn('img fail',src); res(null); }; i.src=src; }); }

  async function loadAll(){
    // backgrounds
    IMG.fondos.calc = await loadImage(ASSETS.fondos.calc);
    IMG.fondos.desierto = await loadImage(ASSETS.fondos.desierto);
    IMG.fondos.helado = await loadImage(ASSETS.fondos.helado);
    IMG.bonusBg = await loadImage(ASSETS.fondos.bonus);

    // erizo
    IMG.erizo.calmado = await loadImage(ASSETS.erizo.calmado);
    IMG.erizo.inhalando = await loadImage(ASSETS.erizo.inhalando);
    IMG.erizo.gritando = await loadImage(ASSETS.erizo.gritando);
    IMG.erizo.parpadeo = await loadImage(ASSETS.erizo.parpadeo);
    IMG.erizo.meditando = await loadImage(ASSETS.erizo.meditando);

    // obstaculos/collectibles
    for(const s of ASSETS.obstaculos) IMG.obstaculos.push(await loadImage(s));
    IMG.banana = await loadImage(ASSETS.banana);
    IMG.suelo = await loadImage(ASSETS.suelo);
    IMG.cuenco = await loadImage(ASSETS.cuenco);
    for(const s of ASSETS.nubes) IMG.nubes.push(await loadImage(s));

    // contador images
    for(const s of ASSETS.contador) IMG.contador.push(await loadImage(s));
    IMG.contadorGo = await loadImage(ASSETS.contadorGo);

    // bosses
    for(let i=0;i<ASSETS.bossFolders.length;i++){
      const item = ASSETS.bossFolders[i];
      const o = { img: null, cartel: null, numbers:[], espumas: [] };
      o.img = await loadImage(item.img);
      o.cartel = await loadImage(item.cartel);
      // numbers 1..10 (optional)
      for(let n=1;n<=10;n++){
        const p = item.numbersFolder + n + '.png';
        const ni = await loadImage(p);
        o.numbers.push(ni); // may be null
      }
      // espumas
      for(const s of item.espumas) o.espumas.push(await loadImage(s));
      IMG.bosses.push(o);
    }

    // bonus patitos
    for(const s of ASSETS.bonusPatitos) IMG.bonusPatitos.push(await loadImage(s));

    // hide loader
    setTimeout(()=>{ if(loader) loader.style.display='none'; }, 500);
  }

  // ======================================================
  // WORLD ENTITIES
  // ======================================================
  const player = { x: 140, y: WORLD.h - GROUND_H - 50, r: 50, vy: 0, state: 'calmado', mareo:0 };
  const sueloScroll = [{x:0},{x:WORLD.w}];
  const obstacles = []; // generic obstacles and boss shots
  const collectibles = []; // bananas, cuencos, patitos (for bonus)
  const pulses = [];
  const particles = [];
  const CLOUDS = { list: [] };

  function initClouds(){
    CLOUDS.list = [];
    for(let i=0;i<10;i++){
      const band = Math.floor(Math.random()*3);
      const img = IMG.nubes.length ? IMG.nubes[Math.floor(Math.random()*IMG.nubes.length)] : null;
      CLOUDS.list.push({ x: Math.random()*WORLD.w, y: 50 + Math.random()*(WORLD.h/2-50), w: 80 + Math.random()*100, h: 40 + Math.random()*60, speed: 20 + band*30, band, img });
    }
  }

  // ======================================================
  // HELPERS
  // ======================================================
  function rand(a,b){ return a + Math.random()*(b-a); }
  function chance(p){ return Math.random() < p; }
  function dist2(ax,ay,bx,by){ const dx=ax-bx, dy=ay-by; return dx*dx+dy*dy; }

  // fit canvas to viewport while preserving internal resolution
  let scale=1, offsetX=0, offsetY=0;
  function fit(){
    const vw = window.innerWidth, vh = window.innerHeight;
    const s = Math.min(vw/WORLD.w, vh/WORLD.h) || 1;
    scale = s;
    offsetX = (vw - WORLD.w*s)/2;
    offsetY = (vh - WORLD.h*s)/2;
    canvas.style.width = (WORLD.w*s) + 'px';
    canvas.style.height = (WORLD.h*s) + 'px';
  }
  window.addEventListener('resize', fit);
  fit();

  // pointer events mapped to within canvas
  function withinCanvas(cx,cy){ const x=(cx-offsetX)/scale, y=(cy-offsetY)/scale; return x>=0 && x<=WORLD.w && y>=0 && y<=WORLD.h; }

  canvas.addEventListener('pointerdown', (e)=>{ if(!withinCanvas(e.clientX,e.clientY)) return; isDown=true; CHARGE.active = true; e.preventDefault(); hint.style.display='none'; });
  window.addEventListener('pointerup', (e)=>{ if(!isDown) return; isDown=false; CHARGE.active=false; justReleased = true; e.preventDefault(); });

  // keyboard for TEST_MODE
  window.addEventListener('keydown', (e)=>{
    if(TEST_MODE){
      if(e.key.toLowerCase() === 'j'){ triggerBossTest(1); }
      if(e.key.toLowerCase() === 'k'){ triggerBossTest(2); }
      if(e.key.toLowerCase() === 'l'){ triggerBossTest(3); }
      if(e.key.toLowerCase() === 'b'){ startBonusPhase(); }
    }
    if(e.key === ' '){ CHARGE.active = true; isDown = true; }
  });
  window.addEventListener('keyup', (e)=>{ if(e.key === ' '){ CHARGE.active = false; isDown=false; justReleased=true; } });

  // blur/focus music handling
  window.addEventListener('blur', ()=>{ try{ if(currentMusic) currentMusic.pause(); }catch(e){} });
  window.addEventListener('focus', ()=>{ try{ if(musicEnabled && currentMusic) currentMusic.play().catch(()=>{}); }catch(e){} });

  // ======================================================
  // SPAWNERS
  // ======================================================
  function spawnObstacleNormal(){
    const y = rand(240, WORLD.h - 200);
    const r = rand(44,70);
    const sp = Math.min(SPEED.scroll + rand(0,60), SPEED.max);
    obstacles.push({ x: WORLD.w + 60, y, r, speed: sp, kind: 'obst', imgRef: IMG.obstaculos[Math.floor(rand(0, IMG.obstaculos.length))] });
    if(chance(0.3)) collectibles.push({ x: WORLD.w + 100, y: rand(220, WORLD.h - 200), r: 44, speed: sp + 40, kind: 'banana', imgRef: IMG.banana });
    if(chance(0.1)) collectibles.push({ x: WORLD.w + 150, y: rand(220, WORLD.h - 200), r: 44, speed: sp + 20, kind: 'cuenco', imgRef: IMG.cuenco });
  }

  function spawnBonusPatito(){
    const kind = Math.random() < 0.6 ? 0 : 1;
    const img = IMG.bonusPatitos[kind];
    const pts = kind === 0 ? 1 : 2;
    collectibles.push({ x: WORLD.w + 80, y: rand(180, WORLD.h - 240), r: 34, speed: 150 + rand(0,90), kind: 'patito', imgRef: img, pts });
  }

  // spawn from boss (espuma)
  function spawnBossEspuma(stage){
    // stage indexes 1..3 mapped to IMG.bosses[stage-1]
    const b = IMG.bosses[stage-1];
    if(!b) return;
    const y = rand(140, WORLD.h - 260);
    const img = b.espumas[Math.floor(rand(0, b.espumas.length))];
    obstacles.push({ x: BOSS.x - 10, y, r: 28 + rand(0,20), speed: 160 + rand(0,160), kind: 'espuma', imgRef: img });
  }

  // ======================================================
  // BOSS STRUCT
  // ======================================================
  const BOSS = { x: WORLD.w + 80, y: 180, w: 360, h: 520, img: null, state: 'idle', stage:1, timer:0, spawnTimer:0, spawnInterval:0.6 };

  function setBossAssets(stage){
    currentBossStage = stage;
    const bimage = IMG.bosses[stage-1];
    if(bimage && bimage.img) BOSS.img = bimage.img;
    else BOSS.img = null;
    // position dimensions
    BOSS.w = Math.min(WORLD.w * 0.9, 680);
    BOSS.h = Math.min(WORLD.h * 0.9, 900);
    BOSS.x = WORLD.w + 80;
    BOSS.y = Math.max(120, WORLD.h*0.12);
    BOSS.state = 'enter';
    BOSS.timer = 0;
    BOSS.spawnTimer = 0;
    BOSS.spawnInterval = 0.8; // start less aggressive
    BOSS.stage = stage;
  }

  // ======================================================
  // PHASE CONTROL: cartels, start/stop boss/bonus
  // ======================================================
  function showPhaseCartelImage(imgElOrSrc, ms=2000){
    return new Promise(res=>{
      countdownEl.classList.add('show');
      if(imgElOrSrc instanceof HTMLImageElement) countNum.innerHTML = '<img src="'+imgElOrSrc.src+'">';
      else countNum.innerHTML = '<img src="'+imgElOrSrc+'">';
      setTimeout(()=>{ countdownEl.classList.remove('show'); res(); }, ms);
    });
  }

  function showNumberCountdownFromBossImages(stage){
    // attempt to show 3..1 images in center before boss starts shooting (optional)
    // but requirement: once boss appears, counter (top-left) shows numbers using images 1..10 (we draw those in draw())
  }

  // Start boss sequence: show cartel 2s, then boss enters slow 1.8s, then start espumas + countdown
  function startBossPhase(stage){
    if(inBossPhase) return;
    inBossPhase = true; inBonusPhase = false;
    bossActive = false; bossTimer = 0; bossCountdown = BOSS_DURATION;
    // stop normal spawns
    SPAWN.timer = 0;
    // change background (per stage)
    const bg = (stage === 1) ? IMG.fondos.desierto : (stage === 2 ? IMG.fondos.helado : IMG.fondos.desierto);
    currentBg = bg || IMG.fondos.calc;
    // play boss music
    if(musicEnabled) playMusic(MUSIC.boss);
    currentBossStage = stage;
    // cartel (from loaded images if available)
    const cartelImg = (IMG.bosses[stage-1] && IMG.bosses[stage-1].cartel) ? IMG.bosses[stage-1].cartel : null;
    showPhaseCartelImage(cartelImg || ASSETS.bonusCartel, 2000).then(()=>{
      // prepare boss
      setBossAssets(stage);
      // animate boss entering over ~1.6s implemented in update()
      bossActive = true;
      bossTimer = 0;
      bossCountdown = BOSS_DURATION;
      // reset obstacles/collectibles so boss phase is clean
      obstacles.length = 0; collectibles.length = 0;
    });
  }

  function startBonusPhase(){
    if(inBonusPhase) return;
    inBonusPhase = true; inBossPhase = false;
    bonusActive = false; bonusTimer = 0;
    // change background to bonus
    currentBg = IMG.bonusBg || IMG.fondos.helado || IMG.fondos.calc;
    if(musicEnabled) playMusic(MUSIC.bonus);
    // show small cartel
    const cartel = ASSETS.bonusCartel;
    showPhaseCartelImage(cartel, 1800).then(()=>{
      bonusActive = true; bonusTimer = 0;
      // clear normal spawns temporarily
      obstacles.length = 0; collectibles.length = 0;
    });
  }

  // trigger from keys for testing
  function triggerBossTest(stage){
    startBossPhase(stage);
  }

  // ======================================================
  // GAME RESET / RESTART / END PHASE
  // ======================================================
  function resetAll(){
    POINTS.total = 0;
    CHARGE.value = 0; CHARGE.cooldown = 0; CHARGE.active = false;
    SPEED.scroll = 280; SPAWN.interval = 1.2; SPAWN.timer = SPAWN.diffTimer = 0;
    obstacles.length = collectibles.length = pulses.length = particles.length = 0;
    player.y = WORLD.h - GROUND_H - player.r + 20; player.vy = 0; player.state = 'calmado'; player.mareo = 0;
    panel.classList.remove('show'); hint.style.display = '';
    bgStage = 0; currentBg = IMG.fondos.calc || null;
    initClouds();
    gameOver = false;
    inBossPhase = false; bossActive = false; bossTimer = 0; bossCountdown = 0;
    inBonusPhase = false; bonusActive = false; bonusTimer = 0;
    stopAllSfx(); stopMusic();
    if(musicEnabled) playMusic(MUSIC.base);
  }

  btnRestart.addEventListener('click', ()=>{
    // If died during boss and we want to restart boss immediately, handle in collision logic
    resetAll();
    lastFrame = performance.now();
    requestAnimationFrame(frame);
  });

  function endBossPhase(){
    bossActive = false; inBossPhase = false; bossTimer = 0; bossCountdown = 0;
    fleetingFlash();
    playSfx('level_complete', 0.6);
    // gentle increase speed for difficulty (tiny)
    SPEED.scroll = Math.min(SPEED.scroll + SPEED.inc*0.2, SPEED.max);
    // return to base bg/music
    currentBg = IMG.fondos.calc || null;
    if(musicEnabled) playMusic(MUSIC.base);
  }

  function endBonusPhase(){
    bonusActive = false; inBonusPhase = false; bonusTimer = 0;
    fleetingFlash();
    playSfx('level_complete', 0.6);
    SPEED.scroll = Math.min(SPEED.scroll + SPEED.inc*0.12, SPEED.max);
    currentBg = IMG.fondos.calc || null;
    if(musicEnabled) playMusic(MUSIC.base);
  }

  function endGameMeditation(){
    gameOver = true;
    stopAllSfx(); stopMusic();
    currentBg = IMG.fondos.helado || IMG.fondos.calc;
    panel.classList.add('show');
    panelMsg.innerHTML = `ðŸŒŸ Felicidades ðŸŒŸ<br>Has completado tu camino Zen<br><br>Respiraâ€¦ el erizo ha despertado`;
    player.state = 'meditando';
    player.y = WORLD.h/2;
  }

  // ======================================================
  // UPDATE LOOP
  // ======================================================
  function update(dt){
    if(!started) return;

    // progressive spawn speed (if you want accel)
    if(SPEED.accel) SPEED.scroll = Math.min(SPEED.scroll + dt * SPEED.accel, SPEED.max);

    // backgrounds change in normal phases by points
    if(!inBossPhase && !inBonusPhase){
      if(POINTS.total >= 85 && bgStage < 2){ bgStage = 2; currentBg = IMG.fondos.helado || currentBg; playSfx('woosh', 0.7); }
      else if(POINTS.total >= 50 && bgStage < 1){ bgStage = 1; currentBg = IMG.fondos.desierto || currentBg; playSfx('woosh', 0.7); }
    }

    // move suelo
    for(const s of sueloScroll){ s.x -= SPEED.scroll * dt; if(s.x <= -WORLD.w) s.x += WORLD.w * 2; }

    // clouds move
    for(const c of CLOUDS.list){ c.x -= c.speed * dt; if(c.x + c.w < 0){ c.x = WORLD.w + rand(10,100); c.y = rand(50, WORLD.h/2); c.w = rand(80,180); c.h = rand(50,100); c.img = IMG.nubes[Math.floor(rand(0,IMG.nubes.length))]; } }

    // spawn normal obstacles only when not in boss/bonus
    if(!inBossPhase && !inBonusPhase){
      SPAWN.timer += dt; SPAWN.diffTimer += dt;
      if(SPAWN.timer >= SPAWN.interval){ SPAWN.timer = 0; spawnObstacleNormal(); }
      if(SPAWN.diffTimer >= 10){ SPAWN.diffTimer = 0; SPEED.scroll = Math.min(SPEED.scroll + SPEED.inc, SPEED.max); SPAWN.interval = Math.max(SPAWN.min, SPAWN.interval - 0.05); }
    }

    // handle inhale
    if(CHARGE.active && CHARGE.cooldown <= 0 && !gameOver){
      player.state = 'inhalando';
      if(player.vy > 220) player.vy *= 0.5;
      const boost = (player.vy > 0 ? 1.6 : 1.0);
      player.vy += PHYSICS.inhaleForce * boost * dt;
      CHARGE.value = Math.min(CHARGE.max, CHARGE.value + CHARGE.rate * dt);
      if(!wasInhaling){ playSfx('inhalar', 0.28); inhaleSfxTimer = 0; } else { inhaleSfxTimer += dt; if(inhaleSfxTimer >= 0.5){ playSfx('inhalar', 0.24); inhaleSfxTimer = 0; } }
    }
    wasInhaling = CHARGE.active && CHARGE.cooldown <= 0;

    // gravity + pos
    player.vy += PHYSICS.gravity * dt;
    if(player.vy > PHYSICS.maxVy) player.vy = PHYSICS.maxVy;
    player.y += player.vy * dt;

    // top limit
    if(player.y < 80){ player.y = 80; player.vy = Math.min(player.vy, 40); }

    // ground limit
    const sueloTop = WORLD.h - GROUND_H - player.r;
    if(player.y > sueloTop){ player.y = sueloTop; player.vy = 0; }

    // handle release -> pulses / grito
    if(justReleased){
      justReleased = false;
      if(CHARGE.cooldown <= 0){
        if(CHARGE.value >= CHARGE.over){
          CHARGE.cooldown = 0.7;
          CHARGE.value = 0;
          player.state = 'gritando';
          // big grito: long pulse
          const rad = PULSE.max;
          pulses.push({ x: player.x + 40, y: player.y, rad, life: PULSE.life * 1.3 });
          playSfx('grito', 0.35);
        } else {
          const t = CHARGE.value / CHARGE.max;
          const rad = PULSE.base + t * (PULSE.max - PULSE.base);
          pulses.push({ x: player.x + 40, y: player.y, rad, life: PULSE.life });
          CHARGE.cooldown = CHARGE.cooldownBase;
          CHARGE.value = 0;
          player.state = 'gritando';
          playSfx('grito', 0.35);
        }
      }
      inhaleSfxTimer = 0;
    }

    // cooldown decrements
    if(CHARGE.cooldown > 0){ CHARGE.cooldown = Math.max(0, CHARGE.cooldown - dt); }
    if(!CHARGE.active && CHARGE.cooldown === 0 && player.state !== 'mareado') player.state = 'calmado';

    // particles
    if(Math.random() < 0.1) particles.push({ x: player.x + rand(-20,20), y: player.y + rand(-20,20), vx: rand(-15,15), vy: rand(-30,-10), life: 1.0, color: `rgba(255,${200+Math.floor(55*Math.random())},255,` });
    for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.x += p.vx*dt; p.y += p.vy*dt; p.life -= dt*0.5; if(p.life<=0) particles.splice(i,1); }

    // pulses collision with obstacles (clear obstacles) -> award points but no collect sfx
    for(let i=pulses.length-1;i>=0;i--){
      const p = pulses[i];
      p.life -= dt;
      if(p.life <= 0){ pulses.splice(i,1); continue; }
      for(let j=obstacles.length-1;j>=0;j--){
        const o = obstacles[j];
        if(dist2(p.x,p.y,o.x,o.y) <= (p.rad + o.r)*(p.rad + o.r)){
          // if obstacle is normal obst, award small points
          if(o.kind !== 'espuma') POINTS.total += 2;
          obstacles.splice(j,1);
        }
      }
    }

    // move obstacles & collectibles
    for(let i=obstacles.length-1;i>=0;i--){ const o=obstacles[i]; o.x -= o.speed*dt; if(o.x < -160) obstacles.splice(i,1); }
    for(let i=collectibles.length-1;i>=0;i--){ const c=collectibles[i]; c.x -= c.speed*dt; if(c.x < -160) collectibles.splice(i,1); }

    // collisions with obstacles -> game over OR respawn in boss
    for(let i=obstacles.length-1;i>=0;i--){
      const o = obstacles[i];
      if(dist2(o.x,o.y,player.x,player.y) <= (o.r + player.r)*(o.r + player.r)){
        // collision
        playSfx('chocar', 0.45);
        // If in boss phase -> restart boss (respawn in boss)
        if(inBossPhase){
          // immediate clear and restart boss sequence
          obstacles.length = 0; collectibles.length = 0; pulses.length = 0;
          // brief flash / shake
          fleetingFlash(); doShake();
          // restart boss sequence with same stage after short delay
          setTimeout(()=>{ startBossPhase(currentBossStage); }, 600);
          return; // don't show panel
        } else {
          // normal game over
          panelMsg.textContent = ["El erizo se quedÃ³ sin aireâ€¦","Has gritado al vacÃ­o. El vacÃ­o gritÃ³ de vuelta.","La serenidad se tropezÃ³ contigo."][Math.floor(Math.random()*3)];
          panel.classList.add('show');
          gameOver = true;
          stopAllSfx();
          // stop loop
          if(loopId) cancelAnimationFrame(loopId);
          return;
        }
      }
    }

    // collectible pickups: bananas/cuenco/patitos -> play collect sfx (only here)
    for(let i=collectibles.length-1;i>=0;i--){
      const c = collectibles[i];
      if(dist2(c.x,c.y,player.x,player.y) <= (c.r + player.r)*(c.r + player.r)){
        collectibles.splice(i,1);
        let pts = 0;
        if(c.kind === 'cuenco'){ pts = 5; }
        else if(c.kind === 'banana'){ pts = 1; }
        else if(c.kind === 'patito'){ pts = c.pts || 1; }
        POINTS.total += pts;
        playSfx('recolectar', 0.45); // lower volume
      }
    }

    // HUD updates
    scoreEl.textContent = "Puntos: " + POINTS.total;
    zenFill.style.width = (CHARGE.value / CHARGE.max) * 100 + "%";
    zenFill.parentElement.classList.toggle('cooldown', CHARGE.cooldown > 0);

    // phase triggers (only when not already in boss/bonus)
    if(!inBossPhase && !inBonusPhase){
      // use set thresholds (we track bossesDone/bonusDone for multi-phase)
      if(POINTS.total >= BOSS_SCORE_1 && !bossesDone.has(1)){ bossesDone.add(1); startBossPhase(1); }
      else if(POINTS.total >= BONUS_SCORE_1 && !bonusDone.has(1)){ bonusDone.add(1); startBonusPhase(); }
      // further phases planned based on POINTS and bossesDone/bonusDone
    }

    // Boss active behaviour
    if(inBossPhase && bossActive && BOSS.img){
      // entry animation (BOSS.state === 'enter')
      if(BOSS.state === 'enter'){
        // slide left to appear half visible
        BOSS.x -= 280 * dt; // fast entrance
        if(BOSS.x <= WORLD.w - BOSS.w*0.6){
          BOSS.state = 'idle'; BOSS.timer = 0;
        }
      } else if(BOSS.state === 'idle'){
        // small idle timer
        BOSS.timer += dt;
        // we keep it idle until a short time then switch to 'move'
        if(BOSS.timer > 0.5) BOSS.state = 'move';
      } else if(BOSS.state === 'move'){
        // horizontal sway: translate in draw for visual effect
        BOSS.timer += dt;
      }
      // spawn espumas progressively: spawn interval reduces slowly to make it harder gradually
      BOSS.spawnTimer += dt;
      if(BOSS.spawnTimer >= BOSS.spawnInterval){
        BOSS.spawnTimer = 0;
        // spawn 1..2 espumas
        const count = 1 + Math.floor(rand(0,1.5));
        for(let i=0;i<count;i++) spawnBossEspuma(BOSS.stage);
        // slightly reduce interval to increase intensity
        BOSS.spawnInterval = Math.max(0.28, BOSS.spawnInterval - 0.02);
      }

      // boss countdown
      bossCountdown -= dt;
      if(bossCountdown <= 0){
        endBossPhase();
      }
      bossTimer += dt;
    }

    // Bonus active behaviour
    if(inBonusPhase && bonusActive){
      // spawn patitos frequently
      if(Math.random() < 0.08) spawnBonusPatito();
      bonusTimer += dt;
      if(bonusTimer >= BOSS_DURATION){
        endBonusPhase();
      }
    }

    // save best score live
    if(POINTS.total > POINTS.best){
      POINTS.best = POINTS.total;
      localStorage.setItem('bestScore', POINTS.best);
      bestScoreEl.textContent = "Mejor: " + POINTS.best;
      menuBestEl.textContent = "Mejor puntuaciÃ³n: " + POINTS.best;
    }
  }

  // ======================================================
  // DRAW
  // ======================================================
  function draw(){
    ctx.clearRect(0,0,WORLD.w,WORLD.h);

    // background
    if(currentBg) ctx.drawImage(currentBg, 0, 0, WORLD.w, WORLD.h);
    else { ctx.fillStyle = '#1b1b1f'; ctx.fillRect(0,0,WORLD.w,WORLD.h); }

    // if gameOver: show background but skip most draws (we keep panel overlay visible)
    if(gameOver){
      ctx.fillStyle = 'rgba(0,0,0,0.12)';
      ctx.fillRect(0,0,WORLD.w,WORLD.h);
      return;
    }

    // clouds (parallax passes)
    for(let pass=0;pass<3;pass++){
      for(const c of CLOUDS.list){
        if(c.band !== pass) continue;
        if(c.img) ctx.drawImage(c.img, c.x, c.y, c.w, c.h);
        else { ctx.fillStyle = 'rgba(255,255,255,0.85)'; ctx.beginPath(); ctx.ellipse(c.x + c.w/2, c.y + c.h/2, c.w/2, c.h/3, 0, 0, Math.PI*2); ctx.fill(); }
      }
    }

    // collectibles (bonus or normal)
    for(const b of collectibles){
      if(b.kind === 'cuenco' && IMG.cuenco) ctx.drawImage(IMG.cuenco, b.x - b.r, b.y - b.r, b.r*2, b.r*2);
      else if(b.kind === 'patito' && b.imgRef) ctx.drawImage(b.imgRef, b.x - b.r, b.y - b.r, b.r*2, b.r*2);
      else if(IMG.banana && b.kind === 'banana') ctx.drawImage(IMG.banana, b.x - b.r, b.y - b.r, b.r*2, b.r*2);
      else { ctx.fillStyle = '#facc15'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); }
    }

    // obstacles including boss espumas
    for(const o of obstacles){
      if(o.kind === 'espuma' && o.imgRef) ctx.drawImage(o.imgRef, o.x - o.r, o.y - o.r, o.r*2, o.r*2);
      else{
        const img = (typeof o.kind === 'number' ? IMG.obstaculos[o.kind] : o.imgRef) || IMG.obstaculos[0];
        if(img) ctx.drawImage(img, o.x - o.r, o.y - o.r, o.r*2, o.r*2);
        else { ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(o.x,o.y,o.r,0,Math.PI*2); ctx.fill(); }
      }
    }

    // pulses (grito circles)
    for(const p of pulses){
      const alpha = Math.max(0, p.life / PULSE.life);
      ctx.strokeStyle = `rgba(99,102,241,${alpha})`;
      ctx.lineWidth = 6;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.rad,0,Math.PI*2); ctx.stroke();
    }

    // ground
    for(const s of sueloScroll){
      if(IMG.suelo) ctx.drawImage(IMG.suelo, s.x, WORLD.h - GROUND_H, WORLD.w, GROUND_H);
      else { ctx.fillStyle = '#4ade80'; ctx.fillRect(s.x, WORLD.h - GROUND_H, WORLD.w, GROUND_H); }
    }

    // particles
    for(const p of particles){ const a = Math.max(0,p.life); ctx.fillStyle = p.color + a + ")"; ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill(); }

    // aura (soft)
    const pulse = 0.6 + 0.2 * Math.sin(performance.now()/300);
    ctx.fillStyle = `rgba(255,255,255,${0.25 * pulse})`;
    ctx.beginPath(); ctx.arc(player.x, player.y, 60, 0, Math.PI*2); ctx.fill();

    // player sprite selection
    let erizoImg = IMG.erizo.calmado;
    if(player.state === 'inhalando') erizoImg = IMG.erizo.inhalando;
    else if(player.state === 'gritando') erizoImg = IMG.erizo.gritando;
    else if(Math.random() < 0.002 && IMG.erizo.parpadeo) erizoImg = IMG.erizo.parpadeo;
    if(erizoImg) ctx.drawImage(erizoImg, player.x - player.r, player.y - player.r, player.r*2, player.r*2);
    else { ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(player.x,player.y,player.r,0,Math.PI*2); ctx.fill(); }

    // boss draw (if active)
    if(inBossPhase && bossActive && BOSS.img){
      ctx.save();
      // slight vib if entering/idle
      const vib = (BOSS.state === 'enter' || BOSS.state === 'idle') ? Math.sin(performance.now()/50)*4 : 0;
      ctx.translate(vib, 0);
      ctx.drawImage(BOSS.img, BOSS.x, BOSS.y, BOSS.w, BOSS.h);
      ctx.restore();
      // countdown top-left: if boss number images available, try to draw IMG.bosses[stage-1].numbers[idx-1] else draw text
      const bossDef = IMG.bosses[BOSS.stage-1];
      const idx = Math.max(1, Math.min(10, Math.ceil(bossCountdown)));
      // small background
      ctx.fillStyle = 'rgba(0,0,0,0.45)'; ctx.fillRect(10,10,140,50);
      if(bossDef && bossDef.numbers && bossDef.numbers[idx-1]){
        ctx.drawImage(bossDef.numbers[idx-1], 14, 12, 44, 44);
        ctx.fillStyle = '#fff'; ctx.font = '16px system-ui'; ctx.textBaseline = 'middle'; ctx.fillText('Boss: ' + Math.max(0, Math.ceil(bossCountdown)), 66, 34);
      } else {
        ctx.fillStyle = '#fff'; ctx.font = '18px system-ui'; ctx.textBaseline = 'middle'; ctx.fillText('Boss: ' + Math.max(0, Math.ceil(bossCountdown)), 18, 34);
      }
    }

    // bonus counter top-left
    if(inBonusPhase && bonusActive){
      ctx.fillStyle = 'rgba(0,0,0,0.45)'; ctx.fillRect(10,10,140,50);
      ctx.fillStyle = '#fff'; ctx.font = '18px system-ui'; ctx.textBaseline = 'middle';
      ctx.fillText('Bonus: ' + Math.max(0, Math.ceil(BOSS_DURATION - bonusTimer)), 18, 34);
    }
  }

  // ======================================================
  // FRAME DRIVER
  // ======================================================
  function frame(now){
    const dt = Math.min(0.033, (now - lastFrame)/1000);
    lastFrame = now;
    update(dt);
    draw();
    loopId = requestAnimationFrame(frame);
  }

  // ======================================================
  // UTIL FX: flash & shake
  // ======================================================
  function fleetingFlash(){
    flash.style.opacity = '0.95';
    setTimeout(()=>{ flash.style.opacity = '0'; }, 120);
  }
  function doShake(){
    const wrap = document.getElementById('wrap');
    wrap.classList.add('shake');
    setTimeout(()=>{ wrap.classList.remove('shake'); }, 450);
  }

  // ======================================================
  // INIT / START / COUNTDOWN FOR MENU
  // ======================================================
  const COUNTDOWN_IMAGES = ASSETS.contador.slice();
  function showMainCountdown(onDone){
    let pool = COUNTDOWN_IMAGES.slice();
    let seq = [];
    for(let i=0;i<3;i++){
      const idx = Math.floor(Math.random()*pool.length);
      seq.push(pool.splice(idx,1)[0]);
    }
    seq.push(ASSETS.contadorGo);
    let i=0;
    countdownEl.classList.add('show');
    function next(){
      if(i<seq.length){
        countNum.innerHTML = `<img src="${seq[i]}">`;
        playSfx('gong', 0.7);
        i++;
        setTimeout(next, 900);
      } else {
        countdownEl.classList.remove('show');
        if(typeof onDone === 'function') onDone();
      }
    }
    next();
  }

  btnStart.addEventListener('click', ()=>{
    menuPanel.classList.remove('show');
    showMainCountdown(()=>{
      resetAll();
      lastFrame = performance.now();
      if(musicEnabled) playMusic(MUSIC.base);
      started = true;
      requestAnimationFrame(frame);
    });
  });

  btnMusic.addEventListener('click', ()=>{
    musicEnabled = !musicEnabled;
    if(musicEnabled){ playMusic(currentMusic || MUSIC.base); btnMusic.textContent = 'ðŸ”Š'; }
    else { stopMusic(); btnMusic.textContent = 'ðŸ”‡'; }
  });

  // ======================================================
  // LOADING AND AUTO-START (DEV)
  // ======================================================
  loadAll().then(()=>{
    currentBg = IMG.fondos.calc || null;
    initClouds();
    bestScoreEl.textContent = "Mejor: " + POINTS.best;
    menuBestEl.textContent = "Mejor puntuaciÃ³n: " + POINTS.best;
    // ensure loader hidden
    setTimeout(()=>{ if(loader) loader.style.display='none'; }, 200);
    // if TEST_MODE keep menu visible; user can click start
    // optionally auto-start if you want:
    if(TEST_MODE){
      // keep menu; don't autostart to let you see menu
    }
  });

  // ======================================================
  // Helper: stop when leaving page
  // ======================================================
  window.addEventListener('beforeunload', ()=>{ stopAllSfx(); stopMusic(); });

  // expose some little helpers for debugging in console
  window._AO = { startBossPhase, startBonusPhase, resetAll, IMG, ASSETS, POINTS, BOSS, TEST_MODE };

})();
</script>
</body>
</html>
