<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Astuto Erizo - Respira y Grita</title>
  <style>
    html,body{margin:0;height:100%;background:#0e0e10;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    #wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
    canvas{background:#1b1b1f;touch-action:none;display:block}
    .hud{position:fixed;top:8px;left:50%;transform:translateX(-50%);width:min(92vw,540px);pointer-events:none;display:flex;align-items:center;gap:12px;justify-content:space-between;font-weight:600}
    .bar{flex:1;height:14px;background:#3a3a44;border-radius:999px;overflow:hidden;border:2px solid #6ee7b7;box-shadow:0 0 6px rgba(110,231,183,0.6) inset}
    .fill{height:100%;width:0%;background:#86efac;transition:width .08s linear}
    .cooldown{opacity:.45}
    .score{min-width:100px;text-align:right}
    .hud-btn{pointer-events:auto;cursor:pointer;padding:4px 8px;background:#24242a;border-radius:6px;font-size:13px}
    .toast{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);background:#24242a;border:1px solid #333;padding:8px 12px;border-radius:10px;font-size:14px;opacity:.9}
    .panel{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);transition:opacity .2s ease}
    .panel.show{display:flex;opacity:1;pointer-events:auto}
    .card{background:#1e1e24;border:1px solid #333;border-radius:16px;padding:20px;width:min(92vw,420px);text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .btn{display:inline-block;margin-top:12px;padding:10px 16px;border-radius:12px;background:#6ee7b7;color:#0b0b0d;font-weight:700;cursor:pointer;user-select:none}
    #countdown{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);z-index:999}
    #countdown.show{display:flex}
    #countdown #countNum img{max-width:60%;height:auto;display:block;margin:0 auto;animation:zoomIn .6s ease}
    @keyframes zoomIn{from{transform:scale(.5);opacity:0}to{transform:scale(1);opacity:1}}
    /* loader */
    #loader{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#0e0e10;z-index:2000}
    #loader img{max-width:200px;animation:float 1.8s ease-in-out infinite}
    #loader p{margin-top:12px;font-size:18px;color:#6ee7b7;font-weight:bold;animation:blink 1.2s infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-18px)}}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
  </style>
</head>
<body>
  <div id="loader">
    <img id="loaderImg" src="assets/loader.png" alt="Cargando...">
    <p>Loading...</p>
  </div>

  <div id="wrap"><canvas id="game" width="540" height="960"></canvas></div>

  <div class="hud">
    <div class="bar"><div class="fill" id="zenFill"></div></div>
    <div class="score" id="score">Puntos: 0</div>
    <div class="score" id="bestScore">Mejor: 0</div>
    <div class="hud-btn" id="btnMusic">ðŸ”Š</div>
  </div>

  <div class="panel" id="panel">
    <div class="card">
      <h2>Astuto Erizo</h2>
      <p id="panelMsg">Has gritado al vacÃ­o zenâ€¦</p>
      <div class="btn" id="btnRestart">Reintentar</div>
      <p style="opacity:.7;font-size:12px;margin-top:8px">MantÃ©n pulsado para inhalar Â· Suelta para gritar</p>
    </div>
  </div>

  <div class="toast" id="hint">MantÃ©n pulsado para inhalar Â· Suelta para gritar</div>

  <div class="panel show" id="menuPanel">
    <div class="card">
      <img src="assets/logo_videojuego.png" alt="Astuto Erizo" style="max-width:280px;margin-bottom:12px;">
      <h2>Respira y Grita</h2>
      <p id="menuBest">Mejor puntuaciÃ³n: 0</p>
      <p>Cuando estÃ©s listo, pulsa jugar y respira profundoâ€¦</p>
      <div class="btn" id="btnStart">Jugar</div>
      <p style="opacity:.7;font-size:12px;margin-top:10px">MantÃ©n pulsado para inhalar Â· Suelta para gritar</p>
    </div>
  </div>

  <div id="countdown"><div id="countNum"></div></div>

  <script>
  (function(){
    // ---------- CONFIG ----------
    const WORLD = { w:540, h:960 };
    const SPEED = { scroll:280, inc:20, max:520 };
    const SPAWN = { interval:1.2, min:0.7, timer:0, diffTimer:0 };
    const CHARGE = { value:0, rate:60, max:100, over:85, cooldown:0, cooldownBase:1.0 };
    const PULSE = { base:120, max:380, life:0.25 };
    const POINTS = { total:0, best: parseInt(localStorage.getItem('bestScore')||'0') };
    const PHYSICS = { gravity:600, inhaleForce:-1400, maxVy:700 }; // mÃ¡s potente al inhalar (ascenso mÃ¡s rÃ¡pido)
    const GROUND_H = 180;

    // state
    let bgStage = 0;
    let currentBg = null;
    let gameOver = false;
    let loopId = null;
    let screenShake = 0; // segundos
    let flashAlpha = 0;

    // input
    let isDown=false, justReleased=false, wasInhaling=false, inhaleSfxTimer=0;

    // DOM & canvas
    const canvas = document.getElementById('game'), ctx = canvas.getContext('2d');
    const zenFill = document.getElementById('zenFill'), scoreEl = document.getElementById('score'),
          bestScoreEl = document.getElementById('bestScore'), menuBestEl = document.getElementById('menuBest'),
          btnMusic = document.getElementById('btnMusic'), panel = document.getElementById('panel'),
          panelMsg = document.getElementById('panelMsg'), btnRestart = document.getElementById('btnRestart'),
          hint = document.getElementById('hint'), menuPanel = document.getElementById('menuPanel'),
          btnStart = document.getElementById('btnStart'), countdownEl = document.getElementById('countdown'),
          countNum = document.getElementById('countNum'), loader = document.getElementById('loader'),
          loaderImg = document.getElementById('loaderImg');

    // audio
    const SFX = {
      grito: "assets/sonido_bowl_limpio.mp3",
      recolectar: "assets/sonido_recolectar_platano.mp3",
      inhalar: "assets/sonido_inhalar.mp3",
      chocar: "assets/sonido_chocar.mp3",
      woosh: "assets/woosh.mp3",
      gong: "assets/gong.mp3"
    };
    function playSfx(name, volume=1){
      if(!SFX[name]) return;
      if(gameOver && name !== 'chocar') return; // dejamos sonar chocar si quieres, pero en general evitamos SFX tras gameOver
      const a = new Audio(SFX[name]);
      a.volume = volume;
      a.play().catch(()=>{});
    }
    // grito: reproducir completo, volumen reducido
    function playGritoFull(){ if(gameOver) return; const a = new Audio(SFX.grito); a.volume = 0.35; a.play().catch(()=>{}); }

    // Music (base only for now). Will use bonus/boss later.
    const MUSIC = {
      base: new Audio("assets/musica_base.mp3"),
      // bonus: new Audio("assets/musica_bonus.mp3"),
      // boss: new Audio("assets/musica_boss.mp3"),
    };
    MUSIC.base.loop = true; MUSIC.base.volume = 0.35;
    let currentMusic = MUSIC.base;
    let musicEnabled = true;
    function playMusic(track){
      if(!musicEnabled) return;
      if(currentMusic && currentMusic !== track){ try{ currentMusic.pause(); }catch(e){} }
      currentMusic = track;
      currentMusic.play().catch(()=>{});
    }
    function stopMusic(){ try{ if(currentMusic) currentMusic.pause(); }catch(e){} }
    function toggleMusic(){
      musicEnabled = !musicEnabled;
      if(musicEnabled){ playMusic(currentMusic || MUSIC.base); btnMusic.textContent = "ðŸ”Š"; }
      else { stopMusic(); btnMusic.textContent = "ðŸ”‡"; }
    }
    btnMusic.addEventListener('click', toggleMusic);

    // assets list (paths)
    const ASSETS = {
      fondos: { calc:"assets/fondo_calc.png", desierto:"assets/fondo_desierto.png", helado:"assets/fondo_helado.png" },
      erizo: { calmado:"assets/calmado.png", inhalando:"assets/respirando.png", gritando:"assets/gritando.png", parpadeo:"assets/erizo_parpadeo.png" },
      obstaculos: ["assets/paraguas.png","assets/helado_meditando.png"],
      banana: "assets/platano_puntos.png",
      suelo: "assets/suelo.png",
      cuenco: "assets/cuenco_tibetano.png",
      nubes: ["assets/nubes/nube1.png","assets/nubes/nube2.png","assets/nubes/nube3.png","assets/nubes/nube4.png"]
    };

    // entities
    const player = { x:140, y:WORLD.h - 300, vy:0, r:50, state:'calmado', mareo:0, blinkTimer:Math.random()*4+2, blinkFrame:0 };
    const sueloScroll = [{ x:0 }, { x: WORLD.w }];
    const obstacles = [], bananas = [], pulses = [], particles = [];
    const CLOUD = { list: [] };

    // utils
    function rand(a,b){return a + Math.random()*(b-a);}
    function chance(p){return Math.random() < p;}
    function dist2(ax,ay,bx,by){ const dx = ax-bx, dy = ay-by; return dx*dx + dy*dy; }

    // images
    const IMG = { fondos:{}, erizo:{}, obstaculos:[], banana:null, suelo:null, cuenco:null, nubes:[] };
    function loadImage(src){ return new Promise(res=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=()=>res(null); i.src=src; }); }
    async function loadAll(){
      IMG.fondos.calc = await loadImage(ASSETS.fondos.calc);
      IMG.fondos.desierto = await loadImage(ASSETS.fondos.desierto);
      IMG.fondos.helado = await loadImage(ASSETS.fondos.helado);
      currentBg = IMG.fondos.calc;

      for(const k in ASSETS.erizo) IMG.erizo[k] = await loadImage(ASSETS.erizo[k]);
      for(const s of ASSETS.obstaculos) IMG.obstaculos.push(await loadImage(s));
      IMG.banana = await loadImage(ASSETS.banana);
      IMG.suelo = await loadImage(ASSETS.suelo);
      IMG.cuenco = await loadImage(ASSETS.cuenco);
      for(const n of ASSETS.nubes) IMG.nubes.push(await loadImage(n));
    }

    function initClouds(){
      CLOUD.list = [];
      for(let i=0;i<10;i++){
        const band = Math.floor(rand(0,3));
        const img = IMG.nubes.length ? IMG.nubes[Math.floor(rand(0,IMG.nubes.length))] : null;
        CLOUD.list.push({ x: rand(0,WORLD.w), y: rand(50,WORLD.h/2), w:rand(80,180), h:rand(50,100), speed:20+band*40, band, img});
      }
    }

    // spawn obstacle helper
    function spawnObstacle(){
      const y = rand(240, WORLD.h - 180);
      const r = rand(44, 70);
      const speed = Math.min(SPEED.scroll + rand(0,60), SPEED.max);
      obstacles.push({ x: WORLD.w + 60, y, r, speed, kind: Math.floor(rand(0, IMG.obstaculos.length)) });
      if(chance(0.3)) bananas.push({ x: WORLD.w + 100, y: rand(220, WORLD.h-200), r: 44, speed: speed+40, kind:'banana' });
      if(chance(0.1)) bananas.push({ x: WORLD.w + 150, y: rand(220, WORLD.h-200), r: 44, speed: speed+20, kind:'cuenco' });
    }

    // reset / restart
    function resetAll(){
      POINTS.total = 0;
      CHARGE.value = 0; CHARGE.cooldown = 0;
      SPEED.scroll = 280; SPAWN.interval = 1.2; SPAWN.timer = 0; SPAWN.diffTimer = 0;
      obstacles.length = 0; bananas.length = 0; pulses.length = 0; particles.length = 0;
      player.y = WORLD.h - GROUND_H - player.r + 20; player.vy = 0; player.state='calmado'; player.mareo=0;
      panel.classList.remove('show'); hint.style.display = '';
      bgStage = 0; currentBg = IMG.fondos.calc;
      initClouds();
      gameOver = false;
      screenShake = 0; flashAlpha = 0;
      playMusic(MUSIC.base);
      updateBestDisplay();
    }

    function updateBestDisplay(){
      bestScoreEl.textContent = "Mejor: " + (POINTS.best||0);
      menuBestEl.textContent = "Mejor puntuaciÃ³n: " + (POINTS.best||0);
    }

    // game over handling
    function toGameOver(msg){
      panelMsg.textContent = msg || "Has gritado al vacÃ­o zenâ€¦";
      panel.classList.add('show');
      gameOver = true;
      stopMusic();
      // stop loop will be done in update by early return or cancel
    }

    // shake / flash helpers
    function triggerShake(sec=0.35){ screenShake = Math.max(screenShake, sec); }
    function triggerFlash(alpha=0.9){ flashAlpha = Math.max(flashAlpha, alpha); setTimeout(()=>{ flashAlpha = 0; }, 150); }

    // update loop
    let lastTime = performance.now();
    function update(dt){
      if(gameOver) return; // early return: stop updating entities when game over

      // background change by points
      if(POINTS.total >= 85 && bgStage < 2){
        bgStage = 2;
        setTimeout(()=>playSfx('woosh',0.8), 120);
        currentBg = IMG.fondos.helado;
      } else if(POINTS.total >= 50 && bgStage < 1){
        bgStage = 1;
        setTimeout(()=>playSfx('woosh',0.7), 120);
        currentBg = IMG.fondos.desierto;
      }

      // suelo scroll
      for(let s of sueloScroll){ s.x -= SPEED.scroll * dt; if(s.x <= -WORLD.w) s.x += WORLD.w * 2; }

      // clouds
      for(const c of CLOUD.list){
        c.x -= c.speed * dt;
        if(c.x + c.w < 0){
          c.x = WORLD.w + rand(10,100);
          c.y = rand(50, WORLD.h/2);
        }
      }

      // spawn
      SPAWN.timer += dt; SPAWN.diffTimer += dt;
      if(SPAWN.timer >= SPAWN.interval){
        SPAWN.timer = 0;
        spawnObstacle();
      }
      if(SPAWN.diffTimer >= 10){
        SPAWN.diffTimer = 0;
        SPEED.scroll = Math.min(SPEED.scroll + SPEED.inc, SPEED.max);
        SPAWN.interval = Math.max(SPAWN.min, SPAWN.interval - 0.05);
      }

      // inhaling input physics (ascenso mÃ¡s rÃ¡pido)
      if(isDown && CHARGE.cooldown <= 0){
        player.state = 'inhalando';
        // give stronger upward acceleration (less smoothing)
        player.vy += PHYSICS.inhaleForce * dt;
        CHARGE.value = Math.min(CHARGE.max, CHARGE.value + CHARGE.rate * dt);
        if(!wasInhaling){ playSfx('inhalar', 0.25); inhaleSfxTimer = 0; } else {
          inhaleSfxTimer += dt;
          if(inhaleSfxTimer >= 0.5){ playSfx('inhalar', 0.25); inhaleSfxTimer = 0; }
        }
      }
      wasInhaling = isDown && CHARGE.cooldown <= 0;

      // gravity + pos
      player.vy += PHYSICS.gravity * dt;
      if(player.vy > PHYSICS.maxVy) player.vy = PHYSICS.maxVy;
      player.y += player.vy * dt;

      const sueloTop = WORLD.h - GROUND_H - player.r;
      if(player.y > sueloTop){ player.y = sueloTop; player.vy = 0; }
      // limit top (avoid leaving screen)
      if(player.y < 140){ player.y = 140; player.vy = 0; }

      // release -> pulse (grito)
      if(justReleased){
        justReleased = false;
        if(CHARGE.cooldown <= 0){
          const t = CHARGE.value / CHARGE.max;
          const rad = PULSE.base + t * (PULSE.max - PULSE.base);
          pulses.push({ x: player.x + 40, y: player.y, rad, life: PULSE.life });
          CHARGE.cooldown = CHARGE.cooldownBase;
          CHARGE.value = 0;
          player.state = 'gritando';
          playGritoFull(); // full sound, reduced volume
          triggerShake(0.25); triggerFlash(0.9);
        }
        inhaleSfxTimer = 0;
      }

      // cooldown reduce
      if(CHARGE.cooldown > 0) CHARGE.cooldown = Math.max(0, CHARGE.cooldown - dt);
      if(!isDown && CHARGE.cooldown === 0 && player.state !== 'mareado') player.state = 'calmado';

      // pulses life and collision vs obstacles
      for(let i = pulses.length - 1; i >= 0; i--){
        const p = pulses[i];
        p.life -= dt;
        if(p.life <= 0){ pulses.splice(i,1); continue; }
        for(let j = obstacles.length - 1; j >= 0; j--){
          const o = obstacles[j];
          if(dist2(p.x,p.y,o.x,o.y) <= (p.rad + o.r)*(p.rad + o.r)){
            // pop obstacle
            obstacles.splice(j,1);
            POINTS.total += 2;
            playSfx('recolectar', 0.6);
            // small flash/pop
            triggerFlash(0.4);
          }
        }
      }

      // move obstacles & bananas (using their speeds)
      for(let i = obstacles.length - 1; i >= 0; i--){
        const o = obstacles[i];
        o.x -= o.speed * dt;
        if(o.x < -120) obstacles.splice(i,1);
      }
      for(let i = bananas.length - 1; i >= 0; i--){
        const b = bananas[i];
        b.x -= b.speed * dt;
        if(b.x < -120) bananas.splice(i,1);
      }

      // collisions: obstacles with player -> game over
      for(let i = obstacles.length - 1; i >= 0; i--){
        const o = obstacles[i];
        if(dist2(o.x,o.y,player.x,player.y) <= (o.r + player.r)*(o.r + player.r)){
          playSfx('chocar', 0.6); // you said you'll replace chocar file, volume medium
          triggerShake(0.6); triggerFlash(0.95);
          toGameOver(["El erizo se quedÃ³ sin aireâ€¦","Has gritado al vacÃ­o. El vacÃ­o gritÃ³ de vuelta.","Chocaste contra la iluminaciÃ³nâ€¦","Tu zen se fue por el paraguas roto.","El universo respondiÃ³ con un plÃ¡tano invisible."][Math.floor(Math.random()*5)]);
          cancelAnimationFrame(loopId);
          return;
        }
      }

      // bananas collection
      for(let i = bananas.length - 1; i >= 0; i--){
        const b = bananas[i];
        if(dist2(b.x,b.y,player.x,player.y) <= (b.r + player.r)*(b.r + player.r)){
          bananas.splice(i,1);
          if(b.kind === 'cuenco'){ POINTS.total += 5; playSfx('recolectar', 0.8); }
          else { POINTS.total += 1; playSfx('recolectar', 0.75); }
        }
      }

      // particles (simple)
      for(let i = particles.length - 1; i >= 0; i--){
        const p = particles[i];
        p.x += p.vx * dt; p.y += p.vy * dt; p.life -= dt*0.5;
        if(p.life <= 0) particles.splice(i,1);
      }

      // HUD and charge bar
      scoreEl.textContent = "Puntos: " + POINTS.total;
      zenFill.style.width = (CHARGE.value / CHARGE.max) * 100 + "%";
      zenFill.parentElement.classList.toggle('cooldown', CHARGE.cooldown > 0);

      // cloud/particle/other small effects updated above

      // shake decay
      screenShake = Math.max(0, screenShake - dt);
      flashAlpha = Math.max(0, flashAlpha - dt*6);

      // blink / parpadeo timer
      player.blinkTimer -= dt;
      if(player.blinkTimer <= 0 && player.blinkFrame <= 0){
        player.state = 'parpadeo';
        player.blinkFrame = 0.12; // 120ms blink
        player.blinkTimer = rand(2.5,6);
      }
      if(player.blinkFrame > 0){
        player.blinkFrame -= dt;
        if(player.blinkFrame <= 0){
          player.state = 'calmado';
          player.blinkFrame = 0;
        }
      }
    } // update end

    // draw loop
    function draw(){
      // handle shake transform
      ctx.save();
      if(screenShake > 0){
        const amp = Math.min(12, screenShake * 40);
        const tx = (Math.random()*2-1) * amp;
        const ty = (Math.random()*2-1) * amp;
        ctx.translate(tx, ty);
      }
      // background
      ctx.clearRect(0,0,WORLD.w,WORLD.h);
      if(currentBg) ctx.drawImage(currentBg, 0, 0, WORLD.w, WORLD.h);
      else { ctx.fillStyle = '#1b1b1f'; ctx.fillRect(0,0,WORLD.w,WORLD.h); }

      // If gameOver, draw ONLY the background (user asked no clouds). Then restore and exit.
      if(gameOver){
        ctx.restore();
        // draw panel is DOM-managed (panel shown). stop drawing other entities.
        return;
      }

      // clouds
      for(let pass=0; pass<3; pass++){
        for(const c of CLOUD.list){
          if(c.band !== pass) continue;
          if(c.img) ctx.drawImage(c.img, c.x, c.y, c.w, c.h);
        }
      }

      // bananas
      for(const b of bananas){
        if(b.kind === 'cuenco' && IMG.cuenco) ctx.drawImage(IMG.cuenco, b.x - b.r, b.y - b.r, b.r*2, b.r*2);
        else if(IMG.banana) ctx.drawImage(IMG.banana, b.x - b.r, b.y - b.r, b.r*2, b.r*2);
        else { ctx.fillStyle = '#facc15'; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); }
      }

      // obstacles
      for(const o of obstacles){
        const img = IMG.obstaculos[o.kind] || null;
        if(img) ctx.drawImage(img, o.x - o.r, o.y - o.r, o.r*2, o.r*2);
        else { ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(o.x,o.y,o.r,0,Math.PI*2); ctx.fill(); }
      }

      // pulses
      for(const p of pulses){
        const alpha = Math.max(0, p.life / PULSE.life);
        ctx.strokeStyle = `rgba(99,102,241,${alpha})`;
        ctx.lineWidth = 6;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.rad, 0, Math.PI*2); ctx.stroke();
      }

      // ground
      for(const s of sueloScroll){
        if(IMG.suelo) ctx.drawImage(IMG.suelo, s.x, WORLD.h - GROUND_H, WORLD.w, GROUND_H);
      }

      // particles
      for(const p of particles){
        ctx.fillStyle = (p.color || 'rgba(255,255,255,') + Math.max(0,p.life) + ')';
        ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
      }

      // zen aura (subtle)
      const pulseVal = 0.6 + 0.2 * Math.sin(performance.now()/300);
      ctx.fillStyle = `rgba(255,255,255,${0.25 * pulseVal})`;
      ctx.beginPath(); ctx.arc(player.x, player.y, 60, 0, Math.PI*2); ctx.fill();

      // erizo sprite (state chooses image)
      let erizoImg = IMG.erizo.calmado;
      if(player.state === 'inhalando') erizoImg = IMG.erizo.inhalando;
      else if(player.state === 'gritando') erizoImg = IMG.erizo.gritando;
      else if(player.state === 'parpadeo') erizoImg = IMG.erizo.parpadeo || IMG.erizo.calmado;
      if(erizoImg) ctx.drawImage(erizoImg, player.x - player.r, player.y - player.r, player.r*2, player.r*2);

      // flash overlay (small white flash when triggered)
      if(flashAlpha > 0){
        ctx.fillStyle = `rgba(255,255,255,${Math.min(0.9, flashAlpha)})`;
        ctx.fillRect(0,0,WORLD.w,WORLD.h);
      }

      ctx.restore();
    }

    // main frame
    function frame(now){
      const dt = Math.min(0.033, (now - lastTime) / 1000);
      lastTime = now;
      update(dt);
      draw();
      if(!gameOver) loopId = requestAnimationFrame(frame);
    }

    // input handling (consider in-screen only)
    function withinCanvas(clientX, clientY){
      const rect = canvas.getBoundingClientRect();
      const x = (clientX - rect.left) * (canvas.width / rect.width);
      const y = (clientY - rect.top) * (canvas.height / rect.height);
      return x >= 0 && x <= canvas.width && y >= 0 && y <= canvas.height;
    }
    canvas.addEventListener('pointerdown', async (e) => {
      // ensure click inside canvas
      if(!withinCanvas(e.clientX, e.clientY)) return;
      isDown = true; e.preventDefault(); hint.style.display = 'none';
      if(document.hidden) return;
      try{ if(typeof AudioContext !== 'undefined') (new AudioContext()).resume().catch(()=>{}); }catch(e){}
    });
    window.addEventListener('pointerup', (e) => {
      if(!isDown) return;
      isDown = false; justReleased = true; e.preventDefault();
    });

    // restart button
    btnRestart.addEventListener('click', ()=>{
      // hide panel, reset & restart loop
      panel.classList.remove('show');
      resetAll();
      lastTime = performance.now();
      requestAnimationFrame(frame);
    });

    // countdown for start (uses random 3 images + GO)
    const COUNT_IMAGES = [
      "assets/contador_arbol.png","assets/contador_calcetin.png","assets/contador_leche.png",
      "assets/contador_cuenco.png","assets/contador_antena.png","assets/contador_seta.png",
      "assets/contador_coche.png","assets/contador_lapiz.png","assets/contador_paraguas.png","assets/contador_helado.png"
    ];
    const COUNT_GO = "assets/contador_go.png";
    function showCountdown(onDone){
      let pool = COUNT_IMAGES.slice();
      let seq = [];
      for(let i=0;i<3;i++){ const idx = Math.floor(Math.random()*pool.length); seq.push(pool.splice(idx,1)[0]); }
      seq.push(COUNT_GO);
      let i = 0;
      countdownEl.classList.add('show');
      function next(){
        if(i < seq.length){
          countNum.innerHTML = `<img src="${seq[i]}" alt="count">`;
          playSfx('gong', 0.7);
          i++;
          setTimeout(next, 900); // slightly faster so zoom is noticeable
        } else {
          countdownEl.classList.remove('show');
          if(typeof onDone === 'function') onDone();
        }
      }
      next();
    }

    // loader rotation
    const LOADER_IMGS = ["assets/loader.png","assets/loader1.png","assets/loader2.png","assets/loader3.png"];
    loaderImg.src = LOADER_IMGS[Math.floor(Math.random()*LOADER_IMGS.length)];

    // game start binding
    btnStart.addEventListener('click', ()=>{
      menuPanel.classList.remove('show');
      showCountdown(()=>{
        resetAll();
        lastTime = performance.now();
        playMusic(MUSIC.base);
        requestAnimationFrame(frame);
      });
    });

    // expose best score
    updateBestDisplay();

    // start loading all assets; hide loader when done (or after minimal time)
    const minLoader = 600;
    const t0 = Date.now();
    loadAll().then(()=>{
      initClouds();
      const waited = Math.max(0, minLoader - (Date.now()-t0));
      setTimeout(()=>{ loader.style.display = 'none'; }, waited);
    });

    // ensure music stops at gameOver: we stopMusic when toGameOver called

    // keyboard fallback (space for touch)
    window.addEventListener('keydown', (e)=>{
      if(e.code === 'Space'){ isDown = true; e.preventDefault(); }
    });
    window.addEventListener('keyup', (e)=>{
      if(e.code === 'Space'){ isDown = false; justReleased = true; e.preventDefault(); }
    });

    // update best on unload (not necessary but safe)
    window.addEventListener('beforeunload', ()=>{ localStorage.setItem('bestScore', POINTS.best || 0); });

  })();
  </script>
</body>
</html>
