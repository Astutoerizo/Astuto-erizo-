<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Astuto Erizo - Respira y Grita</title>
  <style>
    html, body { margin:0; height:100%; background:#0e0e10; color:#fff; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; }
    #wrap { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; }
    canvas { background:#1b1b1f; touch-action:none; display:block; }
    .hud {
      position: fixed; top: 8px; left: 50%; transform: translateX(-50%);
      width: min(92vw, 540px); pointer-events:none;
      display:flex; align-items:center; gap:12px; justify-content:space-between;
      font-weight:600; z-index: 50;
    }
    .bar { flex:1; height:14px; background:#3a3a44; border-radius:999px; overflow:hidden; border:2px solid #6ee7b7; box-shadow:0 0 6px rgba(110,231,183,0.6) inset; }
    .fill { height:100%; width:0%; background:#86efac; transition: width .08s linear; }
    .cooldown { opacity:.45; }
    .score { min-width:100px; text-align:right; }
    .hud-btn { pointer-events:auto; cursor:pointer; padding:4px 8px; background:#24242a; border-radius:6px; font-size:13px; user-select:none; }
    .toast {
      position:fixed; bottom:14px; left:50%; transform:translateX(-50%);
      background:#24242a; border:1px solid #333; padding:8px 12px; border-radius:10px; font-size:14px; opacity:.95; z-index: 40;
    }
    .panel {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.45); transition:opacity .2s ease; z-index: 60;
    }
    .panel.show { display:flex; opacity:1; pointer-events:auto; }
    .card {
      background:#1e1e24; border:1px solid #333; border-radius:16px; padding:20px; width:min(92vw, 420px); text-align:center;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .btn {
      display:inline-block; margin-top:12px; padding:10px 16px; border-radius:12px; background:#6ee7b7; color:#0b0b0d;
      font-weight:700; cursor:pointer; user-select:none;
    }
    /* Overlay de cuenta atr√°s */
    #countdown {
      position: fixed; inset: 0;
      display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,.45); backdrop-filter: blur(2px);
      z-index: 999;
    }
    #countdown.show { display: flex; }
    #countdown #countNum img {
      max-width: 60%; height: auto; display: block; margin: 0 auto; animation: zoomIn .55s ease;
    }
    @keyframes zoomIn { from { transform: scale(.5); opacity: 0 } to { transform: scale(1); opacity:1 } }

    /* Loader */
    #loader {
      position:fixed; inset:0;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      background:#0e0e10; z-index: 2000;
    }
    #loader img { max-width: 200px; animation: float 1.8s ease-in-out infinite; display:block; }
    #loader p { margin-top: 12px; font-size: 18px; color: #6ee7b7; font-weight: bold; animation: blink 1.2s infinite; }
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-18px); } }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

    /* small helper for boss/banner */
    #banner {
      position: fixed; top: 10vh; left: 50%; transform: translateX(-50%); z-index: 1200; display:none;
      pointer-events:none;
    }
    #banner img { max-width: 56vw; display:block; margin:0 auto; filter: drop-shadow(0 6px 24px rgba(0,0,0,.6)); }

    /* flash overlay */
    #flash {
      pointer-events:none; position:fixed; inset:0; background: #fff; opacity:0; transition:opacity .12s linear; z-index:3000;
    }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader">
    <img id="loaderImg" src="assets/loader.png" alt="Cargando...">
    <p>Loading...</p>
  </div>

  <div id="wrap"><canvas id="game" width="540" height="960"></canvas></div>

  <div class="hud">
    <div class="bar" style="pointer-events:none"><div class="fill" id="zenFill"></div></div>
    <div class="score" id="score">Puntos: 0</div>
    <div class="score" id="bestScore">Mejor: 0</div>
    <div class="hud-btn" id="btnMusic" title="Activar / Desactivar m√∫sica">üîä</div>
  </div>

  <div class="panel" id="panel">
    <div class="card">
      <h2>Astuto Erizo</h2>
      <p id="panelMsg">Has gritado al vac√≠o zen‚Ä¶</p>
      <div class="btn" id="btnRestart">Reintentar</div>
      <p style="opacity:.7; font-size:12px; margin-top:8px;">Mant√©n pulsado para inhalar ¬∑ Suelta para gritar</p>
    </div>
  </div>

  <div class="toast" id="hint">Mant√©n pulsado para inhalar ¬∑ Suelta para gritar</div>

  <!-- Menu -->
  <div class="panel show" id="menuPanel">
    <div class="card">
      <img src="assets/logo_videojuego.png" alt="Astuto Erizo" style="max-width: 280px; margin-bottom: 12px;">
      <h2>Respira y Grita</h2>
      <p id="menuBest">Mejor puntuaci√≥n: 0</p>
      <p>Cuando est√©s listo, pulsa jugar y respira profundo‚Ä¶</p>
      <div class="btn" id="btnStart">Jugar</div>
      <p style="opacity:.7; font-size:12px; margin-top:10px;">Mant√©n pulsado para inhalar ¬∑ Suelta para gritar</p>
    </div>
  </div>

  <!-- Banner for boss/bonus -->
  <div id="banner"><img id="bannerImg" src="" alt=""></div>

  <!-- Countdown -->
  <div id="countdown"><div id="countNum"></div></div>

  <!-- Flash -->
  <div id="flash"></div>

  <script>
  (function(){
    // ============================
    // CONFIG / STATE
    // ============================
    const TEST_MODE = true; // dejar true para pruebas r√°pidas
    const BOSS_SCORE  = TEST_MODE ? 5  : 50; // puntuaci√≥n para entrar BOSS
    const BONUS_SCORE = TEST_MODE ? 20 : 75; // puntuaci√≥n para BONUS
    const BOSS_DURATION = 10; // segundos
    const BONUS_DURATION = 10; // segundos

    const WORLD = { w: 540, h: 960 };
    const SPEED = { scroll: 280, inc: 20, max: 520 };
    const SPAWN = { interval: 1.2, min: 0.7, timer: 0, diffTimer: 0 };
    const CHARGE = { value:0, rate:80, max:100, over:85, cooldown:0, cooldownBase:1.0 }; // rate aumentado (ascenso m√°s r√°pido)
    const PULSE  = { base:120, max:380, life:0.25 };
    const POINTS = { total:0, best: parseInt(localStorage.getItem("bestScore")||"0") };
    const PHYSICS = { gravity: 700, inhaleForce: -1400, maxVy: 900 }; // m√°s respuesta al inhalar
    const GROUND_H = 180;

    // flags
    let bgStage = 0;
    let currentBg = null;
    let gameOver = false;
    let inBossPhase = false;
    let inBonusPhase = false;
    let bossTimer = 0;
    let bonusTimer = 0;
    let bossInstance = null;

    // DOM
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const zenFill = document.getElementById('zenFill');
    const scoreEl = document.getElementById('score');
    const bestScoreEl = document.getElementById('bestScore');
    const menuBestEl = document.getElementById('menuBest');
    const panel = document.getElementById('panel');
    const panelMsg = document.getElementById('panelMsg');
    const btnRestart = document.getElementById('btnRestart');
    const hint = document.getElementById('hint');
    const loader = document.getElementById('loader');
    const loaderImg = document.getElementById('loaderImg');
    const btnMusic = document.getElementById('btnMusic');
    const menuPanel = document.getElementById('menuPanel');
    const btnStart = document.getElementById('btnStart');
    const countdownEl = document.getElementById('countdown');
    const countNum = document.getElementById('countNum');
    const banner = document.getElementById('banner');
    const bannerImg = document.getElementById('bannerImg');
    const flash = document.getElementById('flash');

    updateBestDisplays();

    // ============================
    // AUDIO
    // ============================
    const SFX = {
      grito: "assets/sonido_bowl_limpio.mp3",
      recolectar: "assets/sonido_recolectar_platano.mp3",
      inhalar: "assets/sonido_inhalar.mp3",
      chocar: "assets/sonido_chocar.mp3",
      woosh: "assets/woosh.mp3",
      gong: "assets/gong.mp3",
      unlock: "assets/unlock.mp3"
    };
    function playSfx(name, volume=1.0){
      const src = SFX[name];
      if(!src) return;
      const a = new Audio(src);
      a.volume = volume;
      a.play().catch(()=>{});
    }

    // Music tracks (looped)
    const MUSIC = {
      base: new Audio("assets/musica_base.mp3"),
      bonus: new Audio("assets/musica_bonus.mp3"),
      boss: new Audio("assets/musica_boss.mp3")
    };
    for(let k in MUSIC){
      MUSIC[k].loop = true;
      MUSIC[k].volume = 0.45;
    }
    let musicEnabled = true;
    let currentMusic = MUSIC.base;
    function playMusic(track){
      if(!musicEnabled) return;
      try {
        if(currentMusic && !currentMusic.paused){ currentMusic.pause(); currentMusic.currentTime = 0; }
        currentMusic = track;
        currentMusic.play().catch(()=>{});
      } catch(e){}
    }
    function toggleMusic(){
      musicEnabled = !musicEnabled;
      if(musicEnabled){ btnMusic.textContent = "üîä"; playMusic(currentMusic); }
      else { btnMusic.textContent = "üîá"; if(currentMusic) currentMusic.pause(); }
    }
    btnMusic.addEventListener('click', toggleMusic);

    // ============================
    // ASSETS (paths)
    // ============================
    const ASSETS = {
      fondos: {
        calc: "assets/fondo_calc.png",
        desierto: "assets/fondo_desierto.png",
        helado: "assets/fondo_helado.png"
      },
      bonusBg: "assets/bonus/fondo_bonus.png",
      erizo: {
        calmado: "assets/calmado.png",
        inhalando: "assets/respirando.png",
        gritando: "assets/gritando.png",
        parpadeo: "assets/erizo_parpadeo.png" // subido por ti
      },
      obstaculos: ["assets/paraguas.png","assets/helado_meditando.png"],
      banana: "assets/platano_puntos.png",
      suelo: "assets/suelo.png",
      cuenco: "assets/cuenco_tibetano.png",
      nubes: ["assets/nubes/nube1.png","assets/nubes/nube2.png","assets/nubes/nube3.png","assets/nubes/nube4.png"],
      loaderSet: ["assets/loader.png","assets/loader1.png","assets/loader2.png","assets/loader3.png"],
      countdownImages: [
        "assets/contador_arbol.png","assets/contador_calcetin.png","assets/contador_leche.png","assets/contador_cuenco.png",
        "assets/contador_antena.png","assets/contador_seta.png","assets/contador_coche.png","assets/contador_lapiz.png",
        "assets/contador_paraguas.png","assets/contador_helado.png"
      ],
      countdownGo: "assets/contador_go.png",
      // boss assets (folder)
      boss: {
        folder: "assets/boss/",
        bossImg: "assets/boss/pasta_feroz.png",
        cuidado: "assets/boss/cuidado_espuma.png",
        contadorFolder: "assets/boss/", // contains 1.png..10.png
        foamVariants: [
          "assets/boss/espuma_boss.png",
          "assets/boss/espuma_boss1.png",
          "assets/boss/espuma_boss2.png",
          "assets/boss/espuma_boss3.png"
        ]
      },
      // bonus assets
      bonus: {
        banner: "assets/bonus/coge_todo.png",
        fondo: "assets/bonus/fondo_bonus.png",
        patito1: "assets/bonus/patito1.png",
        patito2: "assets/bonus/patito2.png"
      }
    };

    // ============================
    // GAME ENTITIES & STATE
    // ============================
    let scale = 1, offsetX = 0, offsetY = 0;
    function fit(){
      const vw = window.innerWidth, vh = window.innerHeight;
      const s = Math.min(vw / WORLD.w, vh / WORLD.h);
      scale = s; offsetX = (vw - WORLD.w * s)/2; offsetY = (vh - WORLD.h * s)/2;
      canvas.style.width = WORLD.w * s + 'px';
      canvas.style.height = WORLD.h * s + 'px';
    }
    window.addEventListener('resize', fit); fit();

    // input
    let isDown = false, justReleased = false, wasInhaling = false;
    let inhaleSfxTimer = 0;
    function withinCanvas(clientX, clientY){
      const x = (clientX - offsetX) / scale, y = (clientY - offsetY) / scale;
      return (x >= 0 && x <= WORLD.w && y >= 0 && y <= WORLD.h);
    }
    canvas.addEventListener('pointerdown', async (e) => {
      if (!withinCanvas(e.clientX, e.clientY)) return;
      isDown = true; e.preventDefault(); hint.style.display = 'none';
      // resume currentMusic on interaction (autoplay policies)
      if(musicEnabled && currentMusic && currentMusic.paused){ currentMusic.play().catch(()=>{}); }
    });
    window.addEventListener('pointerup', (e) => {
      if (!isDown) return;
      isDown = false; justReleased = true; e.preventDefault();
    });

    // entities
    const player = { x: 140, y: WORLD.h - 260, r: 42, state: 'calmado', vy: 0, mareo: 0 };
    const sueloScroll = [{x:0},{x:WORLD.w}];
    const obstacles = [], bananas = [], pulses = [], particles = [], bonusItems = [];
    const CLOUD = { list: [] };

    // helper util
    const rand = (a,b) => a + Math.random()*(b-a);
    const chance = (p) => Math.random() < p;
    function dist2(ax,ay,bx,by){ const dx=ax-bx, dy=ay-by; return dx*dx+dy*dy; }

    // ============================
    // IMAGE LOADING
    // ============================
    const IMG = {
      fondos: { calc:null, desierto:null, helado:null },
      bonusBg: null,
      erizo: {},
      obstaculos: [],
      banana: null,
      suelo: null,
      cuenco: null,
      nubes: [],
      loaderImgs: [],
      countdownImgs: [],
      countdownGo: null,
      boss: { bossImg: null, cuidado: null, foams: [], numbers: [] },
      bonus: { banner: null, patito1: null, patito2: null }
    };

    function loadImage(src){ return new Promise(res => { if(!src) return res(null); const im = new Image(); im.onload = ()=>res(im); im.onerror = ()=>{ console.warn("img error",src); res(null); }; im.src = src; }); }

    async function loadAll(){
      // fondos
      IMG.fondos.calc = await loadImage(ASSETS.fondos.calc);
      IMG.fondos.desierto = await loadImage(ASSETS.fondos.desierto);
      IMG.fondos.helado = await loadImage(ASSETS.fondos.helado);
      IMG.bonusBg = await loadImage(ASSETS.bonus.fondo);

      // erizo sprites
      IMG.erizo.calmado = await loadImage(ASSETS.erizo.calmado);
      IMG.erizo.inhalando = await loadImage(ASSETS.erizo.inhalando);
      IMG.erizo.gritando = await loadImage(ASSETS.erizo.gritando);
      IMG.erizo.parpadeo = await loadImage(ASSETS.erizo.parpadeo);

      // obstaculos
      for(let s of ASSETS.obstaculos) IMG.obstaculos.push(await loadImage(s));
      IMG.banana = await loadImage(ASSETS.banana);
      IMG.suelo = await loadImage(ASSETS.suelo);
      IMG.cuenco = await loadImage(ASSETS.cuenco);

      // nubes
      for(let s of ASSETS.nubes) IMG.nubes.push(await loadImage(s));

      // loader images
      for(let s of ASSETS.loaderSet) IMG.loaderImgs.push(await loadImage(s));

      // countdown images
      for(let s of ASSETS.countdownImages) IMG.countdownImgs.push(await loadImage(s));
      IMG.countdownGo = await loadImage(ASSETS.countdownGo);

      // boss assets
      IMG.boss.bossImg = await loadImage(ASSETS.boss.bossImg);
      IMG.boss.cuidado = await loadImage(ASSETS.boss.cuidado);
      for(let s of ASSETS.boss.foamVariants) IMG.boss.foams.push(await loadImage(s));
      // numbers 1..10 in folder
      for(let i=1;i<=10;i++){
        const p = ASSETS.boss.folder + i + ".png";
        IMG.boss.numbers.push(await loadImage(p));
      }

      // bonus assets
      IMG.bonus.banner = await loadImage(ASSETS.bonus.banner);
      IMG.bonus.patito1 = await loadImage(ASSETS.bonus.patito1);
      IMG.bonus.patito2 = await loadImage(ASSETS.bonus.patito2);
    }

    // ============================
    // CLOUDS INIT
    // ============================
    function initClouds(){
      CLOUD.list = [];
      for(let i=0;i<10;i++){
        const band = Math.floor(rand(0,3));
        const img = IMG.nubes.length ? IMG.nubes[Math.floor(rand(0, IMG.nubes.length))] : null;
        CLOUD.list.push({ x: rand(0, WORLD.w), y: rand(40, WORLD.h/2), w: rand(80, 180), h: rand(50, 100), speed: 20 + band*40, band, img });
      }
    }

    // ============================
    // RESET / START / RESTART
    // ============================
    function resetAll(toBoss=false){
      POINTS.total = 0;
      CHARGE.value = 0; CHARGE.cooldown = 0;
      SPEED.scroll = 280; SPAWN.interval = 1.2; SPAWN.timer = 0; SPAWN.diffTimer = 0;
      obstacles.length = bananas.length = pulses.length = particles.length = bonusItems.length = 0;
      player.y = WORLD.h - GROUND_H - player.r + 20; player.vy = 0; player.state = 'calmado'; player.mareo = 0;
      panel.classList.remove('show'); hint.style.display = '';
      bgStage = 0; currentBg = IMG.fondos.calc;
      initClouds();
      gameOver = false;
      inBossPhase = false; inBonusPhase = false; bossTimer = 0; bonusTimer = 0; bossInstance = null;
      // start base music
      if(musicEnabled){ playMusic(MUSIC.base); }
      // if forced to boss:
      if(toBoss) startBossSequence();
    }

    btnRestart.addEventListener('click', ()=> {
      // On restart: if last death was in boss and we want to restart boss, handle accordingly
      resetAll(inBossPhase); // if in boss, restart boss instantly
      lastFrame = performance.now();
      requestAnimationFrame(loop);
      if(musicEnabled) playMusic(currentMusic || MUSIC.base);
    });

    // ============================
    // SPAWNER
    // ============================
    function spawnObstacle(){
      const y = rand(240, WORLD.h - 200);
      const r = rand(44,70);
      const speed = Math.min(SPEED.scroll + rand(0,60), SPEED.max);
      obstacles.push({ x: WORLD.w + 80, y, r, speed, kind: Math.floor(rand(0, IMG.obstaculos.length)) });
      if(chance(0.3)) bananas.push({ x: WORLD.w + 110, y: rand(220, WORLD.h - 200), r: 40, speed: speed + 40, kind:'banana' });
      if(chance(0.08)) bananas.push({ x: WORLD.w + 150, y: rand(220, WORLD.h - 200), r: 40, speed: speed + 20, kind:'cuenco' });
    }

    // bonus spawn (patitos)
    function spawnBonusItem(){
      const side = Math.random() < 0.5 ? -60 : WORLD.w + 60;
      const vx = side < 0 ? 160 : -160;
      const kind = Math.random() < 0.65 ? 'patito1' : 'patito2';
      bonusItems.push({ x: side, y: rand(240, WORLD.h - 220), vx, vy: rand(-30,30), kind, r: 36 });
    }

    // ============================
    // BOSS LOGIC
    // ============================
    function startBossSequence(){
      inBossPhase = true;
      inBonusPhase = false;
      // freeze normal spawns by not adding new spawn in update
      // show banner "cuidado_espuma.png" for 2s
      showBanner(IMG.boss.cuidado, 2000).then(()=> {
        // bring in boss - create bossInstance
        bossInstance = {
          x: WORLD.w + 300,
          y: WORLD.h/2 - 120,
          w: Math.min(WORLD.w * 0.9, 520),
          h: Math.min(WORLD.h * 0.9, 520),
          state: 'enter',
          vx: -320,
          t: 0
        };
        // switch music
        if(musicEnabled){ playMusic(MUSIC.boss); }
        // boss enters; after short delay start firing and countdown
        setTimeout(()=> {
          bossInstance.state = 'active';
          bossInstance.t = 0;
          bossTimer = BOSS_DURATION;
          // start boss fire loop (handled in update)
        }, 700);
      });
    }

    // Show banner overlay for ms milliseconds
    function showBanner(img, ms){
      return new Promise(res=>{
        if(!img){ res(); return; }
        bannerImg.src = img.src || img;
        banner.style.display = 'block';
        setTimeout(()=>{ banner.style.display = 'none'; res(); }, ms);
      });
    }

    function bossFireOne(){
      if(!bossInstance) return;
      // spawn foam from boss area across the screen with varied velocities
      const foamImg = IMG.boss.foams[Math.floor(rand(0, IMG.boss.foams.length))];
      // Many foam projectiles across whole screen (more intense)
      const count = Math.floor(rand(2,6));
      for(let i=0;i<count;i++){
        const sx = bossInstance.x - rand(20,60);
        const sy = bossInstance.y + rand(-bossInstance.h*0.45, bossInstance.h*0.45);
        const ang = rand(-0.9, 0.9);
        const speed = rand(120, 360);
        const vx = Math.cos(ang) * -speed + rand(-30,30);
        const vy = Math.sin(ang) * speed * 0.2 + rand(-60,60);
        pulses.push({ x: sx, y: sy, vx, vy, life: 6.0, rad: 24, img: foamImg, bossProjectile: true });
      }
    }

    // ============================
    // BONUS PHASE
    // ============================
    function startBonusSequence(){
      inBonusPhase = true;
      inBossPhase = false;
      // show small banner for 2s
      showBanner(IMG.bonus.banner, 1800).then(()=> {
        // switch to bonus background + music
        currentBg = IMG.bonusBg || IMG.fondos.calc;
        if(musicEnabled) playMusic(MUSIC.bonus);
        bonusTimer = BONUS_DURATION;
        // spawn patitos periodically
      });
    }

    // ============================
    // FX: shake + flash
    // ============================
    function shake(duration=400, magnitude=8){
      const el = document.getElementById('wrap');
      const start = performance.now();
      function s(t){
        const now = performance.now();
        const p = (now - start) / duration;
        if(p >= 1){ el.style.transform = ''; return; }
        const x = (Math.random()*2-1) * magnitude * (1-p);
        const y = (Math.random()*2-1) * magnitude * (1-p);
        el.style.transform = `translate(${x}px, ${y}px)`;
        requestAnimationFrame(s);
      }
      requestAnimationFrame(s);
    }
    function flash(ms=120){
      flash.style.opacity = '0.95';
      setTimeout(()=>{ flash.style.opacity = '0'; }, ms);
    }

    // ============================
    // UPDATE / DRAW / LOOP
    // ============================
    function update(dt){
      // if gameOver, don't update entities
      if(gameOver) return;

      // Background stage unlock
      if(POINTS.total >= (TEST_MODE?10:85) && bgStage < 2){
        currentBg = IMG.fondos.helado; bgStage = 2;
        setTimeout(()=>playSfx('woosh', 0.55), 120);
      } else if(POINTS.total >= (TEST_MODE?5:50) && bgStage < 1){
        currentBg = IMG.fondos.desierto; bgStage = 1;
        setTimeout(()=>playSfx('woosh', 0.55), 120);
      }

      // If in boss phase, skip spawning normal obstacles
      if(!inBossPhase && !inBonusPhase){
        SPAWN.timer += dt; SPAWN.diffTimer += dt;
        if(SPAWN.timer >= SPAWN.interval){
          SPAWN.timer = 0;
          spawnObstacle();
        }
        if(SPAWN.diffTimer >= 10){
          SPAWN.diffTimer = 0;
          SPEED.scroll = Math.min(SPEED.scroll + SPEED.inc, SPEED.max);
          SPAWN.interval = Math.max(SPAWN.min, SPAWN.interval - 0.05);
        }
      } else {
        // During bonus or boss, optionally spawn special items
        if(inBonusPhase){
          // spawn patitos every ~0.9s
          if(Math.random() < dt * 1.1) spawnBonusItem();
        }
      }

      // Player inhaling
      if(isDown && CHARGE.cooldown <= 0 && !inBossPhase){ // disable inhaling if boss banner active? allow user to act though
        player.state = 'inhalando';
        // amplify inhale impulse to make ascent faster/responsive
        const boost = player.vy > 0 ? 2.0 : 1.25;
        player.vy += PHYSICS.inhaleForce * boost * dt;
        CHARGE.value = Math.min(CHARGE.max, CHARGE.value + CHARGE.rate * dt);
        if(!wasInhaling){
          playSfx('inhalar', 0.18);
          inhaleSfxTimer = 0;
        } else {
          inhaleSfxTimer += dt;
          if(inhaleSfxTimer >= 0.5){
            playSfx('inhalar', 0.16);
            inhaleSfxTimer = 0;
          }
        }
      }
      wasInhaling = isDown && CHARGE.cooldown <= 0;

      // physics
      player.vy += PHYSICS.gravity * dt;
      if(player.vy > PHYSICS.maxVy) player.vy = PHYSICS.maxVy;
      player.y += player.vy * dt;

      // clamp top (limit flight)
      if(player.y < 90){
        player.y = 90;
        player.vy = Math.max(player.vy, 0); // don't keep negative vy
      }
      // ground
      const sueloTop = WORLD.h - GROUND_H - player.r;
      if(player.y > sueloTop){ player.y = sueloTop; player.vy = 0; }

      // handle release (pulse/grito)
      if(justReleased){
        justReleased = false;
        if(CHARGE.cooldown <= 0){
          if(CHARGE.value >= CHARGE.over){
            CHARGE.cooldown = 0.7; CHARGE.value = 0; player.state = 'gritando';
            // big shout effect (no destructive if over)
            playSfx('grito', 0.35);
          } else {
            const t = CHARGE.value / CHARGE.max;
            const rad = PULSE.base + t * (PULSE.max - PULSE.base);
            pulses.push({ x: player.x + 40, y: player.y, rad, life: PULSE.life, vx:0, vy:0 });
            CHARGE.cooldown = CHARGE.cooldownBase;
            CHARGE.value = 0; player.state = 'gritando';
            playSfx('grito', 0.35);
          }
        }
        inhaleSfxTimer = 0;
      }

      if(CHARGE.cooldown > 0){
        CHARGE.cooldown = Math.max(0, CHARGE.cooldown - dt);
      }
      if(!isDown && CHARGE.cooldown === 0 && player.state !== 'mareado'){
        player.state = 'calmado';
      }

      // particles update
      for(let i = particles.length -1; i >=0; i--){
        const p = particles[i];
        p.x += (p.vx || 0) * dt;
        p.y += (p.vy || 0) * dt;
        p.life -= dt * 0.5;
        if(p.life <= 0) particles.splice(i,1);
      }

      // pulses (grow/decay and hit obstacles)
      for(let i = pulses.length -1; i >=0; i--){
        const p = pulses[i];
        if(p.vx || p.vy){
          // boss foam projectile moves
          p.x += (p.vx || 0) * dt;
          p.y += (p.vy || 0) * dt;
          p.life -= dt;
          if(p.life <= 0){
            pulses.splice(i,1);
            continue;
          }
        } else {
          // regular pulse life decay
          p.life -= dt;
          if(p.life <= 0){ pulses.splice(i,1); continue; }
        }
        // pulse hits obstacles (regular pulses)
        if(!p.bossProjectile){
          for(let j = obstacles.length -1; j >=0; j--){
            const o = obstacles[j];
            if(dist2(p.x,p.y,o.x,o.y) <= (p.rad + o.r) * (p.rad + o.r)){
              obstacles.splice(j,1);
              POINTS.total += 2;
              playSfx('unlock', 0.25);
            }
          }
        } else {
          // boss projectile (espuma) hits player -> death
          if(dist2(p.x,p.y,player.x,player.y) <= (p.rad + player.r) * (p.rad + player.r)){
            // death during boss: restart boss (per request)
            panelMsg.textContent = "Te alcanz√≥ la espuma feroz...";
            panel.classList.add('show');
            gameOver = true;
            // stop sounds
            stopAllSfx();
            // pause music maybe
            if(musicEnabled) MUSIC.boss.pause();
            // schedule restart in boss
            setTimeout(()=> {
              // restart from boss
              resetAll(true);
              lastFrame = performance.now();
              requestAnimationFrame(loop);
            }, 1200);
          }
        }
      }

      // obstacles movement
      for(let i = obstacles.length -1; i >=0; i--){
        const o = obstacles[i];
        o.x -= o.speed * dt;
        if(o.x < -120) obstacles.splice(i,1);
      }
      // bananas movement
      for(let i = bananas.length -1; i >=0; i--){
        const b = bananas[i];
        b.x -= b.speed * dt;
        if(b.x < -120) bananas.splice(i,1);
      }

      // bonus items motion
      for(let i = bonusItems.length -1; i >=0; i--){
        const it = bonusItems[i];
        it.x += it.vx * dt;
        it.y += it.vy * dt;
        // simple bound bounce on vertical area
        if(it.y < 120 || it.y > WORLD.h - 220) it.vy *= -1;
        // remove when off screen long
        if(it.x < -160 || it.x > WORLD.w + 160) bonusItems.splice(i,1);
      }

      // collisions obstacles <-> player
      for(let i = obstacles.length -1; i >=0; i--){
        const o = obstacles[i];
        if(dist2(o.x, o.y, player.x, player.y) <= (o.r + player.r) * (o.r + player.r)){
          // collision => game over
          playSfx('chocar', 0.9); // user said will change file, volume variable
          panelMsg.textContent = CRASH_MESSAGES[Math.floor(Math.random()*CRASH_MESSAGES.length)];
          panel.classList.add('show');
          gameOver = true;
          stopAllSfx();
          if(musicEnabled && currentMusic) currentMusic.pause();
          return;
        }
      }

      // collisions bananas <-> player
      for(let i = bananas.length -1; i >=0; i--){
        const b = bananas[i];
        if(dist2(b.x, b.y, player.x, player.y) <= (b.r + player.r) * (b.r + player.r)){
          bananas.splice(i,1);
          if(b.kind === 'cuenco'){ POINTS.total += 5; playSfx('recolectar', 0.45); }
          else { POINTS.total += 1; playSfx('recolectar', 0.32); }
        }
      }

      // collisions bonusItems <-> player
      for(let i = bonusItems.length -1; i >=0; i--){
        const it = bonusItems[i];
        if(dist2(it.x, it.y, player.x, player.y) <= (it.r + player.r) * (it.r + player.r)){
          bonusItems.splice(i,1);
          if(it.kind === 'patito1'){ POINTS.total += 1; playSfx('recolectar', 0.32); }
          else { POINTS.total += 2; playSfx('recolectar', 0.4); }
        }
      }

      // HUD update
      scoreEl.textContent = "Puntos: " + POINTS.total;
      zenFill.style.width = (CHARGE.value / CHARGE.max) * 100 + "%";
      zenFill.parentElement.classList.toggle('cooldown', CHARGE.cooldown > 0);

      // Boss behavior update
      if(inBossPhase && bossInstance){
        // move boss in until target position
        if(bossInstance.state === 'enter'){
          bossInstance.x += bossInstance.vx * dt;
          if(bossInstance.x <= WORLD.w - bossInstance.w/1.2){
            bossInstance.state = 'idle';
            bossInstance.vx = 0;
            bossInstance.t = 0;
            // small vibration then active
            setTimeout(()=> { bossInstance.state = 'active'; bossTimer = BOSS_DURATION; }, 600);
          }
        } else if(bossInstance.state === 'active'){
          bossInstance.t += dt;
          // vibrate initially then horizontal sway
          bossInstance.x += Math.sin(performance.now()/120) * 0.6;
          // periodically fire
          if(Math.random() < dt * 1.2){
            bossFireOne();
          }
          // boss timer countdown
          bossTimer -= dt;
          // also show countdown number overlay top-left
          // handled in draw
          if(bossTimer <= 0){
            // boss done
            inBossPhase = false;
            // flash and woosh, revert background and music
            flash(140);
            playSfx('woosh', 0.7);
            if(musicEnabled) playMusic(MUSIC.base);
            // reset background to calc for normal
            currentBg = IMG.fondos.calc;
            bossInstance = null;
            // small delay and resume spawns
          }
        }
      }

      // Bonus timer
      if(inBonusPhase){
        bonusTimer -= dt;
        if(bonusTimer <= 0){
          inBonusPhase = false;
          // revert bg and music
          currentBg = IMG.fondos.calc;
          if(musicEnabled) playMusic(MUSIC.base);
          flash(120); playSfx('woosh', 0.6);
        } else {
          // spawn some bonus items periodically
          if(Math.random() < dt * 1.1) spawnBonusItem();
        }
      }

      // trigger phases when reaching threshold (only if not already)
      if(!inBossPhase && !inBonusPhase && !gameOver){
        if(POINTS.total >= BOSS_SCORE && bgStage >= 1){
          // start boss
          startBossSequence();
        } else if(POINTS.total >= BONUS_SCORE && bgStage >= 0){
          startBonusSequence();
        }
      }
    }

    // ============================
    // DRAW
    // ============================
    function draw(){
      ctx.clearRect(0,0,WORLD.w,WORLD.h);
      // draw background
      if(currentBg) ctx.drawImage(currentBg, 0, 0, WORLD.w, WORLD.h);
      else { ctx.fillStyle = '#1b1b1f'; ctx.fillRect(0,0,WORLD.w,WORLD.h); }

      // if in boss phase but boss not yet active, show only background + banner maybe
      // Draw clouds (unless gameOver AND we want clean background)
      if(!gameOver){
        for(let pass=0; pass<3; pass++){
          for(const c of CLOUD.list){
            if(c.band !== pass) continue;
            if(c.img) ctx.drawImage(c.img, c.x, c.y, c.w, c.h);
          }
        }
      }

      // bonus items (patitos)
      for(const it of bonusItems){
        const im = it.kind === 'patito1' ? IMG.bonus.patito1 : IMG.bonus.patito2;
        if(im) ctx.drawImage(im, it.x - it.r, it.y - it.r, it.r*2, it.r*2);
      }

      // bananas / cuencos
      for(const b of bananas){
        if(b.kind === 'cuenco' && IMG.cuenco) ctx.drawImage(IMG.cuenco, b.x - b.r, b.y - b.r, b.r*2, b.r*2);
        else if(IMG.banana) ctx.drawImage(IMG.banana, b.x - b.r, b.y - b.r, b.r*2, b.r*2);
      }

      // obstacles
      for(const o of obstacles){
        const img = IMG.obstaculos[o.kind] || null;
        if(img) ctx.drawImage(img, o.x - o.r, o.y - o.r, o.r*2, o.r*2);
        else { ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(o.x,o.y,o.r,0,Math.PI*2); ctx.fill(); }
      }

      // pulses (boss foam as images or shock circles)
      for(const p of pulses){
        if(p.img){
          // draw foam image centered
          ctx.drawImage(p.img, p.x - p.rad, p.y - p.rad, p.rad*2, p.rad*2);
        } else {
          const alpha = Math.max(0, p.life / PULSE.life);
          ctx.strokeStyle = `rgba(99,102,241,${alpha})`;
          ctx.lineWidth = 6;
          ctx.beginPath(); ctx.arc(p.x, p.y, p.rad, 0, Math.PI*2); ctx.stroke();
        }
      }

      // ground
      for(const s of sueloScroll){
        if(IMG.suelo) ctx.drawImage(IMG.suelo, s.x, WORLD.h - GROUND_H, WORLD.w, GROUND_H);
      }

      // particles
      for(const p of particles){
        ctx.fillStyle = p.color + Math.max(0, p.life) + ")";
        ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
      }

      // player aura pulse
      const pulse = 0.6 + 0.2 * Math.sin(performance.now()/300);
      ctx.fillStyle = `rgba(255,255,255,${0.25 * pulse})`;
      ctx.beginPath(); ctx.arc(player.x, player.y, 60, 0, Math.PI*2); ctx.fill();

      // draw player sprite (state-based)
      let erizoImg = IMG.erizo.calmado;
      if(player.state === 'inhalando' && IMG.erizo.inhalando) erizoImg = IMG.erizo.inhalando;
      if(player.state === 'gritando' && IMG.erizo.gritando) erizoImg = IMG.erizo.gritando;
      // occasionally use parpadeo
      if(Math.random() < 0.003 && IMG.erizo.parpadeo) erizoImg = IMG.erizo.parpadeo;
      if(erizoImg) ctx.drawImage(erizoImg, player.x - player.r, player.y - player.r, player.r*2, player.r*2);
      else {
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(player.x, player.y, player.r, 0, Math.PI*2); ctx.fill();
      }

      // draw boss large if present
      if(bossInstance && IMG.boss.bossImg){
        const w = bossInstance.w; const h = bossInstance.h;
        // draw boss centered on instance.x,y
        ctx.drawImage(IMG.boss.bossImg, bossInstance.x - w/2, bossInstance.y - h/2, w, h);
      }

      // draw boss countdown top-left if in boss active
      if(inBossPhase && bossInstance && bossTimer > 0){
        const sec = Math.ceil(bossTimer);
        const img = IMG.boss.numbers[sec - 1] || null;
        if(img) ctx.drawImage(img, 18, 18, 64, 64);
        else {
          ctx.fillStyle = 'rgba(255,255,255,0.9)';
          ctx.font = '36px system-ui';
          ctx.fillText(sec, 28, 56);
        }
      }

      // draw bonus small countdown maybe?
      if(inBonusPhase){
        const sec = Math.ceil(bonusTimer);
        ctx.fillStyle = 'rgba(255,255,255,0.95)';
        ctx.font = '20px system-ui';
        ctx.fillText(sec, WORLD.w - 44, 36);
      }
    }

    // ============================
    // MAIN LOOP
    // ============================
    let lastFrame = performance.now();
    function loop(ts){
      const now = ts || performance.now();
      const dt = Math.min(0.033, (now - lastFrame) / 1000);
      lastFrame = now;
      update(dt);
      draw();
      if(!gameOver) requestAnimationFrame(loop);
      else {
        // stop game activity; show panel handled in update when collision occurs
      }
    }

    // ============================
    // HELPERS & MISC
    // ============================
    const CRASH_MESSAGES = [
      "El erizo se qued√≥ sin aire‚Ä¶ como tus plantas en agosto.",
      "Has gritado al vac√≠o. El vac√≠o grit√≥ de vuelta.",
      "Chocaste contra la iluminaci√≥n‚Ä¶ pero era un helado.",
      "Tu zen se fue por el paraguas roto.",
      "El universo respondi√≥ con un pl√°tano invisible.",
      "Erizo y obst√°culo se fundieron en un abrazo inc√≥modo.",
      "La serenidad se tropez√≥ contigo.",
      "Has visto la luz... y duele.",
      "Un pato de goma presenci√≥ tu derrota."
    ];

    function stopAllSfx(){
      // simple strategy: create silent audio and pause music. for SFX we rely on them being short.
      // There's no global SFX engine here; so this is a no-op beyond pausing music.
      for(let k in MUSIC){ try{ MUSIC[k].pause(); } catch(e){} }
    }

    function updateBestDisplays(){
      bestScoreEl.textContent = "Mejor: " + POINTS.best;
      menuBestEl.textContent = "Mejor puntuaci√≥n: " + POINTS.best;
    }

    // ============================
    // COUNTDOWN UI for start
    // ============================
    function showCountdown(onDone){
      // choose 3 random images + GO
      const pool = IMG.countdownImgs.slice();
      const seq = [];
      for(let i=0;i<3;i++){
        if(pool.length === 0) break;
        const idx = Math.floor(Math.random()*pool.length);
        seq.push(pool.splice(idx,1)[0]);
      }
      seq.push(IMG.countdownGo || null);
      let i = 0;
      countdownEl.classList.add('show');
      function step(){
        if(i < seq.length){
          const im = seq[i];
          countNum.innerHTML = im ? `<img src="${im.src}">` : `<div style="font-size:64px;font-weight:900">¬°YA!</div>`;
          playSfx('gong', 0.55);
          i++;
          setTimeout(step, 900);
        } else {
          countdownEl.classList.remove('show');
          if(typeof onDone === 'function') onDone();
        }
      }
      step();
    }

    // ============================
    // STARTUP: load assets and wire events
    // ============================
    // loader rotation
    function pickLoaderImage(){
      if(IMG.loaderImgs.length){
        const idx = Math.floor(Math.random() * IMG.loaderImgs.length);
        loaderImg.src = IMG.loaderImgs[idx].src;
      }
    }

    // start button wire
    btnStart.addEventListener('click', ()=>{
      menuPanel.classList.remove('show');
      showCountdown(()=> {
        // start game
        resetAll();
        lastFrame = performance.now();
        if(musicEnabled) playMusic(MUSIC.base);
        requestAnimationFrame(loop);
      });
    });

    // input bindings (also support keyboard for testing)
    window.addEventListener('keydown', (e)=>{
      if(e.key === ' ' || e.key === 'ArrowUp'){ isDown = true; }
      if(e.key === 'r' && panel.classList.contains('show')) { btnRestart.click(); }
    });
    window.addEventListener('keyup', (e)=>{ if(e.key === ' ' || e.key === 'ArrowUp'){ isDown = false; justReleased = true; } });

    // initial load
    loadAll().then(()=>{
      // hide loader after brief moment
      pickLoaderImage();
      setTimeout(()=>{ loader.style.display = 'none'; }, 880);

      // initial setup
      initClouds();
      currentBg = IMG.fondos.calc || null;
      // show menu best
      updateBestDisplays();
      // allow start to show
      // TEST MODE can auto-start if desired
      if(TEST_MODE){
        // auto-start with countdown to speed testing
        menuPanel.classList.remove('show');
        showCountdown(()=> {
          resetAll();
          lastFrame = performance.now();
          if(musicEnabled) playMusic(MUSIC.base);
          requestAnimationFrame(loop);
        });
      }
    }).catch((err)=>{
      console.error("Loadall error", err);
      loader.style.display = 'none';
      // allow manual start anyway
    });

    // small periodic cloud reposition update (runs continuously even if game paused)
    setInterval(()=>{
      for(const c of CLOUD.list){
        c.x -= (c.speed * 0.016);
        if(c.x + c.w < 0){ c.x = WORLD.w + rand(10,100); c.y = rand(50, WORLD.h/2); }
      }
    }, 60);

    // expose some debug for console if needed
    window.Astuto = {
      resetAll, startBossSequence, startBonusSequence, IMG, POINTS, TEST_MODE
    };

    // End IIFE
  })();
  </script>
</body>
</html>
