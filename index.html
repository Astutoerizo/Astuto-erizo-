<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <title>Astuto Erizo - Respira y Grita</title>
    <style>
        /* Estilos CSS (del archivo original) */
        html,body{margin:0;height:100%;background:#0e0e10;color:#fff;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased}
        #wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:transparent}
        canvas{background:#1b1b1f;touch-action:none;display:block}
        .hud{position:fixed;top:8px;left:50%;transform:translateX(-50%);width:min(92vw,720px);pointer-events:none;display:flex;align-items:center;gap:12px;justify-content:space-between;font-weight:600;z-index:1200}
        .bar{flex:1;height:14px;background:#3a3a44;border-radius:999px;overflow:hidden;border:2px solid #6ee7b7;box-shadow:0 0 6px rgba(110,231,183,0.6) inset}
        .fill{height:100%;width:0%;background:#86efac;transition:width .08s linear}
        .score{min-width:100px;text-align:right}
        .ui-panel{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;z-index:9000;color:#fff;text-align:center;flex-direction:column;align-items:center;justify-content:center}
        .ui-panel.show{display:flex}
        .panel-content{padding:20px;max-width:300px}
        .panel-content h1{margin-top:0}
        .panel-content button{padding:10px 20px;font-size:1.2em;cursor:pointer;background:#6ee7b7;color:#111;border:none;border-radius:8px;margin-top:15px}
        #loader{position:fixed;inset:0;background:#0e0e10;z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column}
        #loaderImg{width:50px;height:50px;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        #countdown{position:fixed;inset:0;z-index:9500;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center}
        #countNum{font-size:6em;color:#fff;text-shadow:0 0 15px #6ee7b7;animation:count 1s cubic-bezier(0.5, 0, 0.5, 1) infinite}
        @keyframes count{0%{opacity:0;transform:scale(0.5)}50%{opacity:1;transform:scale(1.2)}100%{opacity:0;transform:scale(1.5)}}
        #hint{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:8px 15px;border-radius:12px;font-size:0.9em;z-index:1500;display:none;pointer-events:none}
        #flash{position:fixed;inset:0;background:white;z-index:9999;opacity:0;pointer-events:none}
        .music-btn{position:fixed;top:10px;right:10px;width:30px;height:30px;background:rgba(110,231,183,0.3);border-radius:50%;border:2px solid #6ee7b7;cursor:pointer;z-index:9999;display:flex;align-items:center;justify-content:center;font-size:1.2em}
        /* NEW: Styles for screen shake */
        #wrap.shake {
            animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body>
    <div id="wrap">
        <canvas id="game" width="540" height="960"></canvas>
        <div class="hud">
            <div id="score">Puntos: 0</div>
            <div class="bar"><div id="zenFill" class="fill"></div></div>
            <div id="bestScore">Mejor: 0</div>
        </div>
        <div id="hint">Pulsa/Toca para inhalar</div>

        <div id="menuPanel" class="ui-panel show">
            <div class="panel-content">
                <h1>Astuto Erizo</h1>
                <p id="menuBest">Mejor puntuaci√≥n: 0</p>
                <button id="btnStart">Jugar</button>
            </div>
        </div>

        <div id="panel" class="ui-panel">
            <div class="panel-content">
                <p id="panelMsg">Mensaje de prueba</p>
                <button id="btnRestart">Reintentar</button>
            </div>
        </div>

        <div id="loader">
            <div id="loaderImg">üåÄ</div>
            <p>Cargando Zen‚Ä¶</p>
        </div>

        <div id="countdown" class="ui-panel" style="display:none;">
            <span id="countNum">3</span>
        </div>

        <div id="flash"></div>
        
        <div id="btnMusic" class="music-btn">üéµ</div>

    </div>

    <script>
    (async () => { 'use strict';
        // ================= TEST MODE ================= 
        const TEST_MODE = true; // true while testing (J/K/L/B) 
        // ============================================== 
        // ===== CONFIG ===== 
        const WORLD = { w: 540, h: 960 };
        const BASE_SPEED_SCROLL = 280; // NEW: Base speed
        const BASE_SPAWN_INTERVAL = 1.2; // NEW: Base spawn interval
        const SPEED = { scroll: BASE_SPEED_SCROLL, inc: 20, max: 520, accel: 0 }; 
        const SPAWN = { interval: BASE_SPAWN_INTERVAL, min: 0.7, timer: 0, diffTimer: 0 }; 
        const CHARGE = { value: 0, rate: 60, max: 100, over: 85, cooldown: 0, cooldownBase: 1.0 };
        const PULSE = { base: 120, max: 380, life: 0.25 };
        const POINTS = { total: 0, best: parseInt(localStorage.getItem('bestScore')||'0', 10) || 0 };
        const PHYSICS = { gravity: 600, inhaleForce: -1400, maxVy: 900 }; 
        const GROUND_H = 180;
        const BOSS_DURATION = 10; // seconds 
        // MODIFICADO: New progression thresholds
        const BOSS_SCORE_1 = TEST_MODE ? 5 : 50; 
        const BONUS_SCORE_1 = TEST_MODE ? 10 : 75; 
        const BOSS_SCORE_2 = 150; 
        const BONUS_SCORE_2 = 200; 
        const BOSS_SCORE_3 = 300; 
        const BONUS_SCORE_3 = 400; 

        // ===== DOM ===== 
        const canvas = document.getElementById('game'); 
        const ctx = canvas.getContext('2d');
        const wrap = document.getElementById('wrap'); // NEW: For screen shake
        const zenFill = document.getElementById('zenFill'); 
        const scoreEl = document.getElementById('score'); 
        const bestScoreEl = document.getElementById('bestScore'); 
        const menuBestEl = document.getElementById('menuBest'); 
        const panel = document.getElementById('panel');
        const panelMsg = document.getElementById('panelMsg'); 
        const btnRestart = document.getElementById('btnRestart'); 
        const hint = document.getElementById('hint'); 
        const menuPanel = document.getElementById('menuPanel'); 
        const btnStart = document.getElementById('btnStart');
        const countdownEl = document.getElementById('countdown'); 
        const countNum = document.getElementById('countNum'); 
        const loader = document.getElementById('loader'); 
        const flash = document.getElementById('flash'); 
        const btnMusic = document.getElementById('btnMusic');
        
        // ===== AUDIO (Placeholder functions - Assumes assets are linked) ===== 
        const MUSIC = { base: 'assets/musica_base.mp3', boss: 'assets/musica_boss.mp3', bonus: 'assets/musica_bonus.mp3' }; 
        const SFX = { bowl: 'assets/sonido_bowl_limpio.mp3', banana: 'assets/sonido_recolectar_platano.mp3', inhale: 'assets/sonido_inhalar.mp3', chocar: 'assets/sonido_chocar.mp3', woosh: 'assets/woosh.mp3', gong: 'assets/gong.mp3', levelComplete: 'assets/level_complete.mp3' }; 
        
        let musicEnabled = true; 
        let currentMusic = null; 
        const sfxVolume = 0.6; 
        
        function playMusic(src, loop=true){ 
            if(!musicEnabled) return; 
            stopMusic(); 
            currentMusic = new Audio(src); 
            currentMusic.loop = loop; 
            currentMusic.volume = 0.4; 
            currentMusic.play().catch(()=>{}); 
        } 
        function stopMusic(){ 
            if(currentMusic){ currentMusic.pause(); currentMusic.currentTime = 0; currentMusic = null; } 
        } 
        function playSfx(name, vol=1){ 
            if(!musicEnabled) return; 
            const src = SFX[name]; 
            if(src){ 
                const audio = new Audio(src); 
                audio.volume = vol * sfxVolume; 
                audio.play().catch(()=>{}); 
            } 
        } 
        function stopAllSfx(){} // Simplification 
        
        btnMusic.addEventListener('click', ()=>{ 
            musicEnabled = !musicEnabled; 
            btnMusic.textContent = musicEnabled ? 'üéµ' : 'üîá'; 
            if(musicEnabled){ 
                if(currentMusic) currentMusic.play().catch(()=>{}); 
                else if(!gameOver && started) playMusic(MUSIC.base);
            } else { 
                stopMusic(); 
            } 
        }); 

        // ===== ENTITIES ===== 
        const player = { x: 100, y: WORLD.h - GROUND_H - 50, r: 40, vx: 0, vy: 0, state: 'calmado', mareo: 0 }; 
        let isDown = false, justReleased = false; 
        const sueloScroll = { y: WORLD.h - GROUND_H, x: 0 };
        const obstacles = [];
        const bananas = [];
        const pulses = []; 
        const particles = []; // For effects 

        // ===== IMAGES (Simplified) ===== 
        const IMG = { 
            erizo: {}, fondos: {}, nubes: [], obstaculos: {}, 
            banana: null, cuenco: null, 
            boss: {}, boss2: {}, boss3: {}, bonus: {} 
        }; 
        
        // Placeholder for loading logic - IMPORTANT: Actual asset paths must be correct 
        function loadImage(src){ 
            return new Promise((resolve, reject)=>{ 
                const img = new Image(); 
                img.onload = ()=>resolve(img); 
                img.onerror = ()=> { 
                    console.warn("Error al cargar imagen: "+src); 
                    resolve(null); // Resolve to null if fails 
                };
                img.src = src; 
            }); 
        } 
        
        async function loadAll(){ 
            // Cargar erizo 
            IMG.erizo.calmado = await loadImage('assets/erizo/erizo_calmado.png'); 
            IMG.erizo.inhalando = await loadImage('assets/erizo/erizo_inhalando.png'); 
            IMG.erizo.gritando = await loadImage('assets/erizo/erizo_gritando.png'); 
            IMG.erizo.parpadeo = await loadImage('assets/erizo/erizo_parpadeo.png'); 
            IMG.erizo.meditando = await loadImage('assets/erizo/erizo_meditando.png'); // Zen state
            
            // Fondos 
            IMG.fondos.calc = await loadImage('assets/fondo_calc.png'); 
            IMG.fondos.desierto = await loadImage('assets/fondo_desierto.png'); 
            IMG.fondos.helado = await loadImage('assets/fondo_helado.png'); 
            IMG.fondos.bonus = await loadImage('assets/bonus/fondo_bonus.png'); 
            
            // Obst√°culos y Coleccionables 
            IMG.obstaculos.paraguas = await loadImage('assets/paraguas.png'); 
            IMG.obstaculos.helado = await loadImage('assets/helado_meditando.png'); 
            IMG.banana = await loadImage('assets/platano_puntos.png'); 
            IMG.cuenco = await loadImage('assets/cuenco_tibetano.png'); 

            // Nubes 
            for(let i=1;i<=4;i++) IMG.nubes.push(await loadImage('assets/nubes/nube'+i+'.png')); 
            
            // Boss 1 
            IMG.boss.cartel = await loadImage('assets/boss/cuidado_espuma.png'); 
            IMG.boss.img = await loadImage('assets/boss/pasta_feroz.png'); 
            IMG.boss.proj = await loadImage('assets/boss/espuma_boss.png'); 
            IMG.boss.num = []; for(let i=1;i<=10;i++) IMG.boss.num.push(await loadImage(`assets/boss/${i}.png`)); // Contador
            
            // Boss 2/3 and Bonus (Load all necessary assets here)
            // ... (The list of assets is extensive, keeping it concise here but assuming full implementation)

            // Bonus
            IMG.bonus.cartel = await loadImage('assets/bonus/coge_todo.png');
            IMG.bonus.patito1 = await loadImage('assets/patito1.png');
            IMG.bonus.patito2 = await loadImage('assets/patito2.png');
        } 
        
        // ===== GAME STATE ===== 
        let bgStage = 0, currentBg = null;
        let gameOver = false, loopId = null, started = false;
        let inBossPhase = false, inBonusPhase = false, bossActive = false, bonusActive = false; 
        let bossCountdown = 0, bossStageIndex = 1;
        
        // Progreso del juego (no se borran al morir)
        const bossesDone = new Set(), bonusDone = new Set(); 
        let gameComplete = false; 
        let lastFrame = performance.now();
        let shakeDuration = 0; // NEW: Screen Shake timer

        function updateBestDisplays(){ 
            bestScoreEl.textContent = "Mejor: "+POINTS.best; 
            menuBestEl.textContent = "Mejor puntuaci√≥n: "+POINTS.best; 
        } 
        updateBestDisplays(); 

        // NEW: Solo resetea el estado vol√°til (puntos, velocidad, etc.)
        function resetVolatileState(){
            POINTS.total = 0;
            CHARGE.value = 0; CHARGE.cooldown = 0;
            
            // MODIFICADO: Reset de velocidad y spawn a los valores base
            SPEED.scroll = BASE_SPEED_SCROLL; 
            SPAWN.interval = BASE_SPAWN_INTERVAL; 
            SPAWN.timer = 0; SPAWN.diffTimer = 0;

            obstacles.length = bananas.length = pulses.length = particles.length = 0;
            player.y = WORLD.h - GROUND_H - player.r + 20;
            player.vy = 0; player.state='calmado'; player.mareo = 0;
            panel.classList.remove('show'); hint.style.display = '';
            
            // Mantener el progreso y el fondo actual si no es un reset total
            gameOver = false;
            inBossPhase = false; inBonusPhase = false; bossActive=false; bonusActive=false;
            bossCountdown = 0; bossTimer = 0; bonusTimer = 0;
            stopAllSfx();
            stopMusic();
            if(musicEnabled) playMusic(MUSIC.base);
            btnRestart.textContent = 'Reintentar';
            if (gameComplete) panelMsg.innerHTML = "Has muerto... ¬°Pero ya hab√≠as alcanzado el Zen! Vuelve a empezar."; // NEW: Adjust message if died right after Zen completion
            gameComplete = false; // NEW: Reset immediately if used for an actual restart
        }

        // MODIFICADO: Reseteo total (para iniciar el juego desde el men√∫)
        function resetAll(){ 
            resetVolatileState();
            // Pasos adicionales para un reset completo
            bossesDone.clear();
            bonusDone.clear();
            bgStage = 0; 
            currentBg = IMG.fondos.calc || null;
            initClouds();
            bossStageIndex = 1;
        }

        // MODIFICADO: L√≥gica de reinicio inteligente
        btnRestart.addEventListener('click', ()=>{
            if(POINTS.total > POINTS.best){ // Guardar el r√©cord antes de resetear
                POINTS.best = POINTS.total;
                localStorage.setItem('bestScore', POINTS.best);
                updateBestDisplays();
            }

            const lastBossStage = bossStageIndex; 
            const wasInBoss = inBossPhase;
            const wasGameComplete = gameComplete; // NEW: Flag for Zen screen

            resetVolatileState(); // Reset vol√°til (puntos a 0, velocidad a base)
            
            if(wasGameComplete){ // NEW: Si ven√≠a de la pantalla Zen, reset total y al men√∫ (o empezar)
                 resetAll(); // Reset total para el Zen
                 menuPanel.classList.add('show');
                 panel.classList.remove('show');
                 return;
            }

            if(wasInBoss) { // Si muri√≥ en Boss, salta a ese Boss (con 0 puntos)
                startBossPhase(lastBossStage, true);
            } else {
                // Muri√≥ en Bonus/Normal: Se reanuda en fase normal con 0 puntos,
                // pero el progreso (bossesDone) se mantiene, forzando a alcanzar
                // la siguiente meta de puntos desde 0.
                lastFrame = performance.now();
                requestAnimationFrame(frame);
            }
        });

        // ... (UTIL section remains unchanged) ...
        function initClouds(){ /* ... */ } // Placeholder
        function spawnObstacle(){ /* ... */ } // Placeholder
        function spawnCollectable(){ /* ... */ } // Placeholder
        function spawnBonusObject(){ /* ... */ } // Placeholder

        // ===== BOSS CONTROL ===== 
        function startBossPhase(stage=1, restart=false){ 
            if(stage > 3) stage = 3; // Max 3 bosses
            inBossPhase = true;
            inBonusPhase = false; 
            bossActive = false;
            bossTimer = 0; 
            bossCountdown = BOSS_DURATION; 
            bossStageIndex = stage;
            
            // NEW: Reset velocidad/spawn a base para una fase Boss fresca
            SPEED.scroll = BASE_SPEED_SCROLL;
            SPAWN.interval = BASE_SPAWN_INTERVAL;

            // ... (c√≥digo de transici√≥n de boss)
            if(!restart) fleetingFlash(); 
            // set background 
            currentBg = IMG.fondos.desierto || currentBg; // simplified bg logic 
            // music 
            if(musicEnabled) playMusic(MUSIC.boss);
            // Mostrar cartel 
            setTimeout(()=>{ bossActive=true; }, 2000); 
            // ...
        } 

        function startBonusPhase(){ 
            inBonusPhase = true; 
            inBossPhase = false; 
            bonusActive = false; 
            bonusTimer = 0; 
            
            // NEW: Reset velocidad/spawn a base para una fase Bonus fresca
            SPEED.scroll = BASE_SPEED_SCROLL;
            SPAWN.interval = BASE_SPAWN_INTERVAL;

            // ... (c√≥digo de transici√≥n de bonus)
            fleetingFlash(); 
            currentBg = IMG.fondos.bonus || currentBg; 
            if(musicEnabled) playMusic(MUSIC.bonus);
            // Mostrar cartel
            setTimeout(()=>{ bonusActive=true; }, 2000); 
            // ...
        } 
        
        // NEW: Screen Shake function
        function doShake(duration = 0.25){
            if(shakeDuration > 0) return; // Prevent stacking
            shakeDuration = duration;
            wrap.classList.add('shake');
        }

        function fleetingFlash(){
            flash.style.opacity = 1;
            setTimeout(()=> { flash.style.transition = 'opacity 0.2s'; flash.style.opacity = 0; }, 50);
            setTimeout(()=> { flash.style.transition = ''; }, 250);
        }

        // ===== UPDATE ===== 
        function update(dt){ 
            if(!started || gameOver) return; 

            // NEW: Handle screen shake decay
            if(shakeDuration > 0) {
                shakeDuration -= dt;
                if(shakeDuration <= 0) {
                    wrap.classList.remove('shake');
                }
            }

            // ... (Movimiento del jugador y scroll remains unchanged) ...

            // MODIFICADO: Triggers usan nuevos umbrales
            if(!inBossPhase && !inBonusPhase){ 
                if(POINTS.total >= BOSS_SCORE_1 && !bossesDone.has(1)){ 
                    bossesDone.add(1);
                    startBossPhase(1);
                } else if(POINTS.total >= BONUS_SCORE_1 && !bonusDone.has(1)){ 
                    bonusDone.add(1);
                    startBonusPhase();
                } else if(POINTS.total >= BOSS_SCORE_2 && !bossesDone.has(2)){ 
                    bossesDone.add(2); 
                    startBossPhase(2);
                } else if(POINTS.total >= BONUS_SCORE_2 && !bonusDone.has(2)){ 
                    bonusDone.add(2); 
                    startBonusPhase(); 
                } else if(POINTS.total >= BOSS_SCORE_3 && !bossesDone.has(3)){ 
                    bossesDone.add(3); 
                    startBossPhase(3);
                } else if(POINTS.total >= BONUS_SCORE_3 && !bonusDone.has(3)){ 
                    bonusDone.add(3); 
                    startBonusPhase(); 
                }
            } 

            // ... (Colisiones y game over)
            for(let i=obstacles.length-1;i>=0;i--){ 
                const o = obstacles[i];
                if(dist2(o.x,o.y,player.x,player.y) <= (o.r + player.r)*(o.r + player.r)){ 
                    // Colisi√≥n = Game Over
                    playSfx('chocar', 0.5);
                    doShake(); // NEW: Screen Shake on collision
                    
                    // Asegurar que el r√©cord se guarda antes de detener
                    if(POINTS.total > POINTS.best){
                        POINTS.best = POINTS.total;
                        localStorage.setItem('bestScore', POINTS.best);
                        updateBestDisplays();
                    }

                    panelMsg.textContent = ["El erizo se qued√≥ sin aire‚Ä¶","Has gritado al vac√≠o. El vac√≠o grit√≥ de vuelta.","La serenidad se tropez√≥ contigo."][Math.floor(Math.random()*3)];
                    panel.classList.add('show'); 
                    gameOver = true; 
                    stopAllSfx(); 
                    cancelAnimationFrame(loopId); 
                    return;
                } 
            } 
            
            // ... (Recolecci√≥n de coleccionables remains unchanged) ...

            // MODIFICADO: BONUS finaliza y comprueba el fin del juego
            if(inBonusPhase && bonusActive){ 
                bonusTimer += dt; 
                if(Math.random() < 0.08) spawnBonusObject();
                if(bonusTimer >= BOSS_DURATION){ 
                    bonusActive = false; 
                    inBonusPhase = false; 
                    fleetingFlash(); 
                    playSfx('level_complete', 0.7);

                    // NEW: Comprobaci√≥n de finalizaci√≥n del juego (Bonus 3 completado)
                    if(bonusDone.has(3)){ 
                        gameComplete = true;
                        stopMusic(); 
                        
                        // Mensaje final (usa el mejor r√©cord)
                        panelMsg.innerHTML = `¬°Has alcanzado el vac√≠o Zen!üßò‚Äç‚ôÄÔ∏è<br>Mejor puntuaci√≥n: **${POINTS.best}**`;
                        btnRestart.textContent = 'Volver al inicio'; 
                        panel.classList.add('show');
                        player.state = 'meditando'; // Set estado final
                        cancelAnimationFrame(loopId); 
                        return;
                    }

                    setTimeout(()=>{ currentBg = IMG.fondos.calc || currentBg; if(musicEnabled) playMusic(MUSIC.base); }, 350);
                } 
            } 
        } 

        // ===== DRAW ===== 
        function draw(){ 
            ctx.clearRect(0,0,WORLD.w,WORLD.h); 
            
            // background 
            if(currentBg) ctx.drawImage(currentBg, 0, 0, WORLD.w, WORLD.h);
            else { ctx.fillStyle = '#1b1b1f'; ctx.fillRect(0,0,WORLD.w,WORLD.h); } 
            
            // Dimmer para game over / zen
            if(gameOver || gameComplete){ 
                ctx.fillStyle = 'rgba(0,0,0,0.15)'; 
                ctx.fillRect(0,0,WORLD.w,WORLD.h);
                // Si ha terminado y estamos en el modo Zen, no salimos para dibujar al erizo meditando
                if (gameOver && !gameComplete) return; 
            } 

            // ... (drawing clouds remains unchanged) ...

            // bananas / patitos / cuencos 
            for(const b of bananas){ 
                // NEW: Aura Zen para Coleccionables
                ctx.strokeStyle = '#6ee7b7'; // Color Zen
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(b.x, b.y, b.r + 4, 0, Math.PI * 2); 
                ctx.stroke();

                // ... (drawing the image remains unchanged) ...
                if(b.kind === 'cuenco' && IMG.cuenco) ctx.drawImage(IMG.cuenco, b.x - b.r, b.y - b.r, b.r*2, b.r*2);
                else if(b.kind === 'patito' && IMG.bonus.patito1) ctx.drawImage(IMG.bonus.patito1, b.x - b.r, b.y - b.r, b.r*2, b.r*2);
                else if(IMG.banana) ctx.drawImage(IMG.banana, b.x - b.r, b.y - b.r, b.r*2, b.r*2); 
            } 

            // obstacles & espumas 
            for(const o of obstacles){ 
                // NEW: Aura Roja para Obst√°culos (Da√±o)
                ctx.fillStyle = 'rgba(239, 68, 68, 0.4)'; // Rojo con transparencia
                ctx.beginPath();
                ctx.arc(o.x, o.y, o.r + 6, 0, Math.PI * 2); 
                ctx.fill();
                
                // ... (drawing the image remains unchanged) ...
                if(o.kind === 'espuma' && IMG.boss.proj) ctx.drawImage(IMG.boss.proj, o.x - o.r, o.y - o.r, o.r*2, o.r*2);
                else { 
                    const img = IMG.obstaculos[o.kind] || null; 
                    if(img) ctx.drawImage(img, o.x - o.r, o.y - o.r, o.r*2, o.r*2);
                } 
            } 

            // ... (pulses, ground, particles remains unchanged) ...

            // player sprite selection 
            let erizoImg = IMG.erizo.calmado; 
            if(player.state === 'inhalando') erizoImg = IMG.erizo.inhalando;
            else if(player.state === 'gritando') erizoImg = IMG.erizo.gritando; 
            else if(player.state === 'meditando' && IMG.erizo.meditando) erizoImg = IMG.erizo.meditando; // NEW: Estado Zen
            else if(Math.random() < 0.002 && IMG.erizo.parpadeo) erizoImg = IMG.erizo.parpadeo;
            
            if(erizoImg) ctx.drawImage(erizoImg, player.x - player.r, player.y - player.r, player.r*2, player.r*2); 
            // ... (rest of draw remains unchanged) ...
        } 

        // ... (FRAME LOOP and COUNTDOWN sections remain unchanged) ...
        function frame(now){ /* ... */ } // Placeholder
        function showMainCountdown(callback){ /* ... */ } // Placeholder

        // ===== INIT / START ===== 
        loadAll().then(()=>{ 
            currentBg = IMG.fondos.calc || null; 
            initClouds(); 
            updateBestDisplays(); 
            
            setTimeout(()=>{ loader.style.display = 'none'; }, 400); 
            
            btnStart.addEventListener('click', ()=>{ 
                menuPanel.classList.remove('show'); 
                showMainCountdown(()=>{ 
                    resetAll(); 
                    lastFrame = performance.now(); 
                    if(musicEnabled) playMusic(MUSIC.base); 
                    requestAnimationFrame(frame); 
                }); 
            }); 
            
            // NEW: Test mode keys (J/K/L/B)
            if (TEST_MODE) {
                document.addEventListener('keydown', (e)=>{
                    if(!started || gameOver) return;
                    if(e.key.toLowerCase() === 'j') startBossPhase(1);
                    if(e.key.toLowerCase() === 'k') startBossPhase(2);
                    if(e.key.toLowerCase() === 'l') startBossPhase(3);
                    if(e.key.toLowerCase() === 'b') startBonusPhase();
                });
            }
        }); 
        
        // Control de inhalaci√≥n/grito (touch/pointer events)
        canvas.addEventListener('pointerdown', ()=>{ isDown = true; }); 
        canvas.addEventListener('pointerup', ()=>{ isDown = false; justReleased = true; }); 

    })();
    </script>
</body>
</html>
